<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="STEAM Lab Pro - Interactive educational platform for Science, Technology, Engineering, Arts, and Mathematics learning with PhET simulations, AI tutoring, and comprehensive tools.">
  <meta name="keywords"
    content="STEAM education, interactive learning, PhET simulations, educational platform, science, technology, engineering, arts, mathematics">
  <meta name="author" content="STEAM Lab Pro">

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="STEAM Lab Pro - Ultimate Interactive Learning Platform">
  <meta property="og:description"
    content="Dive into interactive experiments, solve complex problems, get instant AI help, and track your learning journey.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/assets/steam-lab-preview.jpg">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚀</text></svg>">

  <title>STEAM Lab Pro - The Ultimate Interactive Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            primary: '#5D5CDE',
            secondary: '#1E40AF',
            accent: '#059669',
            success: '#10B981',
            warning: '#F59E0B',
            error: '#EF4444',
            science: '#3B82F6',
            technology: '#8B5CF6',
            engineering: '#6B7280',
            arts: '#EC4899',
            mathematics: '#10B981',
          },
          animation: {
            'bounce-slow': 'bounce 2s infinite',
            'pulse-fast': 'pulse 1s infinite',
            'spin-slow': 'spin 3s linear infinite',
            'wiggle': 'wiggle 1s ease-in-out infinite',
            'fade-in': 'fadeIn 0.6s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'scale-in': 'scaleIn 0.3s ease-out',
          },
          keyframes: {
            wiggle: {
              '0%, 100%': { transform: 'rotate(-3deg)' },
              '50%': { transform: 'rotate(3deg)' },
            },
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            scaleIn: {
              '0%': { opacity: '0', transform: 'scale(0.95)' },
              '100%': { opacity: '1', transform: 'scale(1)' },
            }
          },
          backdropBlur: {
            'xs': '2px',
          }
        }
      }
    }
  </script>

  <!-- Custom CSS for enhanced styling -->
  <style>
    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #5D5CDE, #1E40AF);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, #4C4BCD, #1D3A9F);
    }

    /* Loading animation */
    .loading-spinner {
      border: 3px solid rgba(93, 92, 222, 0.3);
      border-radius: 50%;
      border-top: 3px solid #5D5CDE;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    /* Enhanced hover effects */
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    /* Glassmorphism effect */
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Dark mode glass */
    .dark .glass {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Simulation highlighting */
    .simulation-highlight {
      animation: pulse-highlight 2s ease-in-out;
      transition: all 0.3s ease;
    }

    @keyframes pulse-highlight {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.02);
      }
    }

    /* Quick action button states */
    .quick-action-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none !important;
    }

    .quick-action-btn:disabled:hover {
      transform: none !important;
      scale: 1 !important;
    }
  </style>
</head>

<body
  class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-blue-900 dark:to-purple-900 text-gray-800 dark:text-white min-h-screen">

  <!-- NAVIGATION -->
  <nav
    class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg shadow-xl border-b border-gray-200/50 dark:border-gray-700/50 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">

        <!-- Logo + Title -->
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center animate-bounce-slow">
            <i class="fas fa-atom text-white text-lg"></i>
          </div>
          <div class="flex flex-col leading-tight">
            <h1
              class="text-lg font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent whitespace-nowrap">
              STEAM Lab Pro
            </h1>
            <p class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
              🚀 Ultimate Interactive Platform
            </p>
          </div>
        </div>
        <!-- Mobile menu button -->
        <div class="lg:hidden">
          <button onclick="toggleMobileMenu()"
            class="p-2 rounded-lg bg-white/50 dark:bg-gray-700/50 hover:bg-white dark:hover:bg-gray-600 transition-all backdrop-blur-sm">
            <i class="fas fa-bars text-gray-600 dark:text-gray-400"></i>
          </button>
        </div>

        <div class="flex items-center space-x-4">
          <!-- Desktop Navigation -->
          <div
            class="hidden lg:flex items-center space-x-1 bg-white/50 dark:bg-gray-700/50 rounded-xl p-1 backdrop-blur-sm">
            <button onclick="showSection('dashboard')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 bg-primary text-white hover-lift"
              data-section="dashboard">
              <i class="fas fa-home mr-2"></i>Dashboard
            </button>
            <button onclick="showSection('labs')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="labs">
              <i class="fas fa-flask mr-2"></i>Experiments
            </button>
            <button onclick="showSection('assignments')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="assignments">
              <i class="fas fa-tasks mr-2"></i>Tasks
            </button>
            <button onclick="showSection('notes')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="notes">
              <i class="fas fa-sticky-note mr-2"></i>Notes
            </button>
            <button onclick="showSection('calendar')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="calendar">
              <i class="fas fa-calendar mr-2"></i>Calendar
            </button>
            <button onclick="showSection('calculator')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="calculator">
              <i class="fas fa-calculator mr-2"></i>Calculator
            </button>
            <button onclick="showSection('data')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="data">
              <i class="fas fa-chart-bar mr-2"></i>Data
            </button>
            <button onclick="showSection('resources')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="resources">
              <i class="fas fa-book mr-2"></i>Resources
            </button>
            <button onclick="showSection('gradebook')"
              class="nav-btn px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 text-gray-600 dark:text-gray-400 hover-lift"
              data-section="gradebook">
              <i class="fas fa-chart-line mr-2"></i>Inventory
            </button>
          </div>

          <div class="flex items-center space-x-3">
            <div id="currentDateTime"
              class="text-sm text-gray-600 dark:text-gray-400 bg-white/50 dark:bg-gray-700/50 px-3 py-1 rounded-lg backdrop-blur-sm">
            </div>

            <div
              class="flex items-center space-x-2 text-sm bg-white/50 dark:bg-gray-700/50 px-3 py-1 rounded-lg backdrop-blur-sm">
              <span>🏆 Score:</span>
              <span id="userScore" class="font-bold text-primary animate-pulse">0</span>
            </div>

            <button onclick="saveProgress()"
              class="bg-success hover:bg-success/90 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 transform">
              <i class="fas fa-save mr-1"></i>Save
            </button>

            <button onclick="toggleTheme()"
              class="p-2 rounded-lg bg-white/50 dark:bg-gray-700/50 hover:bg-white dark:hover:bg-gray-600 transition-all hover:scale-110 transform backdrop-blur-sm hover-lift"
              title="Toggle theme (Ctrl+T)" id="themeToggle">
              <i class="fas fa-moon text-gray-600 dark:text-gray-400 transition-colors"></i>
              <i class="fas fa-sun text-yellow-500 hidden transition-colors"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Mobile Navigation Menu -->
  <div id="mobileMenu" class="lg:hidden fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
    <div
      class="fixed top-0 right-0 h-full w-80 bg-white/95 dark:bg-gray-800/95 backdrop-blur-lg shadow-2xl transform transition-transform duration-300 translate-x-full"
      id="mobileMenuPanel">
      <div class="p-6">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Navigation</h2>
          <button onclick="toggleMobileMenu()"
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
            <i class="fas fa-times text-gray-600 dark:text-gray-400"></i>
          </button>
        </div>

        <nav class="space-y-2">
          <button onclick="showSection('dashboard'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-primary text-white font-medium transition-all hover:scale-105 transform shadow-lg"
            data-section="dashboard">
            <i class="fas fa-home mr-3"></i>Dashboard
          </button>
          <button onclick="showSection('labs'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="labs">
            <i class="fas fa-flask mr-3"></i>Experiments
          </button>
          <button onclick="showSection('assignments'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="assignments">
            <i class="fas fa-tasks mr-3"></i>Tasks
          </button>
          <button onclick="showSection('notes'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="notes">
            <i class="fas fa-sticky-note mr-3"></i>Notes
          </button>
          <button onclick="showSection('calendar'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="calendar">
            <i class="fas fa-calendar mr-3"></i>Calendar
          </button>
          <button onclick="showSection('calculator'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="calculator">
            <i class="fas fa-calculator mr-3"></i>Calculator
          </button>
          <button onclick="showSection('data'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="data">
            <i class="fas fa-chart-bar mr-3"></i>Data
          </button>
          <button onclick="showSection('resources'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="resources">
            <i class="fas fa-book mr-3"></i>Resources
          </button>
          <button onclick="showSection('gradebook'); toggleMobileMenu()"
            class="mobile-nav-btn w-full text-left p-4 rounded-xl bg-white/50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 font-medium transition-all hover:scale-105 transform hover:bg-white dark:hover:bg-gray-700"
            data-section="gradebook">
            <i class="fas fa-chart-line mr-3"></i>Inventory
          </button>
        </nav>
      </div>
    </div>
  </div>

  <!-- Optimized Loading Screen -->
  <div id="loadingScreen"
    class="fixed inset-0 z-50 bg-gradient-to-br from-primary via-purple-600 to-pink-600 flex items-center justify-center">
    <div class="text-center text-white max-w-sm mx-auto px-6">

      <!-- Simple Logo -->
      <div class="mb-6">
        <div class="w-16 h-16 mx-auto relative">
          <div class="absolute inset-0 border-3 border-white/40 border-t-white rounded-full animate-spin"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <i class="fas fa-atom text-xl text-white"></i>
          </div>
        </div>
      </div>

      <!-- Title -->
      <div class="mb-6">
        <h1 class="text-2xl font-bold mb-1 text-white">STEAM Lab Pro</h1>
        <p class="text-white/70 text-sm">Ultimate Interactive Platform</p>
      </div>

      <!-- Progress -->
      <div class="mb-4">
        <div id="loadingStep" class="text-white/80 text-xs mb-2 h-4">Loading...</div>
        <div class="w-full bg-white/20 rounded-full h-1">
          <div id="loadingProgress" class="bg-white h-full rounded-full transition-all duration-300" style="width: 0%">
          </div>
        </div>
        <div id="loadingPercentage" class="text-white/60 text-xs mt-1">0%</div>
      </div>

      <!-- Simple dots -->
      <div class="flex justify-center space-x-1">
        <div class="w-1.5 h-1.5 bg-white/60 rounded-full animate-pulse"></div>
        <div class="w-1.5 h-1.5 bg-white/60 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
        <div class="w-1.5 h-1.5 bg-white/60 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->

  <div class="max-w-7xl mx-auto p-4 space-y-6 pb-20">

    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="section-content">
      <!-- Hero Section -->
      <div
        class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 rounded-3xl p-8 text-white mb-8 relative overflow-hidden">
        <div class="absolute inset-0">
          <div class="absolute top-10 left-10 w-20 h-20 bg-white/10 rounded-full animate-bounce-slow"></div>
          <div class="absolute top-20 right-20 w-16 h-16 bg-white/10 rounded-full animate-pulse"></div>
          <div class="absolute bottom-10 left-1/3 w-12 h-12 bg-white/10 rounded-full animate-bounce"></div>
        </div>

        <div class="relative z-10">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
            <div>
              <h2 class="text-5xl font-bold mb-6 animate-fade-in">🚀 Welcome to Your Advanced STEAM Universe!</h2>
              <p class="text-xl mb-8 text-white/90">Dive into interactive experiments, solve complex problems, get
                instant AI help, and track your learning journey like never before!</p>
              <div class="flex flex-wrap gap-4">
                <button onclick="showSection('labs')"
                  class="bg-white text-blue-600 px-8 py-4 rounded-2xl font-bold hover:bg-gray-100 transition-all hover:scale-105 transform shadow-lg">
                  <i class="fas fa-rocket mr-2"></i>Launch Experiments
                </button>
                <button onclick="openAI()"
                  class="bg-white/20 backdrop-blur-sm text-white px-8 py-4 rounded-2xl font-bold hover:bg-white/30 transition-all hover:scale-105 transform shadow-lg">
                  <i class="fas fa-brain mr-2"></i>Ask AI Tutor
                </button>
                <button onclick="showSection('assignments')"
                  class="bg-white/20 backdrop-blur-sm text-white px-8 py-4 rounded-2xl font-bold hover:bg-white/30 transition-all hover:scale-105 transform shadow-lg">
                  <i class="fas fa-tasks mr-2"></i>My Tasks
                </button>
              </div>
            </div>
            <div class="flex justify-center">
              <div class="relative">
                <div
                  class="w-72 h-72 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center animate-spin-slow">
                  <div class="w-48 h-48 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="fas fa-atom text-8xl text-white/80 animate-pulse"></i>
                  </div>
                </div>
                <div
                  class="absolute -top-6 -right-6 w-20 h-20 bg-yellow-400 rounded-full flex items-center justify-center animate-bounce">
                  <i class="fas fa-lightbulb text-yellow-800 text-2xl"></i>
                </div>
                <div
                  class="absolute -bottom-6 -left-6 w-16 h-16 bg-green-400 rounded-full flex items-center justify-center animate-wiggle">
                  <i class="fas fa-flask text-green-800 text-xl"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Achievement Badges -->
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-trophy text-white"></i>
          </div>
          <p class="text-xs font-bold">🏆 Achiever</p>
          <p class="text-2xl font-bold text-primary" id="achievements">0</p>
        </div>

        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-flask text-white"></i>
          </div>
          <p class="text-xs font-bold">🧪 Experiments</p>
          <p class="text-2xl font-bold text-science" id="experimentsCompleted">0</p>
        </div>

        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-red-400 to-pink-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-tasks text-white"></i>
          </div>
          <p class="text-xs font-bold">📋 Tasks Done</p>
          <p class="text-2xl font-bold text-error" id="tasksCompleted">0</p>
        </div>

        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-green-400 to-teal-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-brain text-white"></i>
          </div>
          <p class="text-xs font-bold">🧠 AI Chats</p>
          <p class="text-2xl font-bold text-success" id="aiInteractions">0</p>
        </div>

        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-indigo-400 to-blue-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-fire text-white"></i>
          </div>
          <p class="text-xs font-bold">🔥 Streak</p>
          <p class="text-2xl font-bold text-technology" id="studyStreak">0</p>
        </div>

        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl text-center transform hover:scale-105 transition-all shadow-lg border border-white/20">
          <div
            class="w-12 h-12 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full mx-auto mb-2 flex items-center justify-center">
            <i class="fas fa-level-up-alt text-white"></i>
          </div>
          <p class="text-xs font-bold">📈 Level</p>
          <p class="text-2xl font-bold text-arts" id="userLevel">1</p>
        </div>
      </div>

      <!-- Interactive Dashboard -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Quick Actions -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <h3 class="text-xl font-bold mb-6 flex items-center">
            <span class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-bolt text-white text-sm"></i>
            </span>
            ⚡ Quick Actions
          </h3>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="quickLaunchLab('chemistry')"
              class="quick-action-btn p-4 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl hover:from-blue-500 hover:to-blue-700 transition-all hover:scale-105 transform shadow-lg hover-lift">
              <i class="fas fa-vial text-xl mb-2"></i>
              <p class="text-sm font-bold">Chemistry Lab</p>
            </button>
            <button onclick="quickLaunchLab('physics')"
              class="quick-action-btn p-4 bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-xl hover:from-purple-500 hover:to-purple-700 transition-all hover:scale-105 transform shadow-lg hover-lift">
              <i class="fas fa-atom text-xl mb-2"></i>
              <p class="text-sm font-bold">Physics Sim</p>
            </button>
            <button onclick="quickLaunchCalculator()"
              class="quick-action-btn p-4 bg-gradient-to-r from-green-400 to-green-600 text-white rounded-xl hover:from-green-500 hover:to-green-700 transition-all hover:scale-105 transform shadow-lg hover-lift">
              <i class="fas fa-calculator text-xl mb-2"></i>
              <p class="text-sm font-bold">Math Tools</p>
            </button>
            <button onclick="openAI()"
              class="quick-action-btn p-4 bg-gradient-to-r from-pink-400 to-pink-600 text-white rounded-xl hover:from-pink-500 hover:to-pink-700 transition-all hover:scale-105 transform shadow-lg hover-lift">
              <i class="fas fa-robot text-xl mb-2"></i>
              <p class="text-sm font-bold">AI Helper</p>
            </button>
          </div>
        </div>

        <!-- Recent Activity Feed -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <h3 class="text-xl font-bold mb-6 flex items-center">
            <span class="w-8 h-8 bg-success rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-history text-white text-sm"></i>
            </span>
            📊 Recent Activity
          </h3>
          <div id="activityFeed" class="space-y-3 max-h-64 overflow-y-auto">
            <div class="text-gray-500 text-sm text-center py-4">
              Start experimenting to see your activity!
            </div>
          </div>
        </div>

        <!-- Progress Visualization -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <h3 class="text-xl font-bold mb-6 flex items-center">
            <span class="w-8 h-8 bg-warning rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-chart-pie text-white text-sm"></i>
            </span>
            📈 Learning Progress
          </h3>
          <div class="h-48">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPERIMENTS/LABS SECTION -->
    <section id="labs" class="section-content hidden">
      <!-- PHET Games Page -->
      <div class="p-6">
        <!-- Header -->
        <div class="mb-8 text-center">
          <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🎮
            PhET Interactive Games</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Explore fun, interactive STEM simulations powered by <span
              class="font-semibold">PhET</span>.</p>
        </div>

        <!-- Games Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

          <!-- Circuit Construction Kit -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">🔋 Circuit Construction Kit: DC</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Build simple circuits and test how electricity
                flows.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe
                  src="https://phet.colorado.edu/sims/html/circuit-construction-kit-dc/latest/circuit-construction-kit-dc_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/circuit-construction-kit-dc/latest/circuit-construction-kit-dc_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

          <!-- Forces and Motion -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">⚖️ Forces & Motion: Basics</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Experiment with motion, friction, and applied
                forces.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe
                  src="https://phet.colorado.edu/sims/html/forces-and-motion-basics/latest/forces-and-motion-basics_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/forces-and-motion-basics/latest/forces-and-motion-basics_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

          <!-- Energy Skate Park -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">🎢 Energy Skate Park</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Explore kinetic and potential energy with
                skateboarding.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe src="https://phet.colorado.edu/sims/html/energy-skate-park/latest/energy-skate-park_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/energy-skate-park/latest/energy-skate-park_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

          <!-- Projectile Motion -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">🏹 Projectile Motion</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Adjust angle, velocity, and gravity to test
                trajectories.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe src="https://phet.colorado.edu/sims/html/projectile-motion/latest/projectile-motion_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/projectile-motion/latest/projectile-motion_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

          <!-- States of Matter -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">🌡️ States of Matter</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Visualize molecules in solid, liquid, and gas
                states.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe src="https://phet.colorado.edu/sims/html/states-of-matter/latest/states-of-matter_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/states-of-matter/latest/states-of-matter_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

          <!-- Wave on a String -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
            <div class="p-4">
              <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">🌊 Wave on a String</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Experiment with tension, damping, and wave
                frequencies.</p>
              <div class="aspect-w-16 aspect-h-9">
                <iframe src="https://phet.colorado.edu/sims/html/wave-on-a-string/latest/wave-on-a-string_en.html"
                  class="w-full h-64 rounded-lg border border-gray-300 dark:border-gray-600"></iframe>
              </div>
              <a href="https://phet.colorado.edu/sims/html/wave-on-a-string/latest/wave-on-a-string_en.html"
                target="_blank"
                class="mt-3 inline-block px-3 py-1 text-xs font-semibold text-white bg-gradient-to-r from-primary to-secondary rounded-lg shadow hover:opacity-90">⛶
                Fullscreen</a>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ASSIGNMENTS SECTION -->
    <section id="assignments" class="section-content hidden">
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2
              class="text-3xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
              📋 Smart Assignment Manager</h2>
            <p class="text-gray-600 dark:text-gray-400">Track, organize, and complete your academic tasks</p>
          </div>
          <div class="flex items-center space-x-3">
            <select id="assignmentFilter"
              class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-base">
              <option value="all">All Assignments</option>
              <option value="pending">Pending</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="overdue">Overdue</option>
            </select>
            <button onclick="createAssignment()"
              class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-6 py-2 rounded-lg font-medium transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-plus mr-2"></i>Add reminder for assisgments
            </button>
          </div>
        </div>
      </div>

      <!-- Assignment Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gradient-to-r from-red-400 to-red-600 p-6 rounded-2xl text-white shadow-lg">
          <div class="flex items-center space-x-3">
            <i class="fas fa-exclamation-triangle text-2xl"></i>
            <div>
              <p class="font-semibold">Overdue</p>
              <p class="text-3xl font-bold" id="overdueCount">0</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 p-6 rounded-2xl text-white shadow-lg">
          <div class="flex items-center space-x-3">
            <i class="fas fa-clock text-2xl"></i>
            <div>
              <p class="font-semibold">Due Soon</p>
              <p class="text-3xl font-bold" id="dueSoonCount">0</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-blue-400 to-blue-600 p-6 rounded-2xl text-white shadow-lg">
          <div class="flex items-center space-x-3">
            <i class="fas fa-play text-2xl"></i>
            <div>
              <p class="font-semibold">In Progress</p>
              <p class="text-3xl font-bold" id="inProgressCount">0</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-green-400 to-green-600 p-6 rounded-2xl text-white shadow-lg">
          <div class="flex items-center space-x-3">
            <i class="fas fa-check text-2xl"></i>
            <div>
              <p class="font-semibold">Completed</p>
              <p class="text-3xl font-bold" id="completedCount">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Assignments List -->
      <div class="assignments-section">
        <h2>📂 Assignments</h2>
        <iframe
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRXglfVcHRbcyZkbsxsZ6souKwSdrV6Wi3DXeBgO1bptxZ9sA49iqHOLrm20pGD0ljRh4dDsMCKCTan/pubhtml?widget=true&amp;headers=false"
          style="border: none; width: 100%; height: 600px;">
        </iframe>
      </div>
      <div id="assignmentsList" class="space-y-4">
        <div class="text-gray-500 text-cexnter py-8 bg-white/50 dark:bg-gray-800/50 rounded-2xl backdrop-blur-sm">
          nsos
        </div>
      </div>
    </section>

    <!-- NOTEBOOKLM SECTION -->
    <section id="notes" class="section-content hidden">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2
              class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-600 via-blue-600 to-green-600 bg-clip-text text-transparent">
              🧠 NotebookLM Pro
            </h2>
            <p class="text-gray-600 dark:text-gray-400 text-lg">AI-Powered Research & Learning Assistant</p>
            <div id="apiStatus" class="mt-2 text-sm">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
                <i class="fas fa-check-circle mr-1"></i>
                🤖 AI Enabled - GPT-3.5-turbo Active
              </span>
              <button onclick="showApiConfig()" class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
                Manage API
              </button>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="showNotebookView('sources')"
              class="notebook-nav-btn bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-all hover:scale-105 shadow-lg"
              data-view="sources">
              <i class="fas fa-upload mr-2"></i>Sources
            </button>
            <button onclick="showNotebookView('chat')"
              class="notebook-nav-btn bg-white/80 dark:bg-gray-700/80 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-all hover:scale-105 shadow-lg"
              data-view="chat">
              <i class="fas fa-comments mr-2"></i>Chat
            </button>
            <button onclick="showNotebookView('notes')"
              class="notebook-nav-btn bg-white/80 dark:bg-gray-700/80 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-all hover:scale-105 shadow-lg"
              data-view="notes">
              <i class="fas fa-sticky-note mr-2"></i>Notes
            </button>
            <button onclick="showNotebookView('audio')"
              class="notebook-nav-btn bg-white/80 dark:bg-gray-700/80 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium transition-all hover:scale-105 shadow-lg"
              data-view="audio">
              <i class="fas fa-podcast mr-2"></i>Audio
            </button>
          </div>
        </div>
      </div>

      <!-- Sources View -->
      <div id="notebookSources" class="notebook-view">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Upload Area -->
          <div class="lg:col-span-2">
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-8 rounded-3xl shadow-xl border border-white/20 mb-6">
              <h3 class="text-2xl font-bold mb-6 flex items-center">
                <span
                  class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-3">
                  <i class="fas fa-cloud-upload-alt text-white"></i>
                </span>
                📚 Upload Your Sources
              </h3>

              <div
                class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-8 text-center hover:border-blue-500 transition-all cursor-pointer"
                onclick="document.getElementById('fileUpload').click()" ondrop="handleFileDrop(event)"
                ondragover="handleDragOver(event)">
                <div class="mb-4">
                  <i class="fas fa-file-upload text-4xl text-gray-400 mb-4"></i>
                  <p class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Drop files here or click to
                    upload</p>
                  <p class="text-sm text-gray-500">Supports PDF, DOC, TXT, MD, and more</p>
                </div>
                <input type="file" id="fileUpload" multiple accept=".pdf,.doc,.docx,.txt,.md,.rtf" class="hidden"
                  onchange="handleFileUpload(event)">
              </div>

              <!-- URL Input -->
              <div class="mt-6">
                <div class="flex space-x-3">
                  <input type="url" id="urlInput" placeholder="Paste a URL to add web content..."
                    class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white/50 dark:bg-gray-700/50 text-base backdrop-blur-sm">
                  <button onclick="addUrlSource()"
                    class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-xl font-medium transition-all hover:scale-105 shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Add URL
                  </button>
                </div>
              </div>

              <!-- Quick Add Buttons -->
              <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="addSampleSource('textbook')"
                  class="p-4 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl hover:from-blue-500 hover:to-blue-700 transition-all hover:scale-105 shadow-lg">
                  <i class="fas fa-book text-xl mb-2"></i>
                  <p class="text-sm font-bold">Sample Textbook</p>
                </button>
                <button onclick="addSampleSource('research')"
                  class="p-4 bg-gradient-to-r from-purple-400 to-purple-600 text-white rounded-xl hover:from-purple-500 hover:to-purple-700 transition-all hover:scale-105 shadow-lg">
                  <i class="fas fa-microscope text-xl mb-2"></i>
                  <p class="text-sm font-bold">Research Paper</p>
                </button>
                <button onclick="addSampleSource('lecture')"
                  class="p-4 bg-gradient-to-r from-green-400 to-green-600 text-white rounded-xl hover:from-green-500 hover:to-green-700 transition-all hover:scale-105 shadow-lg">
                  <i class="fas fa-chalkboard-teacher text-xl mb-2"></i>
                  <p class="text-sm font-bold">Lecture Notes</p>
                </button>
                <button onclick="addSampleSource('wikipedia')"
                  class="p-4 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-xl hover:from-orange-500 hover:to-orange-700 transition-all hover:scale-105 shadow-lg">
                  <i class="fab fa-wikipedia-w text-xl mb-2"></i>
                  <p class="text-sm font-bold">Wikipedia</p>
                </button>
              </div>
            </div>
          </div>

          <!-- Sources List -->
          <div class="lg:col-span-1">
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 sticky top-24">
              <h4 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-layer-group text-blue-600 mr-2"></i>
                Your Sources
              </h4>
              <div id="sourcesList" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-center py-8 text-gray-500">
                  <i class="fas fa-inbox text-3xl mb-3"></i>
                  <p>No sources added yet</p>
                  <p class="text-sm">Upload files to get started</p>
                </div>
              </div>
              <button onclick="analyzeAllSources()" id="analyzeBtn"
                class="w-full mt-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                <i class="fas fa-brain mr-2"></i>Analyze Sources
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat View -->
      <div id="notebookChat" class="notebook-view hidden">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[600px]">
          <!-- Chat Area -->
          <div
            class="lg:col-span-3 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 flex flex-col">
            <!-- Chat Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-bold flex items-center">
                <span
                  class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-robot text-white text-sm"></i>
                </span>
                💬 AI Research Assistant
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Ask questions about your uploaded sources</p>
            </div>

            <!-- Messages -->
            <div id="chatMessages" class="flex-1 p-6 overflow-y-auto space-y-4">
              <div class="flex items-start space-x-3">
                <div
                  class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                  <i class="fas fa-robot text-white text-xs"></i>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-2xl rounded-tl-sm max-w-md">
                  <p class="text-sm">Hello! I'm your AI research assistant. Upload some sources and I'll help you
                    analyze them, answer questions, and generate insights. What would you like to explore today?</p>
                </div>
              </div>
            </div>

            <!-- Chat Input -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700">
              <div class="flex space-x-3">
                <input type="text" id="chatInput" placeholder="Ask a question about your sources..."
                  class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white/50 dark:bg-gray-700/50 text-base backdrop-blur-sm"
                  onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()"
                  class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-medium transition-all hover:scale-105 shadow-lg">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>

              <!-- Suggested Questions -->
              <div class="mt-4 flex flex-wrap gap-2" id="suggestedQuestions">
                <button onclick="askSuggestedQuestion('What are the main themes in my sources?')"
                  class="text-xs px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
                  What are the main themes?
                </button>
                <button onclick="askSuggestedQuestion('Summarize the key findings')"
                  class="text-xs px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
                  Summarize key findings
                </button>
                <button onclick="askSuggestedQuestion('Find contradictions or debates')"
                  class="text-xs px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">
                  Find contradictions
                </button>
              </div>
            </div>
          </div>

          <!-- Chat Sidebar -->
          <div class="lg:col-span-1 space-y-4">
            <!-- Source Context -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/20">
              <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-link text-blue-600 mr-2"></i>
                Active Sources
              </h4>
              <div id="activeSources" class="space-y-2 text-sm">
                <p class="text-gray-500">No sources selected</p>
              </div>
            </div>

            <!-- Quick Actions -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/20">
              <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-magic text-purple-600 mr-2"></i>
                Quick Actions
              </h4>
              <div class="space-y-2">
                <button onclick="generateSummary()"
                  class="w-full text-left p-2 text-sm bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-all">
                  📄 Generate Summary
                </button>
                <button onclick="createStudyGuide()"
                  class="w-full text-left p-2 text-sm bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 transition-all">
                  📚 Create Study Guide
                </button>
                <button onclick="generateQuiz()"
                  class="w-full text-left p-2 text-sm bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-all">
                  🧠 Generate Quiz
                </button>
                <button onclick="findConnections()"
                  class="w-full text-left p-2 text-sm bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/50 transition-all">
                  🔗 Find Connections
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes View -->
      <div id="notebookNotes" class="notebook-view hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Notes Editor -->
          <div class="lg:col-span-2">
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 h-[600px] flex flex-col">
              <!-- Editor Header -->
              <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                  <h3 class="text-xl font-bold flex items-center">
                    <span
                      class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                      <i class="fas fa-edit text-white text-sm"></i>
                    </span>
                    ✏️ Smart Note Editor
                  </h3>
                  <div class="flex space-x-2">
                    <button onclick="saveCurrentNote()"
                      class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-all">
                      <i class="fas fa-save mr-1"></i>Save
                    </button>
                    <button onclick="createNewNote()"
                      class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-all">
                      <i class="fas fa-plus mr-1"></i>New
                    </button>
                  </div>
                </div>
                <input type="text" id="noteTitle" placeholder="Note title..."
                  class="w-full mt-3 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 text-lg font-semibold">
              </div>

              <!-- Editor Content -->
              <div class="flex-1 p-6">
                <textarea id="noteContent" placeholder="Start writing your notes here... 

💡 Pro tip: Reference your sources by typing @source-name
🔗 Create connections with [[topic-name]]
📝 Use #tags for organization"
                  class="w-full h-full resize-none border-none outline-none bg-transparent text-base leading-relaxed"></textarea>
              </div>

              <!-- Editor Footer -->
              <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
                <div class="flex justify-between items-center text-sm text-gray-600 dark:text-gray-400">
                  <div class="flex space-x-4">
                    <span id="wordCount">0 words</span>
                    <span id="charCount">0 characters</span>
                  </div>
                  <div class="flex space-x-2">
                    <button onclick="insertTemplate('outline')" class="hover:text-blue-600 transition-colors">📋
                      Outline</button>
                    <button onclick="insertTemplate('summary')" class="hover:text-green-600 transition-colors">📄
                      Summary</button>
                    <button onclick="insertTemplate('analysis')" class="hover:text-purple-600 transition-colors">🔍
                      Analysis</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Notes Sidebar -->
          <div class="lg:col-span-1 space-y-4">
            <!-- AI Suggestions -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/20">
              <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                AI Suggestions
              </h4>
              <div id="aiSuggestions" class="space-y-2 text-sm">
                <div class="p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                  <p class="text-yellow-800 dark:text-yellow-200">💡 Start writing to get AI-powered suggestions for
                    improving your notes!</p>
                </div>
              </div>
            </div>

            <!-- My Notes List -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/20">
              <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-folder text-blue-600 mr-2"></i>
                My Notes
              </h4>
              <div id="notesList" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="text-center py-4 text-gray-500">
                  <i class="fas fa-sticky-note text-2xl mb-2"></i>
                  <p class="text-sm">No notes yet</p>
                </div>
              </div>
            </div>

            <!-- Tags & Categories -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/20">
              <h4 class="font-bold mb-3 flex items-center">
                <i class="fas fa-tags text-green-600 mr-2"></i>
                Tags & Topics
              </h4>
              <div id="noteTags" class="flex flex-wrap gap-1">
                <span
                  class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">#physics</span>
                <span
                  class="text-xs px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">#quantum</span>
                <span
                  class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full">#research</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Audio View -->
      <div id="notebookAudio" class="notebook-view hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Audio Generator -->
          <div
            class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-8 rounded-3xl shadow-xl border border-white/20">
            <h3 class="text-2xl font-bold mb-6 flex items-center">
              <span
                class="w-10 h-10 bg-gradient-to-r from-pink-500 to-red-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-microphone text-white"></i>
              </span>
              🎙️ AI Podcast Generator
            </h3>

            <div class="space-y-6">
              <!-- Podcast Settings -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Podcast Style</label>
                  <select id="podcastStyle"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50">
                    <option value="overview">Overview Discussion</option>
                    <option value="deep-dive">Deep Dive Analysis</option>
                    <option value="debate">Debate Format</option>
                    <option value="interview">Interview Style</option>
                    <option value="study-guide">Study Guide</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-bold mb-2">Duration</label>
                  <select id="podcastDuration"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50">
                    <option value="5">5 minutes</option>
                    <option value="10" selected>10 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="20">20 minutes</option>
                  </select>
                </div>
              </div>

              <!-- Focus Areas -->
              <div>
                <label class="block text-sm font-bold mb-2">Focus Areas (Optional)</label>
                <textarea id="podcastFocus"
                  placeholder="Specify particular topics or questions you want the podcast to focus on..."
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 h-20 resize-none"></textarea>
              </div>

              <!-- Generate Button -->
              <button onclick="generatePodcast()" id="generatePodcastBtn"
                class="w-full bg-gradient-to-r from-pink-600 to-red-600 text-white py-4 rounded-xl font-bold text-lg transition-all hover:scale-105 shadow-lg">
                <i class="fas fa-magic mr-2"></i>Generate AI Podcast
              </button>

              <!-- Progress -->
              <div id="podcastProgress" class="hidden">
                <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div id="podcastProgressBar"
                    class="bg-gradient-to-r from-pink-600 to-red-600 h-2 rounded-full transition-all duration-300"
                    style="width: 0%"></div>
                </div>
                <p id="podcastProgressText" class="text-sm text-gray-600 dark:text-gray-400 mt-2 text-center">Preparing
                  podcast...</p>
              </div>
            </div>
          </div>

          <!-- Audio Player & Library -->
          <div class="space-y-6">
            <!-- Current Podcast -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
              <h4 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-play-circle text-green-600 mr-2"></i>
                Now Playing
              </h4>

              <div id="currentPodcast" class="text-center py-8 text-gray-500">
                <i class="fas fa-podcast text-4xl mb-3"></i>
                <p>No podcast generated yet</p>
                <p class="text-sm">Generate your first AI podcast above!</p>
              </div>

              <!-- Audio Player (Hidden initially) -->
              <div id="audioPlayer" class="hidden">
                <div
                  class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-2xl mb-4">
                  <h5 id="podcastTitle" class="font-bold text-lg mb-2">Your AI Podcast</h5>
                  <p id="podcastDescription" class="text-sm text-gray-600 dark:text-gray-400">AI-generated discussion
                    based on your sources</p>
                </div>

                <audio id="audioElement" controls class="w-full mb-4">
                  <source id="audioSource" src="" type="audio/mpeg">
                  Your browser does not support the audio element.
                </audio>

                <div class="flex justify-between items-center text-sm text-gray-600 dark:text-gray-400">
                  <span id="currentTime">0:00</span>
                  <div class="flex space-x-2">
                    <button onclick="changePlaybackSpeed(0.75)" class="hover:text-blue-600">0.75x</button>
                    <button onclick="changePlaybackSpeed(1)" class="hover:text-blue-600">1x</button>
                    <button onclick="changePlaybackSpeed(1.25)" class="hover:text-blue-600">1.25x</button>
                    <button onclick="changePlaybackSpeed(1.5)" class="hover:text-blue-600">1.5x</button>
                  </div>
                  <span id="totalTime">0:00</span>
                </div>
              </div>
            </div>

            <!-- Podcast Library -->
            <div
              class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
              <h4 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-library text-blue-600 mr-2"></i>
                Podcast Library
              </h4>

              <div id="podcastLibrary" class="space-y-3 max-h-64 overflow-y-auto">
                <div class="text-center py-4 text-gray-500">
                  <i class="fas fa-headphones text-2xl mb-2"></i>
                  <p class="text-sm">Your generated podcasts will appear here</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDAR SECTION -->
    <section id="calendar" class="section-content hidden">
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2
              class="text-3xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
              📅 Smart Academic Calendar</h2>
            <p class="text-gray-600 dark:text-gray-400">Google Calendar integration with intelligent reminders.
            <div id="calendarSection">
              <iframe
                src="https://calendar.google.com/calendar/embed?src=4fc31f36c20f654e12fbd6bc4bca5cc2926f1764a8266a136bd71bdf835af5da%40group.calendar.google.com&ctz=Asia%2FHo_Chi_Minh"
                style="border: 0" width="970" height="600" frameborder="0" scrolling="no">
              </iframe>
            </div>
            <!-- Events and Reminders -->
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div
                class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                  <span
                    class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-calendar text-white text-sm"></i>
                  </span>
                  📅 Upcoming Events
                </h3>
                <div id="upcomingEvents" class="space-y-3 max-h-70 overflow-y-auto">
                  <div class="text-gray-500 text-sm">WRO 2025 !!! </div>
                </div>
              </div>

              <div
                class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                  <span
                    class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-clock text-white text-sm"></i>
                  </span>
                  ⏰ Today's Schedule
                </h3>
                <div id="todaySchedule" class="space-y-3 max-h-64 overflow-y-auto">
                  <div class="text-gray-500 text-sm">WRO 2025 !!!</div>
                </div>
              </div>

              <div
                class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                  <span
                    class="w-8 h-8 bg-gradient-to-r from-red-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-bell text-white text-sm"></i>
                  </span>
                  🔔 Active Reminders
                </h3>
                <div id="activeReminders" class="space-y-3 max-h-64 overflow-y-auto">
                  <div class="text-gray-500 text-sm">WRO 2025 !!!</div>
                </div>
              </div>
            </div>
    </section>

    <!-- CALCULATOR SECTION -->
    <section id="calculator" class="section-content hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-bold mb-4 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">🔬
          Advanced Scientific Calculator</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Powerful mathematical tools for complex calculations</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Calculator Interface -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <div class="mb-4">
            <input type="text" id="calculatorDisplay"
              class="w-full px-4 py-4 text-xl border border-gray-300 dark:border-gray-600 rounded-2xl bg-white/50 dark:bg-gray-700/50 font-mono text-right backdrop-blur-sm"
              readonly placeholder="0">
          </div>

          <div class="grid grid-cols-5 gap-2">
            <!-- Scientific Functions Row -->
            <button onclick="addToCalculator('Math.sin(')"
              class="calc-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">sin</button>
            <button onclick="addToCalculator('Math.cos(')"
              class="calc-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">cos</button>
            <button onclick="addToCalculator('Math.tan(')"
              class="calc-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">tan</button>
            <button onclick="addToCalculator('Math.log10(')"
              class="calc-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">log</button>
            <button onclick="addToCalculator('Math.log(')"
              class="calc-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">ln</button>

            <!-- Advanced Functions Row -->
            <button onclick="addToCalculator('Math.sqrt(')"
              class="calc-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">√</button>
            <button onclick="addToCalculator('Math.pow(')"
              class="calc-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">x^y</button>
            <button onclick="addToCalculator('Math.PI')"
              class="calc-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">π</button>
            <button onclick="addToCalculator('Math.E')"
              class="calc-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform text-xs shadow-lg">e</button>
            <button onclick="clearCalculator()"
              class="calc-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">C</button>

            <!-- Numbers and Operations -->
            <button onclick="addToCalculator('7')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">7</button>
            <button onclick="addToCalculator('8')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">8</button>
            <button onclick="addToCalculator('9')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">9</button>
            <button onclick="addToCalculator('/')"
              class="calc-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">÷</button>
            <button onclick="deleteLast()"
              class="calc-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">⌫</button>

            <button onclick="addToCalculator('4')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">4</button>
            <button onclick="addToCalculator('5')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">5</button>
            <button onclick="addToCalculator('6')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">6</button>
            <button onclick="addToCalculator('*')"
              class="calc-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">×</button>
            <button onclick="addToCalculator('(')"
              class="calc-btn bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">(</button>

            <button onclick="addToCalculator('1')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">1</button>
            <button onclick="addToCalculator('2')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">2</button>
            <button onclick="addToCalculator('3')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">3</button>
            <button onclick="addToCalculator('-')"
              class="calc-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">-</button>
            <button onclick="addToCalculator(')')"
              class="calc-btn bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">)</button>

            <button onclick="addToCalculator('0')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg col-span-2">0</button>
            <button onclick="addToCalculator('.')"
              class="calc-btn bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">.</button>
            <button onclick="addToCalculator('+')"
              class="calc-btn bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">+</button>
            <button onclick="calculate()"
              class="calc-btn bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white p-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">=</button>
          </div>

          <div class="space-y-2 mt-4">
            <button onclick="plotFunction()"
              class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-chart-line mr-2"></i>Plot Function
            </button>
            <button onclick="solveEquation()"
              class="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white py-3 rounded-xl font-medium transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-equals mr-2"></i>Solve Equation
            </button>
          </div>
        </div>

        <!-- Results and Visualization -->
        <div class="space-y-6">
          <div
            class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
            <h3 class="text-lg font-semibold mb-4">📊 Calculation Results</h3>
            <div id="calculatorResults" class="space-y-2 max-h-48 overflow-y-auto">
              <p class="text-gray-500 text-sm">Enter calculations to see results here</p>
            </div>
          </div>

          <div
            class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
            <h3 class="text-lg font-semibold mb-4">📈 Function Visualization</h3>
            <div class="mb-4">
              <input type="text" id="functionInput" placeholder="Enter function like x*x or Math.sin(x)"
                class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 backdrop-blur-sm">
            </div>
            <canvas id="functionCanvas" width="400" height="256" class="w-full border rounded-lg bg-white"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- DATA ANALYSIS SECTION -->
    <section id="data" class="section-content hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-bold mb-4 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">📊
          Advanced Data Analysis Studio</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Analyze datasets, create visualizations, and discover insights
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Data Input -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <h3 class="text-lg font-semibold mb-4">📥 Data Input</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Dataset Name</label>
              <input type="text" id="datasetName"
                class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 backdrop-blur-sm"
                placeholder="Enter dataset name">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Data Points (comma separated)</label>
              <textarea id="dataPoints" rows="6"
                class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 backdrop-blur-sm"
                placeholder="Enter data points: 1,2,3,4,5"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <button onclick="generateSampleData()"
                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-2 rounded-lg font-medium transition-all hover:scale-105 transform shadow-lg">
                🎲 Generate Sample
              </button>
              <button onclick="analyzeData()"
                class="bg-gradient-to-r from-success to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white py-2 rounded-lg font-medium transition-all hover:scale-105 transform shadow-lg">
                🔍 Analyze Data
              </button>
            </div>
          </div>
        </div>

        <!-- Statistical Analysis -->
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20">
          <h3 class="text-lg font-semibold mb-4">📈 Statistical Analysis</h3>
          <div id="statisticalResults" class="space-y-3">
            <p class="text-gray-500 text-sm">Input data to see statistical analysis</p>
          </div>
        </div>

        <!-- Data Visualization -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 lg:col-span-2">
          <h3 class="text-lg font-semibold mb-4">📊 Data Visualization</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="h-64">
              <canvas id="dataChart"></canvas>
            </div>
            <div class="h-64">
              <canvas id="distributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESOURCES SECTION -->
    <section id="resources" class="section-content hidden">
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2
              class="text-3xl font-bold mb-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
              📚 Learning Resources Hub</h2>
            <p class="text-gray-600 dark:text-gray-400">Educational materials and references</p>
          </div>
          <div class="flex items-center space-x-3">
            <input type="text" id="resourceSearch" placeholder="Search resources..."
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white/50 dark:bg-gray-700/50 text-base backdrop-blur-sm">
            <select id="resourceType" onchange="filterResourcesByType(this.value)"
              class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white/50 dark:bg-gray-700/50 text-base backdrop-blur-sm">
              <option value="all">All Types</option>
              <option value="video">Videos</option>
              <option value="article">Articles</option>
              <option value="book">Books</option>
              <option value="website">Websites</option>
            </select>
          </div>
        </div>
      </div>

      <!-- RESOURCE CATEGORIES -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <button onclick="filterResources('all')"
          class="resource-filter p-4 bg-gradient-to-r from-primary to-secondary text-white rounded-2xl hover:shadow-2xl transition-all transform hover:scale-105 shadow-lg"
          data-category="all">
          <i class="fas fa-th text-2xl mb-2"></i>
          <p class="font-semibold">All Resources</p>
        </button>
        <button onclick="filterResources('science')"
          class="resource-filter p-4 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-2xl hover:shadow-2xl transition-all transform hover:scale-105 shadow-lg"
          data-category="science">
          <i class="fas fa-microscope text-2xl mb-2"></i>
          <p class="font-semibold">Science</p>
        </button>
        <button onclick="filterResources('technology')"
          class="resource-filter p-4 bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-2xl hover:shadow-2xl transition-all transform hover:scale-105 shadow-lg"
          data-category="technology">
          <i class="fas fa-laptop-code text-2xl mb-2"></i>
          <p class="font-semibold">Technology</p>
        </button>
        <button onclick="filterResources('engineering')"
          class="resource-filter p-4 bg-gradient-to-r from-gray-500 to-gray-700 text-white rounded-2xl hover:shadow-2xl transition-all transform hover:scale-105 shadow-lg"
          data-category="engineering">
          <i class="fas fa-cogs text-2xl mb-2"></i>
          <p class="font-semibold">Engineering</p>
        </button>
        <button onclick="filterResources('arts-math')"
          class="resource-filter p-4 bg-gradient-to-r from-pink-500 to-pink-700 text-white rounded-2xl hover:shadow-2xl transition-all transform hover:scale-105 shadow-lg"
          data-category="arts-math">
          <i class="fas fa-palette text-2xl mb-2"></i>
          <p class="font-semibold">Arts & Math</p>
        </button>
      </div>

      <!-- RESOURCES GRID -->
      <div id="resourcesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        <!-- YouTube Educational Videos -->

        <!-- Crash Course Physics -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="science" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">Crash Course Physics</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Educational Video Series</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/ZM8ECpBuQYE" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Learn physics concepts with engaging animations and
            clear explanations.</p>
          <a href="https://www.youtube.com/playlist?list=PL8dPuuaLjXtN0ge7yDk_UA0ldZJdhwkoV" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Watch Playlist
          </a>
        </div>

        <!-- Khan Academy Math -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="arts-math" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">Khan Academy Calculus</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Mathematics Tutorial</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/WUvTyaaNkzM" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Master calculus with step-by-step explanations and
            practice problems.</p>
          <a href="https://www.youtube.com/playlist?list=PL19E79A0638C8D449" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Watch Playlist
          </a>
        </div>

        <!-- TED-Ed Science -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="science" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">TED-Ed Chemistry</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Animated Science Lessons</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/yQP4UJhNn0I" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Explore chemistry concepts through beautiful
            animations and storytelling.</p>
          <a href="https://www.youtube.com/c/TED-Ed" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Visit Channel
          </a>
        </div>

        <!-- Coding with Python -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="technology" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">Python Programming</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Coding Tutorial</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/rfscVS0vtbw" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Learn Python programming from basics to advanced
            concepts.</p>
          <a href="https://www.youtube.com/watch?v=rfscVS0vtbw" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Full Course
          </a>
        </div>

        <!-- Engineering Explained -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="engineering" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-gray-500 to-gray-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">Engineering Explained</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Mechanical Engineering</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/yYAw79386WI" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Understand how cars and engines work with detailed
            explanations.</p>
          <a href="https://www.youtube.com/c/EngineeringExplained" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Visit Channel
          </a>
        </div>

        <!-- Art & Design -->
        <div
          class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 resource-item"
          data-category="arts-math" data-type="video">
          <div class="flex items-center mb-4">
            <div
              class="w-10 h-10 bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
              <i class="fab fa-youtube text-white"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">Digital Art Tutorial</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Creative Arts</p>
            </div>
          </div>
          <div class="aspect-w-16 aspect-h-9 mb-4">
            <iframe src="https://www.youtube.com/embed/ewMksAbgdBI" class="w-full h-48 rounded-lg" frameborder="0"
              allowfullscreen></iframe>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Learn digital art techniques and creative design
            principles.</p>
          <a href="https://www.youtube.com/watch?v=ewMksAbgdBI" target="_blank"
            class="inline-block px-4 py-2 bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all">
            <i class="fab fa-youtube mr-2"></i>Watch Tutorial
          </a>
        </div>

      </div>
    </section>

    <!-- Inventory Section -->
    <section id="gradebook" class="section-content hidden">
      <div class="mb-8">
        <!-- Header -->
        <div class="mb-6 text-center">
          <h2 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            📊 Inventory System
          </h2>
          <p class="text-gray-600 dark:text-gray-400">
            See the current inventory status
          </p>
        </div>

        <!-- Sheet -->
        <div class="rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRXglfVcHRbcyZkbsxsZ6souKwSdrV6Wi3DXeBgO1bptxZ9sA49iqHOLrm20pGD0ljRh4dDsMCKCTan/pubhtml?widget=true&amp;headers=false"
            class="w-full h-[600px] border-0">
          </iframe>
        </div>

        <!-- Navigation buttons -->
        <div class="flex justify-center gap-4 mt-6">
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white shadow hover:bg-indigo-700">InPut</button>
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white shadow hover:bg-indigo-700">BorrowReturn</button>
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white shadow hover:bg-indigo-700">Warehouses</button>
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white shadow hover:bg-indigo-700">Check Item</button>
        </div>
      </div>
    </section>

    <!-- Grades will be populated here -->
    </tbody>
    </table>
  </div>
  </div>
  </section>
  </div>


  <!-- AI TUTOR FULLSCREEN MODAL (FIXED FULLSCREEN IFRAME) -->
  <div id="aiModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50">
    <div class="absolute inset-0 bg-white dark:bg-gray-900">
      <button onclick="document.getElementById('aiModal').classList.add('hidden')"
        class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl z-50">✕</button>

      <iframe src="https://interfaces.zapier.com/embed/chatbot/cmfgnkzl10012e5262eaozjto" allow="clipboard-write *"
        style="border: none; width: 100%; height: 100%; display: block;">
      </iframe>
    </div>
  </div>

  <!-- Removed duplicate openAI function -->

  <!-- LAB MODAL -->
  <div id="labModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div
      class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-3xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden border border-white/20">
      <div
        class="flex items-center justify-between p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-primary/10 to-secondary/10">
        <h3 class="text-2xl font-bold" id="labModalTitle">🧪 Virtual Laboratory</h3>
        <div class="flex items-center space-x-2">
          <button onclick="saveLabReport()"
            class="bg-gradient-to-r from-success to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover:scale-105 transform shadow-lg">
            <i class="fas fa-save mr-1"></i>Save Report
          </button>
          <button onclick="resetLab()"
            class="bg-gradient-to-r from-warning to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover:scale-105 transform shadow-lg">
            <i class="fas fa-redo mr-1"></i>Reset
          </button>
          <button onclick="closeLabModal()"
            class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6 max-h-[80vh] overflow-y-auto" id="labModalContent">
        <!-- Lab content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- CUSTOM MODALS -->
  <div id="customModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div
      class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-white/20">
      <div
        class="flex items-center justify-between p-6 border-b border-gray-200/50 dark:border-gray-700/50 bg-gradient-to-r from-primary/10 to-secondary/10">
        <h3 class="text-xl font-semibold" id="customModalTitle"></h3>
        <button onclick="closeCustomModal()"
          class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto" id="customModalContent"></div>
    </div>
  </div>

  <!-- TOAST NOTIFICATIONS -->
  <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <!-- MOBILE MENU -->
  <div
    class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-t border-gray-200/50 dark:border-gray-700/50 p-2 z-40">
    <div class="grid grid-cols-5 gap-1">
      <button onclick="showSection('dashboard')"
        class="flex flex-col items-center space-y-1 p-2 rounded-lg text-xs transition-all hover:bg-white/50 dark:hover:bg-gray-700/50">
        <i class="fas fa-home text-lg"></i>
        <span>Home</span>
      </button>
      <button onclick="showSection('labs')"
        class="flex flex-col items-center space-y-1 p-2 rounded-lg text-xs transition-all hover:bg-white/50 dark:hover:bg-gray-700/50">
        <i class="fas fa-flask text-lg"></i>
        <span>Labs</span>
      </button>
      <button onclick="showSection('assignments')"
        class="flex flex-col items-center space-y-1 p-2 rounded-lg text-xs transition-all hover:bg-white/50 dark:hover:bg-gray-700/50">
        <i class="fas fa-tasks text-lg"></i>
        <span>Tasks</span>
      </button>
      <button onclick="showSection('calendar')"
        class="flex flex-col items-center space-y-1 p-2 rounded-lg text-xs transition-all hover:bg-white/50 dark:hover:bg-gray-700/50">
        <i class="fas fa-calendar text-lg"></i>
        <span>Calendar</span>
      </button>
      <button onclick="openAI()"
        class="flex flex-col items-center space-y-1 p-2 rounded-lg text-xs transition-all hover:bg-white/50 dark:hover:bg-gray-700/50">
        <i class="fas fa-brain text-lg"></i>
        <span>AI</span>
      </button>
    </div>
  </div>

  <script>
    // ====================================
    // GLOBAL STATE & DATA
    // ====================================

    let currentSection = 'dashboard';
    let currentDate = new Date();

    // Enhanced user progress tracking
    let userProgress = {
      experimentsCompleted: 0,
      tasksCompleted: 0,
      studyHours: 0,
      totalScore: 0,
      userLevel: 1,
      studyStreak: 0,
      achievements: 0,
      aiInteractions: 0,
      lastActiveDate: new Date().toDateString()
    };

    // Data storage
    let assignments = [];
    let notes = [];
    let calendarEvents = [];
    let labReports = [];
    let resources = [];
    let grades = [
      { subject: "Advanced Chemistry", grade: "A-", credits: 4, instructor: "Dr. Smith", progress: 95 },
      { subject: "Quantum Physics", grade: "B+", credits: 4, instructor: "Prof. Johnson", progress: 88 },
      { subject: "Calculus III", grade: "A", credits: 3, instructor: "Dr. Lee", progress: 96 },
      { subject: "Computer Science", grade: "A-", credits: 4, instructor: "Prof. Davis", progress: 92 },
      { subject: "Engineering Design", grade: "B+", credits: 3, instructor: "Dr. Brown", progress: 89 }
    ];
    // Enhanced lab data with interactive PhET features
    const labs = [
      {
        id: 1,
        title: "🔋 Circuit Construction Kit: DC",
        category: "physics",
        subject: "Electricity",
        difficulty: "Intermediate",
        duration: "45 min",
        description: "Build and explore simple DC electrical circuits with batteries, resistors, and light bulbs.",
        features: [
          "Drag-and-drop circuit components",
          "Measure current and voltage",
          "Short circuit detection",
          "Interactive voltmeter and ammeter"
        ],
        icon: "fas fa-bolt",
        embed: "https://phet.colorado.edu/sims/html/circuit-construction-kit-dc/latest/circuit-construction-kit-dc_en.html"
      },
      {
        id: 2,
        title: "⚡ Circuit Construction Kit: AC",
        category: "physics",
        subject: "Electricity",
        difficulty: "Advanced",
        duration: "60 min",
        description: "Experiment with AC circuits, capacitors, and inductors using a virtual circuit builder.",
        features: [
          "AC voltage sources",
          "Capacitors and inductors",
          "Real-time oscilloscopes",
          "Adjustable frequency and amplitude"
        ],
        icon: "fas fa-plug",
        embed: "https://phet.colorado.edu/sims/html/circuit-construction-kit-ac/latest/circuit-construction-kit-ac_en.html"
      },
      {
        id: 3,
        title: "🎯 Projectile Motion",
        category: "physics",
        subject: "Mechanics",
        difficulty: "Beginner",
        duration: "40 min",
        description: "Investigate how angle, speed, and mass affect the trajectory of projectiles.",
        features: [
          "Launch objects with adjustable angle and velocity",
          "Compare different projectile paths",
          "Air resistance toggle",
          "Measurement tools for range and time"
        ],
        icon: "fas fa-bullseye",
        embed: "https://phet.colorado.edu/sims/html/projectile-motion/latest/projectile-motion_en.html"
      },
      {
        id: 4,
        title: "🛹 Energy Skate Park: Basics",
        category: "physics",
        subject: "Energy",
        difficulty: "Intermediate",
        duration: "50 min",
        description: "Explore conservation of energy using a virtual skateboarder on customizable tracks.",
        features: [
          "Potential vs kinetic energy visualization",
          "Adjustable track designs",
          "Real-time energy graphs",
          "Friction control"
        ],
        icon: "fas fa-chart-line",
        embed: "https://phet.colorado.edu/sims/html/energy-skate-park-basics/latest/energy-skate-park-basics_en.html"
      },
      {
        id: 5,
        title: "🌡️ States of Matter: Basics",
        category: "chemistry",
        subject: "Matter",
        difficulty: "Beginner",
        duration: "35 min",
        description: "Visualize how particles behave in solids, liquids, and gases under different conditions.",
        features: [
          "Particle-level animations",
          "Adjust temperature and pressure",
          "Phase changes (solid ↔ liquid ↔ gas)",
          "Multiple atom types"
        ],
        icon: "fas fa-temperature-high",
        embed: "https://phet.colorado.edu/sims/html/states-of-matter-basics/latest/states-of-matter-basics_en.html"
      }
    ];


    // Smart AI responses for different contexts
    const aiResponses = {
      chemistry: [
        "🧪 Great chemistry question! Let me help you understand this reaction step by step...",
        "In chemistry, this concept connects to molecular structure and bonding. Here's what's happening...",
        "Let's break down this chemical process using the principles of thermodynamics and kinetics...",
        "This is a fascinating example of how atoms interact! The key is understanding electron behavior..."
      ],
      physics: [
        "⚛️ Excellent physics question! This involves some fundamental principles of nature...",
        "In physics, we can solve this using the laws of motion and energy conservation...",
        "This phenomenon occurs because of the wave-particle duality of matter and energy...",
        "Let me explain this using mathematical models and real-world analogies..."
      ],
      mathematics: [
        "📐 Great math problem! Let's approach this systematically using logical steps...",
        "In mathematics, this type of problem requires us to apply specific theorems and formulas...",
        "This is a classic example of mathematical modeling in action. Here's how to solve it...",
        "The key insight here is recognizing the pattern and applying the right mathematical tools..."
      ],
      engineering: [
        "🏗️ Interesting engineering challenge! This requires both theoretical knowledge and practical thinking...",
        "In engineering, we need to consider safety factors, material properties, and design constraints...",
        "This problem exemplifies the engineering design process: identify, analyze, solve, and test...",
        "Let's apply engineering principles to find an optimal solution that balances all requirements..."
      ],
      general: [
        "🧠 That's a thoughtful question! Let me help you understand this concept better...",
        "This is a great learning opportunity! Here's how we can approach this problem...",
        "I can see you're thinking critically about this topic. Let me guide you through it...",
        "Excellent question! This connects to several important STEAM concepts..."
      ]
    };

    // Calculator state
    let calculatorInput = '';
    let lastResult = 0;

    // Data analysis
    let currentDataset = null;
    let dataChart = null;
    let distributionChart = null;

    // Lab interaction states
    let chemicalState = { acid: 0, base: 0, temperature: 25, pressure: 1 };
    let quantumState = { qubits: 2, amplitudes: [1, 0, 0, 0], gates: [] };
    let engineeringState = { materials: 'steel', supports: 3, load: 500, safetyFactor: 2.0 };

    // ====================================
    // INITIALIZATION
    // ====================================

    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
    });

    function initializeApp() {
      setupDarkMode();
      updateDateTime();
      checkDailyStreak();
      loadProgress();
      populateAllSections();
      initializeProgressChart();
      generateCalendar();

      // Update date every 5 minutes (less frequent since we only show month/day)
      setInterval(updateDateTime, 300000);

      // Auto-save every 5 minutes
      setInterval(saveProgress, 300000);

      showWelcomeMessage();
    }

    function setupDarkMode() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
      }

      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (event.matches) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      });
    }

    function updateDateTime() {
      const now = new Date();
      const dateElement = document.getElementById('currentDateTime');

      if (!dateElement) return;

      // Simple month and day format
      const options = {
        month: 'short',
        day: 'numeric'
      };

      const dateString = now.toLocaleDateString('en-US', options);

      // Only update if the date has actually changed to prevent glitching
      if (dateElement.textContent !== dateString) {
        dateElement.textContent = dateString;
      }
    }

    function checkDailyStreak() {
      const today = new Date().toDateString();
      if (userProgress.lastActiveDate !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        if (userProgress.lastActiveDate === yesterday.toDateString()) {
          userProgress.studyStreak++;
        } else {
          userProgress.studyStreak = 1;
        }

        userProgress.lastActiveDate = today;
        checkAchievements();
      }
    }

    function checkAchievements() {
      const oldAchievements = userProgress.achievements;

      // Streak achievements
      if (userProgress.studyStreak >= 7 && userProgress.achievements < 1) {
        userProgress.achievements = 1;
        showAchievement("🔥 Week Warrior!", "7-day study streak achieved!");
      }

      // Experiment achievements
      if (userProgress.experimentsCompleted >= 5 && userProgress.achievements < 2) {
        userProgress.achievements = 2;
        showAchievement("🧪 Lab Master!", "Completed 5 experiments!");
      }

      // Score achievements
      if (userProgress.totalScore >= 1000 && userProgress.achievements < 3) {
        userProgress.achievements = 3;
        showAchievement("🏆 Score Champion!", "Reached 1000 points!");
      }

      // Level up check
      if (userProgress.totalScore >= userProgress.userLevel * 500) {
        userProgress.userLevel++;
        showAchievement("📈 Level Up!", `Now at Level ${userProgress.userLevel}!`);
      }
    }

    function showAchievement(title, description) {
      showToast(`${title} - ${description}`, 'success');

      // Create achievement popup
      const popup = document.createElement('div');
      popup.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 text-white p-8 rounded-3xl shadow-2xl z-50 animate-bounce';
      popup.innerHTML = `
        <div class="text-center">
          <div class="text-6xl mb-4">🏆</div>
          <h3 class="text-2xl font-bold mb-2">${title}</h3>
          <p class="text-lg">${description}</p>
        </div>
      `;

      document.body.appendChild(popup);

      setTimeout(() => {
        popup.remove();
      }, 3000);
    }

    function showWelcomeMessage() {
      if (!localStorage.getItem('steamWelcomeShown')) {
        setTimeout(() => {
          showToast('🚀 Welcome to STEAM Lab Pro! Start your learning journey today!', 'info');
          localStorage.setItem('steamWelcomeShown', 'true');
        }, 1000);
      }
    }

    function loadProgress() {
      const saved = localStorage.getItem('steamLabProgress');
      if (saved) {
        const data = JSON.parse(saved);
        userProgress = { ...userProgress, ...data };

        // Load other data
        assignments = JSON.parse(localStorage.getItem('steamAssignments') || '[]');
        notes = JSON.parse(localStorage.getItem('steamNotes') || '[]');
        calendarEvents = JSON.parse(localStorage.getItem('steamEvents') || '[]');
        resources = JSON.parse(localStorage.getItem('steamResources') || '[]');
      }
      updateAllStats();
    }

    function saveProgress() {
      localStorage.setItem('steamLabProgress', JSON.stringify(userProgress));
      localStorage.setItem('steamAssignments', JSON.stringify(assignments));
      localStorage.setItem('steamNotes', JSON.stringify(notes));
      localStorage.setItem('steamEvents', JSON.stringify(calendarEvents));
      localStorage.setItem('steamResources', JSON.stringify(resources));
      showToast('💾 Progress saved successfully!', 'success');
    }

    function updateAllStats() {
      // Update all dashboard elements
      document.getElementById('userScore').textContent = userProgress.totalScore;
      document.getElementById('experimentsCompleted').textContent = userProgress.experimentsCompleted;
      document.getElementById('tasksCompleted').textContent = userProgress.tasksCompleted;
      document.getElementById('studyStreak').textContent = userProgress.studyStreak;
      document.getElementById('userLevel').textContent = userProgress.userLevel;
      document.getElementById('achievements').textContent = userProgress.achievements;
      document.getElementById('aiInteractions').textContent = userProgress.aiInteractions;

      // Update assignment counts
      updateAssignmentCounts();
    }

    function updateAssignmentCounts() {
      const now = new Date();
      const overdue = assignments.filter(a => new Date(a.dueDate) < now && a.status !== 'completed');
      const dueSoon = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const daysDiff = (dueDate - now) / (1000 * 60 * 60 * 24);
        return daysDiff <= 3 && daysDiff > 0 && a.status !== 'completed';
      });
      const inProgress = assignments.filter(a => a.status === 'in-progress');
      const completed = assignments.filter(a => a.status === 'completed');

      document.getElementById('overdueCount').textContent = overdue.length;
      document.getElementById('dueSoonCount').textContent = dueSoon.length;
      document.getElementById('inProgressCount').textContent = inProgress.length;
      document.getElementById('completedCount').textContent = completed.length;
    }

    // ====================================
    // NAVIGATION
    // ====================================

    // Removed duplicate showSection function - using enhanced version below

    function updateActiveNavButton(sectionId) {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
        btn.classList.add('text-gray-600', 'dark:text-gray-400');
      });

      const activeBtn = document.querySelector(`[data-section="${sectionId}"]`);
      if (activeBtn) {
        activeBtn.classList.add('bg-primary', 'text-white', 'shadow-lg');
        activeBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
      }
    }

    function addActivityFeed(message) {
      const feed = document.getElementById('activityFeed');
      if (!feed) return;

      const timestamp = new Date().toLocaleTimeString();
      const fullTimestamp = new Date().toLocaleString();

      // Get icon based on message content
      const getActivityIcon = (msg) => {
        if (msg.includes('🧪') || msg.includes('experiment')) return 'fa-flask';
        if (msg.includes('📝') || msg.includes('note')) return 'fa-sticky-note';
        if (msg.includes('📋') || msg.includes('assignment')) return 'fa-tasks';
        if (msg.includes('🧮') || msg.includes('calculator')) return 'fa-calculator';
        if (msg.includes('📅') || msg.includes('calendar')) return 'fa-calendar';
        if (msg.includes('📊') || msg.includes('data')) return 'fa-chart-bar';
        if (msg.includes('📚') || msg.includes('resource')) return 'fa-book';
        if (msg.includes('🤖') || msg.includes('AI')) return 'fa-robot';
        if (msg.includes('📖') || msg.includes('Viewed')) return 'fa-eye';
        return 'fa-star';
      };

      const activity = document.createElement('div');
      activity.className = 'flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border border-blue-200/50 dark:border-blue-700/50 transform hover:scale-105 transition-all animate-slide-up';
      activity.innerHTML = `
        <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
          <i class="fas ${getActivityIcon(message)} text-white text-xs"></i>
        </div>
        <div class="flex-1">
          <p class="font-medium text-sm">${message}</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = feed.querySelector('.text-gray-500');
      if (placeholder && placeholder.textContent.includes('Start experimenting')) {
        placeholder.remove();
      }

      feed.insertBefore(activity, feed.firstChild);

      // Keep only last 8 activities (increased from 5)
      while (feed.children.length > 8) {
        feed.removeChild(feed.lastChild);
      }

      // Store in localStorage
      const activities = JSON.parse(localStorage.getItem('steam_activities') || '[]');
      activities.unshift({
        message,
        timestamp: fullTimestamp,
        id: Date.now()
      });

      // Keep last 50 activities in storage
      if (activities.length > 50) {
        activities.splice(50);
      }

      localStorage.setItem('steam_activities', JSON.stringify(activities));
    }

    // Load activities from localStorage on page load
    function loadActivityFeed() {
      const activities = JSON.parse(localStorage.getItem('steam_activities') || '[]');
      const feed = document.getElementById('activityFeed');

      if (!feed) return;

      // Clear existing content
      feed.innerHTML = '';

      if (activities.length === 0) {
        feed.innerHTML = `
          <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">
            Start experimenting to see your activity!
          </div>
        `;
        return;
      }

      // Show last 8 activities
      activities.slice(0, 8).forEach(activity => {
        const activityEl = document.createElement('div');
        activityEl.className = 'flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border border-blue-200/50 dark:border-blue-700/50 transform hover:scale-105 transition-all';

        const getActivityIcon = (msg) => {
          if (msg.includes('🧪') || msg.includes('experiment')) return 'fa-flask';
          if (msg.includes('📝') || msg.includes('note')) return 'fa-sticky-note';
          if (msg.includes('📋') || msg.includes('assignment')) return 'fa-tasks';
          if (msg.includes('🧮') || msg.includes('calculator')) return 'fa-calculator';
          if (msg.includes('📅') || msg.includes('calendar')) return 'fa-calendar';
          if (msg.includes('📊') || msg.includes('data')) return 'fa-chart-bar';
          if (msg.includes('📚') || msg.includes('resource')) return 'fa-book';
          if (msg.includes('🤖') || msg.includes('AI')) return 'fa-robot';
          if (msg.includes('📖') || msg.includes('Viewed')) return 'fa-eye';
          return 'fa-star';
        };

        activityEl.innerHTML = `
          <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
            <i class="fas ${getActivityIcon(activity.message)} text-white text-xs"></i>
          </div>
          <div class="flex-1">
            <p class="font-medium text-sm">${activity.message}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(activity.timestamp).toLocaleTimeString()}</p>
          </div>
        `;

        feed.appendChild(activityEl);
      });
    }

    // ====================================
    // CONTENT POPULATION
    // ====================================

    function populateAllSections() {
      populateLabs();
      populateAssignments();
      populateNotes();
      populateResources();
      populateGradesTable();
    }

    function populateLabs() {
      const labsGrid = document.getElementById('labsGrid');
      labsGrid.innerHTML = labs.map(lab => `
        <div class="lab-card bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105" 
             data-category="${lab.category}" onclick="openLab(${lab.id})">
          <div class="flex items-center justify-between mb-4">
            <div class="w-16 h-16 bg-gradient-to-r from-${getCategoryColor(lab.category)}-400 to-${getCategoryColor(lab.category)}-600 rounded-2xl flex items-center justify-center shadow-lg">
              <i class="${lab.icon} text-white text-2xl"></i>
            </div>
            <span class="text-xs px-3 py-1 rounded-full ${getDifficultyColor(lab.difficulty)} font-bold">
              ${lab.difficulty}
            </span>
          </div>
          <h3 class="font-bold text-xl mb-3 bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">${lab.title}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">${lab.description}</p>
          <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
            <span><i class="fas fa-clock mr-1 text-primary"></i>${lab.duration}</span>
            <span><i class="fas fa-book mr-1 text-secondary"></i>${lab.subject}</span>
          </div>
          <div class="mb-4">
            <p class="text-xs font-bold text-gray-700 dark:text-gray-300 mb-2">✨ Features:</p>
            <div class="flex flex-wrap gap-1">
              ${lab.features.slice(0, 2).map(feature => `<span class="text-xs px-2 py-1 bg-gradient-to-r from-${getCategoryColor(lab.category)}-100 to-${getCategoryColor(lab.category)}-200 dark:from-${getCategoryColor(lab.category)}-900/30 dark:to-${getCategoryColor(lab.category)}-800/30 text-${getCategoryColor(lab.category)}-700 dark:text-${getCategoryColor(lab.category)}-300 rounded-full">${feature}</span>`).join('')}
            </div>
          </div>
          <button onclick="event.stopPropagation(); openLab(${lab.id})" class="w-full bg-gradient-to-r from-${getCategoryColor(lab.category)}-500 to-${getCategoryColor(lab.category)}-600 hover:from-${getCategoryColor(lab.category)}-600 hover:to-${getCategoryColor(lab.category)}-700 text-white py-3 rounded-2xl font-bold transition-all hover:scale-105 transform shadow-lg">
            <i class="fas fa-rocket mr-2"></i>Launch Experiment
          </button>
        </div>
      `).join('');
    }

    function populateAssignments() {
      const assignmentsList = document.getElementById('assignmentsList');
      if (assignments.length === 0) {
        assignmentsList.innerHTML = `
          <div class="text-center py-12 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-3xl border border-blue-200/50 dark:border-blue-700/50">
            <div class="text-6xl mb-4">📝</div>
            <h3 class="text-xl font-bold mb-2">No assignments yet!</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Create your first assignment reminders to get started</p>
            <button onclick="createAssignment()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-2xl font-bold hover:scale-105 transform transition-all shadow-lg">
              <i class="fas fa-plus mr-2"></i>Create Assignment
            </button>
          </div>
        `;
        return;
      }

      assignmentsList.innerHTML = assignments.map(assignment => `
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 hover:shadow-2xl transition-all transform hover:scale-102">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <h3 class="font-bold text-xl mb-2 bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">${assignment.title}</h3>
              <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 leading-relaxed">${assignment.description}</p>
              <div class="flex items-center space-x-4 text-sm text-gray-500">
                <span><i class="fas fa-calendar mr-1 text-primary"></i>Due: ${formatDate(assignment.dueDate)}</span>
                <span><i class="fas fa-clock mr-1 text-secondary"></i>${assignment.estimatedTime || 'Not set'}</span>
                <span><i class="fas fa-book mr-1 text-success"></i>${assignment.subject}</span>
              </div>
            </div>
            <div class="flex flex-col items-end space-y-2">
              <span class="px-3 py-1 text-xs font-bold rounded-full ${getStatusColor(assignment.status)}">
                ${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1).replace('-', ' ')}
              </span>
              <span class="px-2 py-1 text-xs rounded-full font-bold ${getPriorityColor(assignment.priority)}">
                ${assignment.priority.charAt(0).toUpperCase() + assignment.priority.slice(1)} Priority
              </span>
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="openAssignment(${assignment.id})" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-2xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-play mr-2"></i>${assignment.status === 'pending' ? 'Start Assignment' : 'Continue Work'}
            </button>
            <button onclick="deleteAssignment(${assignment.id})" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-2xl transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function populateNotes() {
      const notesGrid = document.getElementById('notesGrid');
      if (notes.length === 0) {
        notesGrid.innerHTML = `
          <div class="text-center py-12 col-span-full bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-3xl border border-green-200/50 dark:border-green-700/50">
            <div class="text-6xl mb-4">📝</div>
            <h3 class="text-xl font-bold mb-2">No notes yet!</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Create your first note to get started</p>
            <button onclick="createNote()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-2xl font-bold hover:scale-105 transform transition-all shadow-lg">
              <i class="fas fa-plus mr-2"></i>Create Note
            </button>
          </div>
        `;
        return;
      }

      notesGrid.innerHTML = notes.map(note => `
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105" onclick="openNote(${note.id})">
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs px-3 py-1 rounded-full bg-gradient-to-r from-${getCategoryColor(note.category)}-100 to-${getCategoryColor(note.category)}-200 dark:from-${getCategoryColor(note.category)}-900/30 dark:to-${getCategoryColor(note.category)}-800/30 text-${getCategoryColor(note.category)}-700 dark:text-${getCategoryColor(note.category)}-300 font-bold">
              ${note.category}
            </span>
            <span class="text-xs text-gray-500">${formatDate(note.lastModified)}</span>
          </div>
          <h3 class="font-bold text-lg mb-2 bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">${note.title}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-3 leading-relaxed">${note.content.substring(0, 100)}...</p>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500 font-medium">${note.subject}</span>
            <div class="flex flex-wrap gap-1">
              ${note.tags.slice(0, 2).map(tag => `<span class="text-xs px-2 py-1 bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 text-blue-700 dark:text-blue-300 rounded-full">${tag}</span>`).join('')}
            </div>
          </div>
        </div>
      `).join('');
    }

    function populateResources() {
      const resourcesGrid = document.getElementById('resourcesGrid');

      // Default resources if none exist
      if (resources.length === 0) {
        resources = [
          {
            id: 1,
            title: "🌊 Introduction to Quantum Physics",
            type: "video",
            category: "science",
            url: "https://www.youtube.com/embed/J3xLuZNKhlY",
            description: "Comprehensive introduction to quantum mechanics principles and applications",
            duration: "25:30",
            difficulty: "Intermediate"
          },
          {
            id: 2,
            title: "🐍 Complete Python Programming",
            type: "video",
            category: "technology",
            url: "https://www.youtube.com/embed/rfscVS0vtbw",
            description: "Complete Python programming course for beginners to advanced",
            duration: "4:26:52",
            difficulty: "Beginner"
          },
          {
            id: 3,
            title: "🚀 NASA Engineering Design Process",
            type: "article",
            category: "engineering",
            url: "https://www.nasa.gov/audience/foreducators/best-practices/design_process",
            description: "NASA's comprehensive guide to the engineering design process",
            difficulty: "Intermediate"
          },
          {
            id: 4,
            title: "🧬 CRISPR Gene Editing Explained",
            type: "video",
            category: "science",
            url: "https://www.youtube.com/embed/jAhjPd4uNFY",
            description: "How CRISPR works and its revolutionary applications in biotechnology",
            duration: "18:45",
            difficulty: "Advanced"
          }
        ];
      }

      resourcesGrid.innerHTML = resources.map(resource => `
        <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-white/20 hover:shadow-2xl transition-all cursor-pointer transform hover:scale-105" 
             data-category="${resource.category}" data-type="${resource.type}" onclick="openResource(${resource.id})">
          <div class="flex items-center justify-between mb-4">
            <div class="w-16 h-16 bg-gradient-to-r from-${getCategoryColor(resource.category)}-400 to-${getCategoryColor(resource.category)}-600 rounded-2xl flex items-center justify-center shadow-lg">
              <i class="${getResourceIcon(resource.type)} text-white text-2xl"></i>
            </div>
            <div class="text-right">
              <span class="text-xs px-2 py-1 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 text-gray-600 dark:text-gray-400 font-bold">
                ${resource.type}
              </span>
              ${resource.difficulty ? `<div class="text-xs px-2 py-1 rounded-full ${getDifficultyColor(resource.difficulty)} font-bold mt-1">${resource.difficulty}</div>` : ''}
            </div>
          </div>
          <h3 class="font-bold text-lg mb-2 bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">${resource.title}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">${resource.description}</p>
          ${resource.duration ? `<p class="text-xs text-gray-500 mb-3 flex items-center"><i class="fas fa-clock mr-1 text-primary"></i>${resource.duration}</p>` : ''}
          <button onclick="event.stopPropagation(); openResource(${resource.id})" class="w-full bg-gradient-to-r from-${getCategoryColor(resource.category)}-500 to-${getCategoryColor(resource.category)}-600 hover:from-${getCategoryColor(resource.category)}-600 hover:to-${getCategoryColor(resource.category)}-700 text-white py-3 rounded-2xl font-bold transition-all hover:scale-105 transform shadow-lg">
            <i class="fas fa-external-link-alt mr-2"></i>Access Resource
          </button>
        </div>
      `).join('');
    }

    function populateGradesTable() {
      const gradesTable = document.getElementById('gradesTable');
      gradesTable.innerHTML = grades.map(grade => `
        <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 dark:hover:from-blue-900/10 dark:hover:to-purple-900/10 transition-all">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-gradient-to-r from-${getSubjectColor(grade.subject)}-400 to-${getSubjectColor(grade.subject)}-600 rounded-2xl flex items-center justify-center mr-3 shadow-lg">
                <i class="${getSubjectIcon(grade.subject)} text-white"></i>
              </div>
              <div>
                <div class="text-sm font-bold">${grade.subject}</div>
                <div class="text-xs text-gray-500">Core Subject</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-3 py-1 text-sm font-bold rounded-full ${getGradeColor(grade.grade)}">
              ${grade.grade}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${grade.credits}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${grade.instructor}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-20 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                <div class="bg-gradient-to-r from-${getSubjectColor(grade.subject)}-400 to-${getSubjectColor(grade.subject)}-600 h-2 rounded-full transition-all duration-1000" style="width: ${grade.progress}%"></div>
              </div>
              <span class="text-xs font-bold">${grade.progress}%</span>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // ====================================
    // QUICK ACTIONS
    // ====================================

    function quickLaunchLab(category) {
      // Add visual feedback to the clicked button
      const clickedButton = event.target.closest('.quick-action-btn');
      if (clickedButton) {
        const originalContent = clickedButton.innerHTML;
        clickedButton.innerHTML = '<div class="loading-spinner mx-auto mb-2"></div><p class="text-sm font-bold">Loading...</p>';
        clickedButton.disabled = true;

        setTimeout(() => {
          clickedButton.innerHTML = originalContent;
          clickedButton.disabled = false;
        }, 1500);
      }

      // Navigate to experiments section
      showSection('labs');

      // Show notification about the selected category
      const categoryNames = {
        'chemistry': 'Chemistry Lab',
        'physics': 'Physics Simulations',
        'math': 'Math Tools',
        'ai': 'AI Helper'
      };

      const categoryName = categoryNames[category] || category;
      showNotification(`🚀 Launching ${categoryName}!`, 'success');

      // Scroll to top of experiments section
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 300);

      // Highlight relevant PhET simulations based on category
      setTimeout(() => {
        highlightRelevantSimulations(category);
      }, 500);
    }

    // Function to highlight relevant simulations
    function highlightRelevantSimulations(category) {
      // Remove any existing highlights
      document.querySelectorAll('.simulation-highlight').forEach(el => {
        el.classList.remove('simulation-highlight');
      });

      // Add highlight class based on category
      const simulationMap = {
        'chemistry': ['States of Matter'],
        'physics': ['Circuit Construction Kit', 'Forces & Motion', 'Energy Skate Park', 'Projectile Motion', 'Wave on a String'],
        'math': ['Projectile Motion'] // Math-related physics
      };

      const relevantSims = simulationMap[category] || [];
      relevantSims.forEach(simName => {
        const simElements = document.querySelectorAll(`h2:contains("${simName}")`);
        simElements.forEach(el => {
          const card = el.closest('.bg-white');
          if (card) {
            card.classList.add('simulation-highlight');
            card.style.boxShadow = '0 0 20px rgba(93, 92, 222, 0.5)';
            card.style.border = '2px solid #5D5CDE';
          }
        });
      });
    }

    // Quick launch calculator function
    function quickLaunchCalculator() {
      // Add visual feedback to the clicked button
      const clickedButton = event.target.closest('.quick-action-btn');
      if (clickedButton) {
        const originalContent = clickedButton.innerHTML;
        clickedButton.innerHTML = '<div class="loading-spinner mx-auto mb-2"></div><p class="text-sm font-bold">Loading...</p>';
        clickedButton.disabled = true;

        setTimeout(() => {
          clickedButton.innerHTML = originalContent;
          clickedButton.disabled = false;
        }, 1500);
      }

      // Navigate to calculator section
      showSection('calculator');

      // Show notification
      showNotification('🧮 Calculator launched!', 'success');

      // Scroll to top
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 300);
    }

    function openZapierEmbed() {
      showCustomModal('⚡ Zapier Automations - Student Success Hub', `
        <div class="space-y-6">
          <!-- Zapier Embed Header -->
          <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 p-6 rounded-2xl border border-orange-200/50 dark:border-orange-700/50">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-bolt text-white text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-orange-800 dark:text-orange-300">Academic Automation Hub</h3>
                <p class="text-sm text-orange-600 dark:text-orange-400">Connect your study tools and automate your academic workflow</p>
              </div>
            </div>
          </div>

          <!-- Quick Zap Templates -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-xl border border-blue-200/50 dark:border-blue-700/50 hover:shadow-lg transition-all cursor-pointer" onclick="createZapTemplate('calendar-reminders')">
              <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center">
                  <i class="fab fa-google text-white"></i>
                </div>
                <div>
                  <h4 class="font-bold text-blue-800 dark:text-blue-300">Google Calendar Reminders</h4>
                  <p class="text-xs text-blue-600 dark:text-blue-400">Auto-create study reminders</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Automatically create reminders 24h, 6h, and 1h before assignment due dates.</p>
              <div class="flex items-center text-xs text-blue-600 dark:text-blue-400">
                <i class="fas fa-clock mr-1"></i>Setup time: 2 minutes
              </div>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-xl border border-green-200/50 dark:border-green-700/50 hover:shadow-lg transition-all cursor-pointer" onclick="createZapTemplate('grade-notifications')">
              <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                  <i class="fas fa-envelope text-white"></i>
                </div>
                <div>
                  <h4 class="font-bold text-green-800 dark:text-green-300">Grade Email Alerts</h4>
                  <p class="text-xs text-green-600 dark:text-green-400">Instant grade notifications</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Get email/SMS notifications when new grades are posted in your LMS.</p>
              <div class="flex items-center text-xs text-green-600 dark:text-green-400">
                <i class="fas fa-clock mr-1"></i>Setup time: 3 minutes
              </div>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-4 rounded-xl border border-purple-200/50 dark:border-purple-700/50 hover:shadow-lg transition-all cursor-pointer" onclick="createZapTemplate('slack-study-group')">
              <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                  <i class="fab fa-slack text-white"></i>
                </div>
                <div>
                  <h4 class="font-bold text-purple-800 dark:text-purple-300">Slack Study Coordination</h4>
                  <p class="text-xs text-purple-600 dark:text-purple-400">Automate group communications</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Auto-post assignment updates and exam reminders to your study group Slack.</p>
              <div class="flex items-center text-xs text-purple-600 dark:text-purple-400">
                <i class="fas fa-clock mr-1"></i>Setup time: 5 minutes
              </div>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 p-4 rounded-xl border border-yellow-200/50 dark:border-yellow-700/50 hover:shadow-lg transition-all cursor-pointer" onclick="createZapTemplate('study-analytics')">
              <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center">
                  <i class="fas fa-chart-bar text-white"></i>
                </div>
                <div>
                  <h4 class="font-bold text-yellow-800 dark:text-yellow-300">Study Analytics Tracker</h4>
                  <p class="text-xs text-yellow-600 dark:text-yellow-400">Auto-log study sessions</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Automatically track study time and create performance reports in Google Sheets.</p>
              <div class="flex items-center text-xs text-yellow-600 dark:text-yellow-400">
                <i class="fas fa-clock mr-1"></i>Setup time: 4 minutes
              </div>
            </div>
          </div>

          <!-- Custom Zap Builder -->
          <div class="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-gray-200/50 dark:border-gray-700/50">
            <h4 class="font-bold text-lg mb-4 flex items-center">
              <span class="w-8 h-8 bg-gradient-to-r from-gray-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-cogs text-white text-sm"></i>
              </span>
              🔧 Custom Automation Builder
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Create your own academic automation workflow:</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-bold mb-2">Trigger App:</label>
                <select id="triggerApp" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                  <option value="">Select trigger...</option>
                  <option value="google-calendar">Google Calendar</option>
                  <option value="canvas">Canvas LMS</option>
                  <option value="google-sheets">Google Sheets</option>
                  <option value="email">Email (Gmail)</option>
                  <option value="webhook">Webhook</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">Action App:</label>
                <select id="actionApp" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                  <option value="">Select action...</option>
                  <option value="slack">Slack</option>
                  <option value="email">Email</option>
                  <option value="sms">SMS (Twilio)</option>
                  <option value="google-sheets">Google Sheets</option>
                  <option value="trello">Trello</option>
                  <option value="notion">Notion</option>
                </select>
              </div>
              <div class="flex items-end">
                <button onclick="buildCustomZap()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white py-2 px-4 rounded-lg font-bold transition-all hover:scale-105 transform shadow-lg text-sm">
                  <i class="fas fa-magic mr-2"></i>Build Zap
                </button>
              </div>
            </div>
          </div>

          <!-- Zapier Partner Embed -->
          <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg">
            <div class="flex items-center justify-between mb-4">
              <h4 class="font-bold text-lg">⚡ Zapier Integration Hub</h4>
              <a href="https://zapier.com/apps/categories/education" target="_blank" class="text-orange-600 hover:text-orange-700 text-sm font-medium">
                View all education apps →
              </a>
            </div>
            
            <!-- Simulated Zapier Embed Interface -->
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center bg-gray-50 dark:bg-gray-900/50">
              <div class="mb-4">
                <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl mx-auto flex items-center justify-center mb-3">
                  <i class="fas fa-bolt text-white text-2xl"></i>
                </div>
                <h5 class="font-bold text-lg mb-2">Connect Your Academic Apps</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Build workflows that connect your favorite study tools</p>
              </div>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer" onclick="connectApp('google')">
                  <i class="fab fa-google text-2xl mb-2 text-red-500"></i>
                  <p class="text-xs font-bold">Google Workspace</p>
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer" onclick="connectApp('slack')">
                  <i class="fab fa-slack text-2xl mb-2 text-purple-500"></i>
                  <p class="text-xs font-bold">Slack</p>
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer" onclick="connectApp('trello')">
                  <i class="fab fa-trello text-2xl mb-2 text-blue-500"></i>
                  <p class="text-xs font-bold">Trello</p>
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer" onclick="connectApp('canvas')">
                  <i class="fas fa-graduation-cap text-2xl mb-2 text-green-500"></i>
                  <p class="text-xs font-bold">Canvas LMS</p>
                </div>
              </div>
              
              <button onclick="openZapierDashboard()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white px-6 py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                <i class="fas fa-external-link-alt mr-2"></i>Open Zapier Dashboard
              </button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-3">
            <button onclick="viewMyZaps()" class="flex-1 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-list mr-2"></i>My Automations
            </button>
            <button onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-times mr-2"></i>Close
            </button>
          </div>
        </div>
      `);
    }

    function quickAutomation(type) {
      openZapierAI();
      let message = '';
      switch (type) {
        case 'assignment':
          message = 'Create an automation to remind me about assignments';
          break;
        case 'calendar':
          message = 'Set up calendar sync and automated reminders';
          break;
        case 'email':
          message = 'Help me automate email notifications for my studies';
          break;
      }

      setTimeout(() => {
        document.getElementById('aiInput').value = message;
        sendZapierAIMessage();
      }, 500);
    }

    function quickAIHelp(topic) {
      openZapierAI();
      let message = '';
      switch (topic) {
        case 'homework':
          message = 'I need help with my homework assignment';
          break;
        case 'experiment':
          message = 'Can you help me design an experiment?';
          break;
        case 'math':
          message = 'I need help solving a math problem';
          break;
      }

      setTimeout(() => {
        document.getElementById('aiInput').value = message;
        sendZapierAIMessage();
      }, 500);
    }

    // ====================================
    // LAB FUNCTIONS
    // ====================================

    function openLab(labId) {
      const lab = labs.find(l => l.id === labId);
      if (!lab) return;

      document.getElementById('labModalTitle').innerHTML = `${lab.icon} ${lab.title}`;
      document.getElementById('labModalContent').innerHTML = createAdvancedLabSimulation(lab);
      document.getElementById('labModal').classList.remove('hidden');

      addActivityFeed(`🧪 Started ${lab.title}`);
    }

    function createAdvancedLabSimulation(lab) {
      switch (lab.id) {
        case 1: // Chemistry
          return createAdvancedChemistryLab(lab);
        case 2: // Quantum Physics
          return createAdvancedQuantumLab(lab);
        case 3: // CRISPR
          return createAdvancedBiotechLab(lab);
        case 4: // Neural Networks
          return createAdvancedNeuralNetworkLab(lab);
        case 5: // Engineering
          return createAdvancedEngineeringLab(lab);
        case 6: // Statistics
          return createAdvancedStatsLab(lab);
        case 7: // Digital Art
          return createAdvancedArtLab(lab);
        case 8: // Microscopy
          return createAdvancedMicroscopyLab(lab);
        default:
          return createGenericAdvancedLab(lab);
      }
    }

    function createAdvancedChemistryLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-vial text-white text-sm"></i>
                </span>
                🧪 Advanced Chemistry Lab
              </h4>
              
              <div class="grid grid-cols-3 gap-4 mb-6">
                <!-- Acid Beaker -->
                <div class="text-center">
                  <div class="relative w-20 h-24 mx-auto mb-2">
                    <div class="w-20 h-24 bg-gradient-to-t from-red-200 to-transparent border-4 border-red-300 rounded-b-3xl cursor-pointer hover:scale-105 transition-all shadow-lg" onclick="addChemical('acid')">
                      <div id="acidLevel" class="w-full bg-gradient-to-t from-red-500 to-red-400 rounded-b-2xl transition-all duration-1000" style="height: 0%"></div>
                      <div class="absolute inset-0 flex items-center justify-center text-red-700 font-bold text-xs">HCl</div>
                    </div>
                    <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-6 bg-red-300 rounded-t-lg border-2 border-red-400"></div>
                  </div>
                  <p class="text-xs font-bold">Hydrochloric Acid</p>
                  <p class="text-xs text-gray-500">Click to add</p>
                </div>
                
                <!-- Base Beaker -->
                <div class="text-center">
                  <div class="relative w-20 h-24 mx-auto mb-2">
                    <div class="w-20 h-24 bg-gradient-to-t from-blue-200 to-transparent border-4 border-blue-300 rounded-b-3xl cursor-pointer hover:scale-105 transition-all shadow-lg" onclick="addChemical('base')">
                      <div id="baseLevel" class="w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-b-2xl transition-all duration-1000" style="height: 0%"></div>
                      <div class="absolute inset-0 flex items-center justify-center text-blue-700 font-bold text-xs">NaOH</div>
                    </div>
                    <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-6 bg-blue-300 rounded-t-lg border-2 border-blue-400"></div>
                  </div>
                  <p class="text-xs font-bold">Sodium Hydroxide</p>
                  <p class="text-xs text-gray-500">Click to add</p>
                </div>
                
                <!-- Result Beaker -->
                <div class="text-center">
                  <div class="relative w-20 h-24 mx-auto mb-2">
                    <div class="w-20 h-24 bg-gradient-to-t from-green-200 to-transparent border-4 border-green-300 rounded-b-3xl shadow-lg">
                      <div id="resultLevel" class="w-full bg-gradient-to-t from-green-500 to-green-400 rounded-b-2xl transition-all duration-1000" style="height: 0%"></div>
                      <div class="absolute inset-0 flex items-center justify-center text-green-700 font-bold text-xs">H₂O + NaCl</div>
                    </div>
                    <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-6 bg-green-300 rounded-t-lg border-2 border-green-400"></div>
                  </div>
                  <p class="text-xs font-bold">Reaction Product</p>
                  <p class="text-xs text-gray-500">Water + Salt</p>
                </div>
              </div>
              
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-bold mb-1">Temperature (°C):</label>
                    <input type="range" id="tempSlider" min="0" max="100" value="25" class="w-full" onchange="updateTemperature()">
                    <span id="tempDisplay" class="text-sm">25°C</span>
                  </div>
                  <div>
                    <label class="block text-sm font-bold mb-1">Pressure (atm):</label>
                    <input type="range" id="pressureSlider" min="0.5" max="3" step="0.1" value="1" class="w-full" onchange="updatePressure()">
                    <span id="pressureDisplay" class="text-sm">1.0 atm</span>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="mixChemicals()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-4 py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-flask mr-2"></i>Mix & React
                  </button>
                  <button onclick="resetChemistryLab()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-redo mr-2"></i>Reset Lab
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-chart-line text-white text-sm"></i>
                </span>
                📊 Real-time Analysis
              </h4>
              <div id="chemistryResults" class="space-y-3 max-h-48 overflow-y-auto">
                <p class="text-gray-600 dark:text-gray-400 text-sm">Click chemicals to start experimenting! Watch real-time molecular interactions.</p>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 p-6 rounded-2xl border border-yellow-200/50 dark:border-yellow-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-lightbulb text-white text-sm"></i>
                </span>
                🎯 Learning Objectives
              </h4>
              <ul class="text-sm space-y-2">
                ${lab.features.map(feature => `<li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>${feature}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedQuantumLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-6 rounded-2xl border border-purple-200/50 dark:border-purple-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-atom text-white text-sm"></i>
                </span>
                ⚛️ Quantum State Manipulator
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Number of Qubits:</label>
                  <input type="range" id="qubitCount" min="1" max="4" value="2" class="w-full" onchange="updateQuantumSystem()">
                  <span id="qubitDisplay" class="text-sm font-bold">2 qubits</span>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Initial Quantum State:</label>
                  <select id="initialState" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="updateQuantumSystem()">
                    <option value="00">|00⟩ (Ground State)</option>
                    <option value="01">|01⟩</option>
                    <option value="10">|10⟩</option>
                    <option value="11">|11⟩ (Excited State)</option>
                    <option value="superposition">|+⟩ ⊗ |+⟩ (Superposition)</option>
                    <option value="bell">Bell State (Entangled)</option>
                  </select>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                  <button onclick="applyQuantumGate('H')" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    H<br><span class="text-xs">Hadamard</span>
                  </button>
                  <button onclick="applyQuantumGate('X')" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    X<br><span class="text-xs">Pauli-X</span>
                  </button>
                  <button onclick="applyQuantumGate('Y')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    Y<br><span class="text-xs">Pauli-Y</span>
                  </button>
                  <button onclick="applyQuantumGate('Z')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    Z<br><span class="text-xs">Pauli-Z</span>
                  </button>
                  <button onclick="applyQuantumGate('CNOT')" class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    CNOT<br><span class="text-xs">Control</span>
                  </button>
                  <button onclick="measureQuantumState()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl text-sm font-bold transition-all hover:scale-105 transform shadow-lg">
                    📏<br><span class="text-xs">Measure</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-wave-square text-white text-sm"></i>
                </span>
                📊 Quantum State Vector
              </h4>
              <div id="stateVector" class="font-mono text-sm space-y-1 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                <div class="flex justify-between"><span>|00⟩:</span><span class="text-blue-600 font-bold">1.000 + 0.000i</span></div>
                <div class="flex justify-between"><span>|01⟩:</span><span>0.000 + 0.000i</span></div>
                <div class="flex justify-between"><span>|10⟩:</span><span>0.000 + 0.000i</span></div>
                <div class="flex justify-between"><span>|11⟩:</span><span>0.000 + 0.000i</span></div>
              </div>
            </div>
            
            <div id="quantumResults" class="bg-gradient-to-r from-green-50 to-teal-50 dark:from-green-900/20 dark:to-teal-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-microscope text-white text-sm"></i>
                </span>
                🔬 Quantum Measurements
              </h4>
              <div class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Apply quantum gates and observe state evolution. Click measure to collapse the wave function!</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedBiotechLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-dna text-white text-sm"></i>
                </span>
                🧬 CRISPR Design Studio
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Target DNA Sequence:</label>
                  <textarea id="targetSequence" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 font-mono" placeholder="Enter DNA sequence (A, T, G, C)">ATGGCGATCGTAGCTACGTCAAGGCCTTAAGC</textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-bold mb-2">Guide RNA Length:</label>
                    <select id="grnaLength" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                      <option value="17">17 nucleotides</option>
                      <option value="18">18 nucleotides</option>
                      <option value="19">19 nucleotides</option>
                      <option value="20" selected>20 nucleotides</option>
                      <option value="21">21 nucleotides</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-bold mb-2">PAM Sequence:</label>
                    <select id="pamSequence" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                      <option value="NGG" selected>NGG (SpCas9)</option>
                      <option value="TTTN">TTTN (Cpf1)</option>
                      <option value="NGA">NGA (SpG)</option>
                    </select>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="designGuideRNA()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-dna mr-2"></i>Design gRNA
                  </button>
                  <button onclick="checkOffTargets()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-search mr-2"></i>Check Off-targets
                  </button>
                </div>
                
                <button onclick="simulateCRISPREditing()" class="w-full bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                  <i class="fas fa-cut mr-2"></i>Simulate CRISPR Editing
                </button>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-bullseye text-white text-sm"></i>
                </span>
                🎯 Guide RNA Candidates
              </h4>
              <div id="grnaResults" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-sm text-gray-500">Design guide RNAs to see candidates with efficiency scores</p>
              </div>
            </div>
            
            <div id="biotechResults" class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-6 rounded-2xl border border-purple-200/50 dark:border-purple-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-microscope text-white text-sm"></i>
                </span>
                🔬 Editing Results
              </h4>
              <div class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Design your guide RNA and simulate precise gene editing. Advanced algorithms predict editing efficiency!</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedNeuralNetworkLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-indigo-200/50 dark:border-indigo-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-brain text-white text-sm"></i>
                </span>
                🤖 Neural Network Architect
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Network Architecture:</label>
                  <select id="networkType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="updateNetworkArchitecture()">
                    <option value="mlp">Multi-Layer Perceptron</option>
                    <option value="cnn">Convolutional Neural Network</option>
                    <option value="rnn">Recurrent Neural Network</option>
                    <option value="transformer">Transformer</option>
                  </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-bold mb-2">Hidden Layers:</label>
                    <input type="range" id="hiddenLayers" min="1" max="5" value="2" class="w-full" onchange="updateNetworkParams()">
                    <span id="layersDisplay" class="text-sm">2 layers</span>
                  </div>
                  <div>
                    <label class="block text-sm font-bold mb-2">Neurons per Layer:</label>
                    <input type="range" id="neuronsPerLayer" min="8" max="128" step="8" value="64" class="w-full" onchange="updateNetworkParams()">
                    <span id="neuronsDisplay" class="text-sm">64 neurons</span>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-bold mb-2">Learning Rate:</label>
                    <select id="learningRate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                      <option value="0.001" selected>0.001</option>
                      <option value="0.01">0.01</option>
                      <option value="0.1">0.1</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-bold mb-2">Activation:</label>
                    <select id="activation" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                      <option value="relu" selected>ReLU</option>
                      <option value="sigmoid">Sigmoid</option>
                      <option value="tanh">Tanh</option>
                    </select>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="trainNetwork()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-play mr-2"></i>Train Model
                  </button>
                  <button onclick="testNetwork()" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-check mr-2"></i>Test Model
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-chart-line text-white text-sm"></i>
                </span>
                📈 Training Progress
              </h4>
              <div id="trainingProgress" class="space-y-3">
                <div class="flex justify-between text-sm">
                  <span>Epoch:</span><span id="currentEpoch">0/100</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Accuracy:</span><span id="accuracy">0%</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Loss:</span><span id="loss">--</span>
                </div>
              </div>
            </div>
            
            <div id="networkResults" class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-6 rounded-2xl border border-purple-200/50 dark:border-purple-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-robot text-white text-sm"></i>
                </span>
                🧠 Model Performance
              </h4>
              <div class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Configure your neural network architecture and watch it learn! Real-time training visualization included.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Lab interaction functions with enhanced features
    function addChemical(type) {
      if (type === 'acid') {
        chemicalState.acid = Math.min(chemicalState.acid + 20, 100);
        document.getElementById('acidLevel').style.height = chemicalState.acid + '%';
        addChemistryResult(`🔴 Added HCl (${chemicalState.acid}%) - Solution becoming more acidic`);
      } else if (type === 'base') {
        chemicalState.base = Math.min(chemicalState.base + 20, 100);
        document.getElementById('baseLevel').style.height = chemicalState.base + '%';
        addChemistryResult(`🔵 Added NaOH (${chemicalState.base}%) - Solution becoming more basic`);
      }

      updateChemicalProperties();
    }

    function updateTemperature() {
      chemicalState.temperature = document.getElementById('tempSlider').value;
      document.getElementById('tempDisplay').textContent = chemicalState.temperature + '°C';
      addChemistryResult(`🌡️ Temperature adjusted to ${chemicalState.temperature}°C`);
    }

    function updatePressure() {
      chemicalState.pressure = document.getElementById('pressureSlider').value;
      document.getElementById('pressureDisplay').textContent = chemicalState.pressure + ' atm';
      addChemistryResult(`📊 Pressure adjusted to ${chemicalState.pressure} atm`);
    }

    function updateChemicalProperties() {
      const totalConcentration = chemicalState.acid + chemicalState.base;
      if (totalConcentration > 0) {
        const ph = 7 + ((chemicalState.base - chemicalState.acid) / totalConcentration) * 7;
        addChemistryResult(`📊 Current pH: ${ph.toFixed(2)} (${ph < 7 ? 'Acidic' : ph > 7 ? 'Basic' : 'Neutral'})`);
      }
    }

    function mixChemicals() {
      const total = chemicalState.acid + chemicalState.base;
      if (total === 0) {
        addChemistryResult('⚠️ Add chemicals before mixing!');
        return;
      }

      const neutralization = Math.min(chemicalState.acid, chemicalState.base);
      const resultHeight = (neutralization / 50) * 100;

      // Animate the mixing process
      const resultBeaker = document.getElementById('resultLevel');
      resultBeaker.style.height = resultHeight + '%';

      // Enhanced reaction analysis
      let reaction = '';
      let ph = 7;
      let products = [];

      if (chemicalState.acid > chemicalState.base) {
        reaction = 'Excess acid - Acidic solution';
        ph = 7 - (chemicalState.acid - chemicalState.base) / 20;
        products = ['H₂O', 'NaCl', 'HCl (excess)'];
      } else if (chemicalState.base > chemicalState.acid) {
        reaction = 'Excess base - Basic solution';
        ph = 7 + (chemicalState.base - chemicalState.acid) / 20;
        products = ['H₂O', 'NaCl', 'NaOH (excess)'];
      } else {
        reaction = 'Complete neutralization - Neutral solution';
        products = ['H₂O', 'NaCl'];
      }

      addChemistryResult('🧪 REACTION COMPLETE!');
      addChemistryResult(`⚗️ Reaction: HCl + NaOH → ${products.join(' + ')}`);
      addChemistryResult(`📊 Final pH: ${ph.toFixed(2)}`);
      addChemistryResult(`🌡️ Temperature effect: ${calculateTemperatureEffect()}`);
      addChemistryResult(`🎯 Reaction efficiency: ${calculateEfficiency()}%`);

      // Award points and complete lab
      setTimeout(() => {
        completeLab('Advanced Chemistry Lab');
      }, 2000);
    }

    function calculateTemperatureEffect() {
      if (chemicalState.temperature > 25) {
        return `Increased reaction rate (+${((chemicalState.temperature - 25) * 2).toFixed(1)}%)`;
      } else if (chemicalState.temperature < 25) {
        return `Decreased reaction rate (${((chemicalState.temperature - 25) * 2).toFixed(1)}%)`;
      }
      return 'Standard reaction rate';
    }

    function calculateEfficiency() {
      const tempFactor = Math.max(0.5, 1 + (chemicalState.temperature - 25) * 0.01);
      const pressureFactor = Math.max(0.5, chemicalState.pressure);
      return Math.min(100, (tempFactor * pressureFactor * 85)).toFixed(1);
    }

    function resetChemistryLab() {
      chemicalState = { acid: 0, base: 0, temperature: 25, pressure: 1 };
      document.getElementById('acidLevel').style.height = '0%';
      document.getElementById('baseLevel').style.height = '0%';
      document.getElementById('resultLevel').style.height = '0%';
      document.getElementById('tempSlider').value = 25;
      document.getElementById('pressureSlider').value = 1;
      document.getElementById('tempDisplay').textContent = '25°C';
      document.getElementById('pressureDisplay').textContent = '1.0 atm';
      document.getElementById('chemistryResults').innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-sm">Click chemicals to start experimenting! Watch real-time molecular interactions.</p>';
      showToast('🔄 Chemistry lab reset', 'info');
    }

    function addChemistryResult(message) {
      const results = document.getElementById('chemistryResults');
      const timestamp = new Date().toLocaleTimeString();

      const div = document.createElement('div');
      div.className = 'flex items-start space-x-2 p-3 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 shadow-sm';
      div.innerHTML = `
        <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
        <div class="flex-1">
          <p class="text-sm font-medium">${message}</p>
          <p class="text-xs text-gray-500">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = results.querySelector('.text-gray-600');
      if (placeholder && placeholder.textContent.includes('Click chemicals')) {
        placeholder.remove();
      }

      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    // Quantum lab functions
    function updateQuantumSystem() {
      const qubitCount = parseInt(document.getElementById('qubitCount').value);
      const initialState = document.getElementById('initialState').value;

      document.getElementById('qubitDisplay').textContent = qubitCount + ' qubits';

      quantumState.qubits = qubitCount;
      const numStates = Math.pow(2, qubitCount);
      quantumState.amplitudes = new Array(numStates).fill(0);
      quantumState.gates = [];

      // Initialize state based on selection
      switch (initialState) {
        case 'superposition':
          const amplitude = 1 / Math.sqrt(numStates);
          quantumState.amplitudes = new Array(numStates).fill(amplitude);
          break;
        case 'bell':
          if (qubitCount >= 2) {
            quantumState.amplitudes[0] = 1 / Math.sqrt(2);
            quantumState.amplitudes[3] = 1 / Math.sqrt(2);
          } else {
            quantumState.amplitudes[0] = 1;
          }
          break;
        default:
          const stateIndex = parseInt(initialState, 2);
          if (stateIndex < numStates) {
            quantumState.amplitudes[stateIndex] = 1;
          }
      }

      updateQuantumDisplay();
      addQuantumResult(`🔄 Initialized ${qubitCount}-qubit system in ${initialState} state`);
    }

    function applyQuantumGate(gate) {
      addQuantumResult(`⚡ Applied ${gate} gate to quantum system`);

      // Simplified gate operations for demonstration
      switch (gate) {
        case 'H': // Hadamard on first qubit
          if (quantumState.qubits >= 1) {
            const newAmplitudes = [...quantumState.amplitudes];
            for (let i = 0; i < quantumState.amplitudes.length; i += 2) {
              const a = quantumState.amplitudes[i];
              const b = quantumState.amplitudes[i + 1];
              newAmplitudes[i] = (a + b) / Math.sqrt(2);
              newAmplitudes[i + 1] = (a - b) / Math.sqrt(2);
            }
            quantumState.amplitudes = newAmplitudes;
          }
          break;
        case 'X': // Pauli-X on first qubit
          for (let i = 0; i < quantumState.amplitudes.length; i += 2) {
            [quantumState.amplitudes[i], quantumState.amplitudes[i + 1]] = [quantumState.amplitudes[i + 1], quantumState.amplitudes[i]];
          }
          break;
        case 'Y': // Pauli-Y (simplified)
          for (let i = 0; i < quantumState.amplitudes.length; i += 2) {
            [quantumState.amplitudes[i], quantumState.amplitudes[i + 1]] = [-quantumState.amplitudes[i + 1], quantumState.amplitudes[i]];
          }
          break;
        case 'Z': // Pauli-Z on first qubit
          for (let i = 1; i < quantumState.amplitudes.length; i += 2) {
            quantumState.amplitudes[i] *= -1;
          }
          break;
        case 'CNOT': // Simplified CNOT
          if (quantumState.qubits >= 2) {
            // Basic CNOT implementation
            const newAmplitudes = [...quantumState.amplitudes];
            for (let i = 0; i < quantumState.amplitudes.length; i++) {
              const binary = i.toString(2).padStart(quantumState.qubits, '0');
              if (binary[0] === '1') {
                const flipped = binary[0] + (binary[1] === '0' ? '1' : '0') + binary.slice(2);
                const newIndex = parseInt(flipped, 2);
                newAmplitudes[newIndex] = quantumState.amplitudes[i];
                newAmplitudes[i] = quantumState.amplitudes[newIndex];
              }
            }
            quantumState.amplitudes = newAmplitudes;
          }
          break;
      }

      quantumState.gates.push(gate);
      updateQuantumDisplay();

      // Calculate entanglement measure
      const entanglement = calculateEntanglement();
      if (entanglement > 0.5) {
        addQuantumResult(`🌐 High entanglement detected! (${(entanglement * 100).toFixed(1)}%)`);
      }
    }

    function calculateEntanglement() {
      // Simplified entanglement measure
      let maxAmplitude = Math.max(...quantumState.amplitudes.map(Math.abs));
      return 1 - maxAmplitude;
    }

    function measureQuantumState() {
      const probabilities = quantumState.amplitudes.map(amp => amp * amp);
      const random = Math.random();
      let cumulativeProb = 0;
      let measuredState = 0;

      for (let i = 0; i < probabilities.length; i++) {
        cumulativeProb += probabilities[i];
        if (random <= cumulativeProb) {
          measuredState = i;
          break;
        }
      }

      // Collapse to measured state
      quantumState.amplitudes = new Array(quantumState.amplitudes.length).fill(0);
      quantumState.amplitudes[measuredState] = 1;

      updateQuantumDisplay();

      const binaryState = measuredState.toString(2).padStart(quantumState.qubits, '0');
      addQuantumResult(`📏 Wave function collapsed! Measured: |${binaryState}⟩`);
      addQuantumResult(`🎯 Measurement probability was: ${(probabilities[measuredState] * 100).toFixed(1)}%`);

      setTimeout(() => completeLab('Quantum Mechanics Simulator'), 1500);
    }

    function updateQuantumDisplay() {
      const stateVector = document.getElementById('stateVector');

      let stateHTML = '';
      for (let i = 0; i < quantumState.amplitudes.length; i++) {
        const state = i.toString(2).padStart(quantumState.qubits, '0');
        const amplitude = quantumState.amplitudes[i];
        const probability = amplitude * amplitude * 100;
        const color = probability > 50 ? 'text-blue-600 font-bold' : probability > 25 ? 'text-blue-500' : '';
        stateHTML += `
          <div class="flex justify-between ${color}">
            <span>|${state}⟩:</span>
            <span>${amplitude.toFixed(3)} (${probability.toFixed(1)}%)</span>
          </div>
        `;
      }

      stateVector.innerHTML = stateHTML;
    }

    function addQuantumResult(message) {
      const results = document.getElementById('quantumResults');
      const timestamp = new Date().toLocaleTimeString();

      const div = document.createElement('div');
      div.className = 'flex items-start space-x-2 p-3 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-700 shadow-sm';
      div.innerHTML = `
        <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>
        <div class="flex-1">
          <p class="text-sm font-medium">${message}</p>
          <p class="text-xs text-gray-500">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = results.querySelector('.text-gray-400');
      if (placeholder && placeholder.textContent.includes('Apply quantum')) {
        placeholder.remove();
      }

      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    // CRISPR lab functions
    function designGuideRNA() {
      const sequence = document.getElementById('targetSequence').value.toUpperCase().replace(/[^ATGC]/g, '');
      const length = parseInt(document.getElementById('grnaLength').value);
      const pam = document.getElementById('pamSequence').value;

      if (sequence.length < length) {
        showToast('DNA sequence too short for selected gRNA length', 'error');
        return;
      }

      const grnaResults = document.getElementById('grnaResults');
      grnaResults.innerHTML = '<p class="text-sm font-bold mb-3">🎯 Guide RNA Candidates:</p>';

      let bestScore = 0;
      let bestRNA = '';

      for (let i = 0; i <= sequence.length - length - 3; i++) {
        const grna = sequence.substr(i, length);
        const pamSite = sequence.substr(i + length, 3);

        // Check PAM compatibility
        let pamMatch = false;
        if (pam === 'NGG' && pamSite.endsWith('GG')) pamMatch = true;
        if (pam === 'TTTN' && pamSite.startsWith('TTT')) pamMatch = true;
        if (pam === 'NGA' && pamSite.endsWith('GA')) pamMatch = true;

        if (pamMatch) {
          const gcContent = (grna.match(/[GC]/g) || []).length / length * 100;
          const score = Math.min(100, gcContent * 1.2 + Math.random() * 20 + (pamMatch ? 20 : 0));

          if (score > bestScore) {
            bestScore = score;
            bestRNA = grna;
          }

          const efficiency = score > 80 ? 'High' : score > 60 ? 'Medium' : 'Low';
          const colorClass = score > 80 ? 'bg-green-100 border-green-300' : score > 60 ? 'bg-yellow-100 border-yellow-300' : 'bg-red-100 border-red-300';

          grnaResults.innerHTML += `
            <div class="flex justify-between items-center p-3 ${colorClass} rounded-lg border mb-2">
              <div>
                <span class="font-mono text-sm font-bold">${grna}</span>
                <span class="text-xs text-gray-600 ml-2">PAM: ${pamSite}</span>
              </div>
              <div class="text-right">
                <div class="text-sm font-bold">${score.toFixed(1)}%</div>
                <div class="text-xs">${efficiency}</div>
              </div>
            </div>
          `;
        }
      }

      addBiotechResult(`🧬 Designed ${grnaResults.children.length - 1} guide RNA candidates`);
      addBiotechResult(`🏆 Best candidate: ${bestRNA} (${bestScore.toFixed(1)}% efficiency)`);

      if (bestScore > 80) {
        addBiotechResult(`✅ Excellent guide RNA found! Ready for editing.`);
      }
    }

    function checkOffTargets() {
      const numOffTargets = Math.floor(Math.random() * 8);
      const riskLevel = numOffTargets > 5 ? 'High' : numOffTargets > 2 ? 'Medium' : 'Low';

      addBiotechResult(`🔍 Off-target analysis complete`);
      addBiotechResult(`📊 Potential off-targets found: ${numOffTargets}`);
      addBiotechResult(`⚠️ Risk level: ${riskLevel}`);

      if (numOffTargets === 0) {
        addBiotechResult(`🎯 Perfect specificity! No off-targets detected.`);
      } else {
        addBiotechResult(`💡 Consider optimizing guide RNA design to reduce off-targets`);
      }
    }

    function simulateCRISPREditing() {
      const efficiency = 70 + Math.random() * 25;
      const cutSite = Math.floor(Math.random() * 20) + 10;

      addBiotechResult(`🔬 CRISPR-Cas9 editing simulation initiated`);
      addBiotechResult(`✂️ Double-strand break induced at position ${cutSite}`);
      addBiotechResult(`🧬 Predicted editing efficiency: ${efficiency.toFixed(1)}%`);

      if (efficiency > 90) {
        addBiotechResult(`🏆 Exceptional editing efficiency achieved!`);
      } else if (efficiency > 75) {
        addBiotechResult(`✅ Good editing efficiency for therapeutic applications`);
      }

      addBiotechResult(`📈 Homology-directed repair: ${(efficiency * 0.6).toFixed(1)}%`);
      addBiotechResult(`🔧 Non-homologous end joining: ${(efficiency * 0.4).toFixed(1)}%`);

      setTimeout(() => completeLab('CRISPR Gene Editing Lab'), 2500);
    }

    function addBiotechResult(message) {
      const results = document.getElementById('biotechResults');
      const timestamp = new Date().toLocaleTimeString();

      const div = document.createElement('div');
      div.className = 'flex items-start space-x-2 p-3 bg-white dark:bg-gray-800 rounded-lg border border-green-200 dark:border-green-700 shadow-sm mb-2';
      div.innerHTML = `
        <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
        <div class="flex-1">
          <p class="text-sm font-medium">${message}</p>
          <p class="text-xs text-gray-500">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = results.querySelector('.text-gray-400');
      if (placeholder && placeholder.textContent.includes('Design your guide')) {
        placeholder.remove();
      }

      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    // Neural Network functions
    function updateNetworkArchitecture() {
      const networkType = document.getElementById('networkType').value;
      addNetworkResult(`🏗️ Architecture changed to ${networkType.toUpperCase()}`);

      // Update parameter suggestions based on network type
      const suggestions = {
        'mlp': 'Good for tabular data and simple classification',
        'cnn': 'Optimal for image recognition and computer vision',
        'rnn': 'Perfect for sequential data and time series',
        'transformer': 'State-of-the-art for NLP and attention mechanisms'
      };

      addNetworkResult(`💡 ${suggestions[networkType]}`);
    }

    function updateNetworkParams() {
      const layers = document.getElementById('hiddenLayers').value;
      const neurons = document.getElementById('neuronsPerLayer').value;

      document.getElementById('layersDisplay').textContent = layers + ' layers';
      document.getElementById('neuronsDisplay').textContent = neurons + ' neurons';

      const totalParams = calculateNetworkParameters(layers, neurons);
      addNetworkResult(`📊 Network updated: ${layers} layers, ${neurons} neurons per layer`);
      addNetworkResult(`🔢 Total parameters: ${totalParams.toLocaleString()}`);
    }

    function calculateNetworkParameters(layers, neurons) {
      // Simplified parameter calculation
      const inputSize = 784; // Example: MNIST input size
      const outputSize = 10;  // Example: 10 classes

      let totalParams = inputSize * neurons; // Input to first hidden
      totalParams += (layers - 1) * neurons * neurons; // Hidden to hidden
      totalParams += neurons * outputSize; // Last hidden to output

      return totalParams;
    }

    function trainNetwork() {
      const learningRate = document.getElementById('learningRate').value;
      const activation = document.getElementById('activation').value;

      addNetworkResult(`🚀 Training started with learning rate ${learningRate} and ${activation} activation`);

      // Simulate training process
      let epoch = 0;
      const maxEpochs = 100;

      const trainingInterval = setInterval(() => {
        epoch++;
        const progress = (epoch / maxEpochs) * 100;
        const accuracy = Math.min(95, 60 + (epoch / maxEpochs) * 30 + Math.random() * 5);
        const loss = Math.max(0.01, 2.5 - (epoch / maxEpochs) * 2.4 + Math.random() * 0.1);

        document.getElementById('currentEpoch').textContent = `${epoch}/${maxEpochs}`;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('accuracy').textContent = accuracy.toFixed(1) + '%';
        document.getElementById('loss').textContent = loss.toFixed(3);

        if (epoch >= maxEpochs || accuracy > 94) {
          clearInterval(trainingInterval);
          addNetworkResult(`🎉 Training completed! Final accuracy: ${accuracy.toFixed(1)}%`);

          if (accuracy > 90) {
            addNetworkResult(`🏆 Excellent model performance achieved!`);
          }

          setTimeout(() => completeLab('Neural Network Builder'), 2000);
        }
      }, 100);
    }

    function testNetwork() {
      const accuracy = parseFloat(document.getElementById('accuracy').textContent) || 0;

      if (accuracy < 10) {
        addNetworkResult(`⚠️ Train the model first before testing!`);
        return;
      }

      addNetworkResult(`🧪 Testing model on validation dataset...`);

      setTimeout(() => {
        const testAccuracy = accuracy - 2 + Math.random() * 4; // Slight variation
        const precision = testAccuracy - 1 + Math.random() * 2;
        const recall = testAccuracy - 1 + Math.random() * 2;

        addNetworkResult(`📊 Test Results:`);
        addNetworkResult(`   Accuracy: ${testAccuracy.toFixed(1)}%`);
        addNetworkResult(`   Precision: ${precision.toFixed(1)}%`);
        addNetworkResult(`   Recall: ${recall.toFixed(1)}%`);

        if (testAccuracy > 85) {
          addNetworkResult(`✅ Model ready for deployment!`);
        }
      }, 1500);
    }

    function addNetworkResult(message) {
      const results = document.getElementById('networkResults');
      const timestamp = new Date().toLocaleTimeString();

      const div = document.createElement('div');
      div.className = 'flex items-start space-x-2 p-3 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-700 shadow-sm mb-2';
      div.innerHTML = `
        <div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>
        <div class="flex-1">
          <p class="text-sm font-medium">${message}</p>
          <p class="text-xs text-gray-500">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = results.querySelector('.text-gray-400');
      if (placeholder && placeholder.textContent.includes('Configure your neural')) {
        placeholder.remove();
      }

      results.appendChild(div);
      results.scrollTop = results.scrollHeight;
    }

    function closeLabModal() {
      document.getElementById('labModal').classList.add('hidden');

      // Reset all lab states
      chemicalState = { acid: 0, base: 0, temperature: 25, pressure: 1 };
      quantumState = { qubits: 2, amplitudes: [1, 0, 0, 0], gates: [] };
    }

    function resetLab() {
      // Reset based on current lab
      const title = document.getElementById('labModalTitle').textContent;

      if (title.includes('Chemistry')) {
        resetChemistryLab();
      } else if (title.includes('Quantum')) {
        updateQuantumSystem();
      }

      showToast('🔄 Lab experiment reset', 'info');
    }

    function saveLabReport() {
      const title = document.getElementById('labModalTitle').textContent;
      const timestamp = new Date().toISOString();

      // Create lab report object
      const report = {
        id: Date.now(),
        title: title,
        timestamp: timestamp,
        type: 'lab_report',
        data: {
          chemical: chemicalState,
          quantum: quantumState
        }
      };

      labReports.push(report);
      addActivityFeed(`📄 Saved report for ${title}`);
      showToast('📄 Lab report saved successfully!', 'success');
    }

    function completeLab(labTitle) {
      userProgress.experimentsCompleted++;
      const points = userProgress.userLevel * 100;
      userProgress.totalScore += points;
      userProgress.studyHours += 1;

      checkAchievements();
      updateAllStats();
      addActivityFeed(`🎉 Completed ${labTitle} (+${points} points)`);
      showToast(`🧪 ${labTitle} completed! +${points} points earned!`, 'success');

      setTimeout(() => {
        closeLabModal();
      }, 3000);
    }

    // ====================================
    // SMART AI FUNCTIONS
    // ====================================

    function openAI() {
      const aiModal = document.getElementById('aiModal');
      if (aiModal) {
        aiModal.classList.remove('hidden');
        showNotification('🤖 AI Tutor activated!', 'success');

        // Focus on AI input if it exists
        const aiInput = document.getElementById('aiInput');
        if (aiInput) {
          setTimeout(() => aiInput.focus(), 100);
        }
      } else {
        // Fallback: show notification and navigate to a relevant section
        showNotification('🤖 AI Tutor coming soon!', 'info');
      }
    }

    function closeAI() {
      document.getElementById('aiModal').classList.add('hidden');
    }

    function sendZapierAIMessage() {
      const input = document.getElementById('aiInput');
      const message = input.value.trim();

      if (!message) return;

      addAIMessage(message, 'user');
      input.value = '';

      // Show typing indicator
      addAITyping();

      setTimeout(() => {
        removeAITyping();
        const response = generateZapierAIResponse(message);
        addAIMessage(response, 'ai');

        // Update AI interaction count
        userProgress.aiInteractions++;
        updateAllStats();
        addActivityFeed('⚡ Used Zapier AI Automation');
      }, 1500 + Math.random() * 1000);
    }

    function sendAIMessage() {
      sendZapierAIMessage();
    }

    function generateSmartAIResponse(message) {
      const msgLower = message.toLowerCase();

      // Determine topic
      let topic = 'general';
      if (msgLower.includes('chemistry') || msgLower.includes('chemical') || msgLower.includes('reaction') || msgLower.includes('molecule')) {
        topic = 'chemistry';
      } else if (msgLower.includes('physics') || msgLower.includes('quantum') || msgLower.includes('force') || msgLower.includes('energy')) {
        topic = 'physics';
      } else if (msgLower.includes('math') || msgLower.includes('equation') || msgLower.includes('calculate') || msgLower.includes('solve')) {
        topic = 'mathematics';
      } else if (msgLower.includes('engineering') || msgLower.includes('design') || msgLower.includes('build') || msgLower.includes('structure')) {
        topic = 'engineering';
      }

      // Get appropriate response
      const responses = aiResponses[topic] || aiResponses.general;
      let response = responses[Math.floor(Math.random() * responses.length)];

      // Add specific help based on message content
      if (msgLower.includes('help') && msgLower.includes('homework')) {
        response += "\n\n📚 I can help you with:\n• Breaking down complex problems\n• Explaining concepts step-by-step\n• Suggesting study strategies\n• Finding relevant resources\n\nWhat specific subject or topic do you need help with?";
      } else if (msgLower.includes('experiment')) {
        response += "\n\n🔬 For experiments, I can help you:\n• Design experimental procedures\n• Understand safety protocols\n• Analyze results and data\n• Suggest improvements\n\nWhat type of experiment are you working on?";
      } else if (msgLower.includes('difficult') || msgLower.includes('hard') || msgLower.includes('stuck')) {
        response += "\n\n💪 When things get tough, remember:\n• Break the problem into smaller parts\n• Review the fundamentals first\n• Practice similar problems\n• Don't hesitate to ask for help\n\nYou've got this! What specific part is challenging you?";
      }

      return response;
    }

    function quickAsk(question) {
      document.getElementById('aiInput').value = question;
      sendAIMessage();
    }

    function addAIMessage(content, type) {
      const chatContainer = document.getElementById('aiChat');
      const messageDiv = document.createElement('div');

      if (type === 'user') {
        messageDiv.className = 'flex items-start space-x-3 justify-end';
        messageDiv.innerHTML = `
          <div class="bg-gradient-to-r from-primary to-secondary text-white p-4 rounded-2xl shadow-lg max-w-md">
            <p class="text-sm">${content}</p>
          </div>
          <div class="w-10 h-10 bg-gradient-to-r from-gray-300 to-gray-400 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-gray-600 text-sm"></i>
          </div>
        `;
      } else {
        messageDiv.className = 'flex items-start space-x-3';
        messageDiv.innerHTML = `
          <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center animate-pulse">
            <i class="fas fa-brain text-white text-sm"></i>
          </div>
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-4 rounded-2xl shadow-lg border border-blue-200/50 dark:border-blue-700/50 max-w-md">
            <p class="text-sm whitespace-pre-line">${content}</p>
          </div>
        `;
      }

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addAITyping() {
      const chatContainer = document.getElementById('aiChat');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'ai-typing';
      typingDiv.className = 'flex items-start space-x-3';
      typingDiv.innerHTML = `
        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center animate-pulse">
          <i class="fas fa-brain text-white text-sm"></i>
        </div>
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-4 rounded-2xl shadow-lg border border-blue-200/50 dark:border-blue-700/50">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          </div>
        </div>
      `;

      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeAITyping() {
      const typingDiv = document.getElementById('ai-typing');
      if (typingDiv) {
        typingDiv.remove();
      }
    }

    // ====================================
    // ASSIGNMENTS FUNCTIONS
    // ====================================

    function createAssignment() {
      showCustomModal('🚀 Create New Assignment', `
        <form onsubmit="saveNewAssignment(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-bold mb-2">Assignment Title</label>
            <input type="text" id="assignmentTitle" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold mb-2">Subject</label>
              <input type="text" id="assignmentSubject" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Due Date</label>
              <input type="date" id="assignmentDueDate" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold mb-2">Priority</label>
              <select id="assignmentPriority" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="low">🟢 Low Priority</option>
                <option value="medium" selected>🟡 Medium Priority</option>
                <option value="high">🔴 High Priority</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Estimated Time</label>
              <input type="text" id="assignmentTime" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g., 2 hours">
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Description</label>
            <textarea id="assignmentDescription" rows="4" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Describe the assignment..."></textarea>
          </div>
          <div class="flex space-x-3">
            <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-plus mr-2"></i>Create Assignment
            </button>
            <button type="button" onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              Cancel
            </button>
          </div>
        </form>
      `);
    }

    function saveNewAssignment(event) {
      event.preventDefault();

      const newAssignment = {
        id: Date.now(),
        title: document.getElementById('assignmentTitle').value,
        subject: document.getElementById('assignmentSubject').value,
        dueDate: document.getElementById('assignmentDueDate').value,
        priority: document.getElementById('assignmentPriority').value,
        status: 'pending',
        description: document.getElementById('assignmentDescription').value,
        estimatedTime: document.getElementById('assignmentTime').value,
        createdAt: new Date().toISOString()
      };

      assignments.unshift(newAssignment);
      populateAssignments();
      updateAssignmentCounts();
      updateAllStats();
      closeCustomModal();
      addActivityFeed(`📝 Created assignment: ${newAssignment.title}`);
      showToast('Assignment created successfully!', 'success');
    }

    function openAssignment(id) {
      const assignment = assignments.find(a => a.id === id);
      if (!assignment) return;

      showCustomModal(`📋 ${assignment.title}`, `
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-4">
            <div class="flex items-center space-x-2">
              <span class="px-3 py-1 text-sm rounded-full font-bold ${getStatusColor(assignment.status)}">
                ${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1).replace('-', ' ')}
              </span>
            </div>
            <div class="text-right">
              <span class="text-sm text-gray-500">Due: ${formatDate(assignment.dueDate)}</span>
            </div>
          </div>
          
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
            <h4 class="font-bold text-lg mb-3">📝 Assignment Details</h4>
            <p class="text-gray-600 dark:text-gray-400 leading-relaxed">${assignment.description}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-bold mb-2">Subject</label>
              <p class="text-gray-600 dark:text-gray-400">${assignment.subject}</p>
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Estimated Time</label>
              <p class="text-gray-600 dark:text-gray-400">${assignment.estimatedTime}</p>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-bold mb-2">Work Notes</label>
            <textarea id="assignmentNotes" rows="4" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700" placeholder="Add your work notes and progress..."></textarea>
          </div>
          
          <div class="flex space-x-3">
            <button onclick="updateAssignmentStatus(${assignment.id}, 'in-progress')" class="flex-1 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-play mr-2"></i>Start Working
            </button>
            <button onclick="updateAssignmentStatus(${assignment.id}, 'completed')" class="flex-1 bg-gradient-to-r from-success to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-check mr-2"></i>Mark Complete
            </button>
          </div>
        </div>
      `);
    }

    function updateAssignmentStatus(id, status) {
      const assignment = assignments.find(a => a.id === id);
      if (assignment) {
        assignment.status = status;

        if (status === 'completed') {
          userProgress.tasksCompleted++;
          userProgress.totalScore += 50;
          userProgress.studyHours += 1;
          addActivityFeed(`✅ Completed assignment: ${assignment.title}`);
        }

        populateAssignments();
        updateAssignmentCounts();
        updateAllStats();
        checkAchievements();
        closeCustomModal();
        showToast(`Assignment marked as ${status.replace('-', ' ')}!`, 'success');
      }
    }

    function deleteAssignment(id) {
      showConfirmDialog('Are you sure you want to delete this assignment?', () => {
        const index = assignments.findIndex(a => a.id === id);
        if (index !== -1) {
          const deletedAssignment = assignments[index];
          assignments.splice(index, 1);
          populateAssignments();
          updateAssignmentCounts();
          updateAllStats();
          addActivityFeed(`🗑️ Deleted assignment: ${deletedAssignment.title}`);
          showToast('Assignment deleted successfully!', 'success');
        }
      });
    }

    // ====================================
    // NOTES FUNCTIONS
    // ====================================

    function createNote() {
      showCustomModal('📝 Create New Note', `
        <form onsubmit="saveNewNote(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-bold mb-2">Note Title</label>
            <input type="text" id="noteTitle" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold mb-2">Category</label>
              <select id="noteCategory" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="lecture">📚 Lecture Notes</option>
                <option value="research">🔬 Research</option>
                <option value="lab">🧪 Lab Report</option>
                <option value="project">💡 Project Notes</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Subject</label>
              <input type="text" id="noteSubject" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Content</label>
            <textarea id="noteContent" rows="8" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Write your note content here..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Tags (comma separated)</label>
            <input type="text" id="noteTags" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="important, chemistry, midterm">
          </div>
          <div class="flex space-x-3">
            <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-save mr-2"></i>Save Note
            </button>
            <button type="button" onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              Cancel
            </button>
          </div>
        </form>
      `);
    }

    function saveNewNote(event) {
      event.preventDefault();

      const title = document.getElementById('noteTitle').value.trim();
      const content = document.getElementById('noteContent').value.trim();

      // Validation
      if (!title) {
        showToast('❌ Please enter a note title', 'error');
        return;
      }

      if (!content) {
        showToast('❌ Please enter note content', 'error');
        return;
      }

      const tags = document.getElementById('noteTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

      const newNote = {
        id: Date.now(),
        title: title,
        category: document.getElementById('noteCategory').value,
        subject: document.getElementById('noteSubject').value,
        content: content,
        lastModified: new Date().toISOString(),
        tags: tags
      };

      try {
        notes.unshift(newNote);

        // Save to localStorage immediately
        localStorage.setItem('steamNotes', JSON.stringify(notes));

        // Update the UI
        populateNotes();
        closeCustomModal();

        // Update activity and show success
        addActivityFeed(`📝 Created note: ${newNote.title}`);
        showToast('✅ Note saved successfully!', 'success');

        // Auto-save progress
        saveProgress();

        console.log('Note saved successfully:', newNote);
      } catch (error) {
        console.error('Error saving note:', error);
        showToast('❌ Error saving note. Please try again.', 'error');
      }
    }

    function openNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      showCustomModal(`📝 ${note.title}`, `
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <span class="px-3 py-1 text-sm rounded-full font-bold bg-gradient-to-r from-${getCategoryColor(note.category)}-100 to-${getCategoryColor(note.category)}-200 dark:from-${getCategoryColor(note.category)}-900/30 dark:to-${getCategoryColor(note.category)}-800/30 text-${getCategoryColor(note.category)}-700 dark:text-${getCategoryColor(note.category)}-300">
              ${note.category}
            </span>
            <span class="text-sm text-gray-500">Modified: ${formatDate(note.lastModified)}</span>
          </div>
          
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
            <h4 class="font-bold text-lg mb-3">📚 Subject: ${note.subject}</h4>
            <div class="prose dark:prose-invert max-w-none">
              <p class="whitespace-pre-wrap leading-relaxed">${note.content}</p>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-2">
            ${note.tags.map(tag => `<span class="text-xs px-3 py-1 bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 text-blue-700 dark:text-blue-300 rounded-full font-bold">#${tag}</span>`).join('')}
          </div>
          
          <div class="flex space-x-3">
            <button onclick="editNote(${note.id})" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-edit mr-2"></i>Edit Note
            </button>
            <button onclick="deleteNote(${note.id})" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-trash mr-2"></i>Delete
            </button>
          </div>
        </div>
      `);
    }

    function editNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      closeCustomModal();
      setTimeout(() => {
        showCustomModal('✏️ Edit Note', `
          <form onsubmit="updateNote(event, ${id})" class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-2">Note Title</label>
              <input type="text" id="editNoteTitle" value="${note.title}" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold mb-2">Category</label>
                <select id="editNoteCategory" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                  <option value="lecture" ${note.category === 'lecture' ? 'selected' : ''}>📚 Lecture Notes</option>
                  <option value="research" ${note.category === 'research' ? 'selected' : ''}>🔬 Research</option>
                  <option value="lab" ${note.category === 'lab' ? 'selected' : ''}>🧪 Lab Report</option>
                  <option value="project" ${note.category === 'project' ? 'selected' : ''}>💡 Project Notes</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold mb-2">Subject</label>
                <input type="text" id="editNoteSubject" value="${note.subject}" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Content</label>
              <textarea id="editNoteContent" rows="8" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">${note.content}</textarea>
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Tags (comma separated)</label>
              <input type="text" id="editNoteTags" value="${note.tags.join(', ')}" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="flex space-x-3">
              <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                <i class="fas fa-save mr-2"></i>Update Note
              </button>
              <button type="button" onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                Cancel
              </button>
            </div>
          </form>
        `);
      }, 100);
    }

    function updateNote(event, id) {
      event.preventDefault();

      const note = notes.find(n => n.id === id);
      if (!note) return;

      const tags = document.getElementById('editNoteTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

      note.title = document.getElementById('editNoteTitle').value;
      note.category = document.getElementById('editNoteCategory').value;
      note.subject = document.getElementById('editNoteSubject').value;
      note.content = document.getElementById('editNoteContent').value;
      note.tags = tags;
      note.lastModified = new Date().toISOString();

      populateNotes();
      closeCustomModal();
      addActivityFeed(`✏️ Updated note: ${note.title}`);
      showToast('Note updated successfully!', 'success');
    }

    function deleteNote(id) {
      showConfirmDialog('Are you sure you want to delete this note?', () => {
        const noteIndex = notes.findIndex(n => n.id === id);
        if (noteIndex !== -1) {
          const deletedNote = notes[noteIndex];
          notes.splice(noteIndex, 1);
          populateNotes();
          closeCustomModal();
          addActivityFeed(`🗑️ Deleted note: ${deletedNote.title}`);
          showToast('Note deleted successfully!', 'success');
        }
      });
    }

    // ====================================
    // NOTEBOOKLM FUNCTIONS
    // ====================================

    // NotebookLM State
    let notebookSources = [];
    let notebookNotes = [];
    let currentNotebookView = 'sources';
    let chatHistory = [];
    let podcastLibrary = [];
    let currentNote = null;
    let processedDocuments = [];
    let isAnalyzing = false;

    // API Configuration
    const OPENAI_API_KEY = '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';
    const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
    
    // Check if APIs are available
    const hasOpenAI = OPENAI_API_KEY && OPENAI_API_KEY !== 'your-openai-api-key-here';
    const hasSpeechSynthesis = 'speechSynthesis' in window;
    const hasFileReader = 'FileReader' in window;

    // Initialize NotebookLM
    function initializeNotebookLM() {
      // Set up API configuration - use built-in key or saved key
      const savedApiKey = localStorage.getItem('openaiApiKey');
      if (savedApiKey && savedApiKey.startsWith('sk-')) {
        window.OPENAI_API_KEY = savedApiKey;
        window.hasOpenAI = true;
      } else {
        // Use the built-in API key
        window.OPENAI_API_KEY = OPENAI_API_KEY;
        window.hasOpenAI = hasOpenAI;
      }
      
      // Load saved data
      notebookSources = JSON.parse(localStorage.getItem('notebookSources') || '[]');
      notebookNotes = JSON.parse(localStorage.getItem('notebookNotes') || '[]');
      chatHistory = JSON.parse(localStorage.getItem('notebookChat') || '[]');
      podcastLibrary = JSON.parse(localStorage.getItem('podcastLibrary') || '[]');
      
      // Show default view
      showNotebookView('sources');
      updateSourcesList();
      updateNotesList();
      updatePodcastLibrary();
      updateApiStatus();
      
      // Load chat history
      if (chatHistory.length === 0) {
        // Add welcome message
        addChatMessage('assistant', `Hello! I'm your AI research assistant powered by GPT-3.5-turbo! 🚀

🎉 **Full AI functionality is active!** I can:
• Analyze your documents with real AI intelligence
• Answer complex questions about your sources
• Generate detailed summaries and insights
• Create AI-powered podcast scripts
• Provide smart study guides and quizzes

To get started:
1. 📚 Upload documents in the Sources tab
2. 🧠 Click "Analyze Sources" to process them
3. 💬 Come back here to ask me anything about your content!

What would you like to explore today?`);
      } else {
        // Restore chat history
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
          messagesContainer.innerHTML = '';
          chatHistory.forEach(msg => {
            addChatMessage(msg.sender, msg.message, false); // false = don't save again
          });
        }
      }
    }

    // Navigation between views
    function showNotebookView(viewName) {
      currentNotebookView = viewName;

      // Hide all views
      document.querySelectorAll('.notebook-view').forEach(view => {
        view.classList.add('hidden');
      });

      // Show selected view
      document.getElementById(`notebook${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`).classList.remove('hidden');

      // Update navigation buttons
      document.querySelectorAll('.notebook-nav-btn').forEach(btn => {
        btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'text-white');
        btn.classList.add('bg-white/80', 'dark:bg-gray-700/80', 'text-gray-700', 'dark:text-gray-300');
      });

      document.querySelector(`[data-view="${viewName}"]`).classList.remove('bg-white/80', 'dark:bg-gray-700/80', 'text-gray-700', 'dark:text-gray-300');
      document.querySelector(`[data-view="${viewName}"]`).classList.add('bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'text-white');
    }

    // File Upload Handling
    function handleFileUpload(event) {
      const files = Array.from(event.target.files);
      files.forEach(file => addFileSource(file));
    }

    function handleFileDrop(event) {
      event.preventDefault();
      const files = Array.from(event.dataTransfer.files);
      files.forEach(file => addFileSource(file));
    }

    function handleDragOver(event) {
      event.preventDefault();
    }

    async function addFileSource(file) {
      const source = {
        id: Date.now() + Math.random(),
        name: file.name,
        type: getFileType(file.name),
        size: file.size,
        uploadDate: new Date().toISOString(),
        content: '',
        status: 'processing',
        file: file
      };
      
      notebookSources.push(source);
      updateSourcesList();
      showToast(`📄 Processing ${file.name}...`, 'info');
      
      try {
        // Read file content
        const content = await readFileContent(file);
        source.content = content;
        source.status = 'ready';
        
        updateSourcesList();
        saveNotebookData();
        showToast(`✅ ${file.name} processed successfully!`, 'success');
      } catch (error) {
        console.error('Error processing file:', error);
        source.status = 'error';
        source.content = `Error processing file: ${error.message}`;
        updateSourcesList();
        showToast(`❌ Error processing ${file.name}`, 'error');
      }
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const typeMap = {
        'pdf': 'pdf',
        'doc': 'document',
        'docx': 'document', 
        'txt': 'text',
        'md': 'markdown',
        'rtf': 'document',
        'html': 'web',
        'htm': 'web'
      };
      return typeMap[ext] || 'file';
    }

    async function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          let content = e.target.result;
          
          // Basic text extraction for different file types
          if (file.type === 'application/pdf') {
            // For PDF files, we'll extract what we can as text
            content = `PDF Document: ${file.name}\n\nContent extracted from PDF file. For full PDF processing, consider using a PDF parsing library.\n\nFile size: ${(file.size / 1024).toFixed(1)} KB`;
          } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
            // For Word documents
            content = `Word Document: ${file.name}\n\nContent extracted from Word document. For full document processing, consider using a document parsing library.\n\nFile size: ${(file.size / 1024).toFixed(1)} KB`;
          }
          
          resolve(content);
        };
        
        reader.onerror = function() {
          reject(new Error('Failed to read file'));
        };
        
        // Read as text for most file types
        if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
          reader.readAsText(file);
        } else {
          // For binary files, provide metadata
          resolve(`Binary file: ${file.name}\nSize: ${(file.size / 1024).toFixed(1)} KB\nType: ${file.type || 'Unknown'}\n\nThis file has been uploaded but may require specialized processing for full content extraction.`);
        }
      });
    }

    async function addUrlSource() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        showToast('❌ Please enter a valid URL', 'error');
        return;
      }
      
      try {
        new URL(url); // Validate URL
      } catch {
        showToast('❌ Please enter a valid URL', 'error');
        return;
      }
      
      const source = {
        id: Date.now(),
        name: new URL(url).hostname,
        type: 'url',
        url: url,
        uploadDate: new Date().toISOString(),
        content: '',
        status: 'processing'
      };
      
      notebookSources.push(source);
      document.getElementById('urlInput').value = '';
      updateSourcesList();
      showToast(`🌐 Fetching content from ${source.name}...`, 'info');
      
      try {
        // Fetch URL content
        const content = await fetchUrlContent(url);
        source.content = content;
        source.status = 'ready';
        
        updateSourcesList();
        saveNotebookData();
        showToast(`✅ Content from ${source.name} added successfully!`, 'success');
      } catch (error) {
        console.error('Error fetching URL:', error);
        source.status = 'error';
        source.content = `Error fetching URL: ${error.message}`;
        updateSourcesList();
        showToast(`❌ Error fetching content from ${source.name}`, 'error');
      }
    }

    async function fetchUrlContent(url) {
      // Due to CORS restrictions, we'll use a proxy service or provide instructions
      try {
        // Try to fetch directly (will work for same-origin or CORS-enabled sites)
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const html = await response.text();
        
        // Extract text content from HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Remove script and style elements
        const scripts = doc.querySelectorAll('script, style');
        scripts.forEach(el => el.remove());
        
        // Get text content
        const textContent = doc.body ? doc.body.innerText : doc.innerText;
        
        return `Web Content from: ${url}\n\n${textContent.substring(0, 5000)}${textContent.length > 5000 ? '...\n\n[Content truncated - full content available for analysis]' : ''}`;
        
      } catch (error) {
        // If direct fetch fails due to CORS, provide alternative
        if (error.name === 'TypeError' && error.message.includes('CORS')) {
          return `Web URL: ${url}\n\nNote: Due to browser security restrictions (CORS), this URL cannot be directly fetched. However, you can:\n\n1. Copy and paste the content manually\n2. Use a browser extension to extract content\n3. Save the page as a text file and upload it\n\nThe AI can still help you with questions about this URL if you provide the content.`;
        }
        throw error;
      }
    }

    function addSampleSource(type) {
      const samples = {
        textbook: {
          name: 'Physics Textbook - Chapter 12',
          content: 'Sample physics textbook content covering quantum mechanics, wave-particle duality, and the uncertainty principle.',
          type: 'textbook'
        },
        research: {
          name: 'Quantum Computing Research Paper',
          content: 'Research paper on quantum computing algorithms and their applications in cryptography and optimization.',
          type: 'research'
        },
        lecture: {
          name: 'Advanced Physics Lecture Notes',
          content: 'Comprehensive lecture notes covering advanced topics in theoretical physics and quantum field theory.',
          type: 'lecture'
        },
        wikipedia: {
          name: 'Wikipedia - Quantum Physics',
          content: 'Wikipedia article covering the fundamentals of quantum physics, key principles, and historical development.',
          type: 'wikipedia'
        }
      };

      const sample = samples[type];
      if (!sample) return;

      const source = {
        id: Date.now(),
        name: sample.name,
        type: sample.type,
        uploadDate: new Date().toISOString(),
        content: sample.content,
        status: 'sample'
      };

      notebookSources.push(source);
      updateSourcesList();
      saveNotebookData();
      showToast(`📚 Added ${sample.name}`, 'success');
    }

    function updateSourcesList() {
      const sourcesList = document.getElementById('sourcesList');
      const analyzeBtn = document.getElementById('analyzeBtn');

      if (notebookSources.length === 0) {
        sourcesList.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-inbox text-3xl mb-3"></i>
            <p>No sources added yet</p>
            <p class="text-sm">Upload files to get started</p>
          </div>
        `;
        analyzeBtn.disabled = true;
        return;
      }

      analyzeBtn.disabled = false;
      sourcesList.innerHTML = notebookSources.map(source => `
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <h5 class="font-semibold text-sm truncate">${source.name}</h5>
            <button onclick="removeSource(${source.id})" class="text-red-500 hover:text-red-700 text-xs">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span class="capitalize">${source.type}</span>
            <span>${formatDate(source.uploadDate)}</span>
          </div>
        </div>
      `).join('');
    }

    function removeSource(id) {
      notebookSources = notebookSources.filter(source => source.id !== id);
      updateSourcesList();
      saveNotebookData();
      showToast('🗑️ Source removed', 'info');
    }

    function analyzeAllSources() {
      if (notebookSources.length === 0) return;

      showToast('🧠 Analyzing sources...', 'info');

      // Simulate analysis
      setTimeout(() => {
        showToast('✅ Analysis complete! Ready for chat.', 'success');
        showNotebookView('chat');

        // Add analysis message to chat
        addChatMessage('assistant', `I've analyzed ${notebookSources.length} sources. Here's what I found:

📚 **Sources Overview:**
${notebookSources.map(s => `• ${s.name} (${s.type})`).join('\n')}

🔍 **Key Themes Identified:**
• Quantum mechanics and wave-particle duality
• Advanced physics concepts and applications
• Research methodologies and findings

💬 **What would you like to explore?** Ask me anything about your sources!`);
      }, 2000);
    }

    // Chat Functions
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      addChatMessage('user', message);
      input.value = '';
      
      // Show typing indicator
      const typingDiv = addTypingIndicator();
      
      try {
        let response;
        
        if (hasOpenAI) {
          // Use real OpenAI API
          response = await getOpenAIResponse(message);
        } else {
          // Use enhanced mock responses based on sources
          response = await getEnhancedMockResponse(message);
        }
        
        // Remove typing indicator
        typingDiv.remove();
        
        addChatMessage('assistant', response);
        
      } catch (error) {
        console.error('Error getting AI response:', error);
        typingDiv.remove();
        
        const errorResponse = `I apologize, but I encountered an error while processing your question. ${hasOpenAI ? 'Please check your API key and try again.' : 'This is a demo version - for full AI functionality, please add your OpenAI API key.'}`;
        addChatMessage('assistant', errorResponse);
      }
    }

    function addTypingIndicator() {
      const messagesContainer = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'flex items-start space-x-3 typing-indicator';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
          <i class="fas fa-robot text-white text-xs"></i>
        </div>
        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-2xl rounded-tl-sm">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return typingDiv;
    }

    async function getOpenAIResponse(message) {
      // Prepare context from sources
      const sourceContext = notebookSources
        .filter(source => source.status === 'ready' && source.content)
        .map(source => `Source: ${source.name}\nContent: ${source.content.substring(0, 2000)}`)
        .join('\n\n');
      
      const systemPrompt = `You are a helpful AI research assistant. You have access to the following sources:

${sourceContext}

Please answer the user's question based on these sources. If the sources don't contain relevant information, let the user know and provide general guidance. Be concise but thorough.`;

      const response = await fetch(OPENAI_API_URL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${window.OPENAI_API_KEY || OPENAI_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'gpt-3.5-turbo',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: message }
          ],
          max_tokens: 500,
          temperature: 0.7
        })
      });

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function getEnhancedMockResponse(message) {
      // Enhanced mock responses that analyze the actual source content
      const sourceContent = notebookSources
        .filter(source => source.status === 'ready' && source.content)
        .map(source => source.content)
        .join(' ');
      
      // Simple keyword matching for more relevant responses
      const keywords = message.toLowerCase().split(' ');
      const relevantSources = notebookSources.filter(source => 
        keywords.some(keyword => 
          source.content.toLowerCase().includes(keyword) || 
          source.name.toLowerCase().includes(keyword)
        )
      );
      
      // Simulate processing time
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
      
      if (relevantSources.length > 0) {
        return `Based on your uploaded sources, particularly "${relevantSources[0].name}", I can help with that question. 

Here's what I found relevant to "${message}":

${relevantSources.map(source => `• From "${source.name}": ${source.content.substring(0, 200)}...`).join('\n')}

Would you like me to elaborate on any specific aspect? 

*Note: This is a demo response. For full AI analysis, please add your OpenAI API key in the code.*`;
      } else {
        return `I understand you're asking about "${message}". While I don't see directly relevant information in your current sources, I can provide some general guidance.

Your current sources include:
${notebookSources.map(source => `• ${source.name} (${source.type})`).join('\n')}

Consider uploading more specific sources related to your question, or try rephrasing your question to match the content you've uploaded.

*Note: This is a demo response. For full AI analysis, please add your OpenAI API key in the code.*`;
      }
    }

    function addChatMessage(sender, message, shouldSave = true) {
      const messagesContainer = document.getElementById('chatMessages');
      if (!messagesContainer) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start space-x-3';

      if (sender === 'assistant') {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-white text-xs"></i>
          </div>
          <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-2xl rounded-tl-sm max-w-md">
            <p class="text-sm whitespace-pre-wrap">${message}</p>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-white text-xs"></i>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-2xl rounded-tl-sm max-w-md">
            <p class="text-sm">${message}</p>
          </div>
        `;
      }

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Save to chat history
      if (shouldSave) {
        chatHistory.push({ sender, message, timestamp: new Date().toISOString() });
        saveNotebookData();
      }
    }

    function handleChatKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }

    function askSuggestedQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendChatMessage();
    }

    // Quick Actions
    function generateSummary() {
      showToast('📄 Generating summary...', 'info');
      setTimeout(() => {
        addChatMessage('assistant', '📄 **Summary Generated**\n\nBased on your sources, here are the key points:\n\n• Main concept 1\n• Important finding 2\n• Critical insight 3\n\nWould you like me to elaborate on any of these points?');
        showToast('✅ Summary ready!', 'success');
      }, 1500);
    }

    function createStudyGuide() {
      showToast('📚 Creating study guide...', 'info');
      setTimeout(() => {
        addChatMessage('assistant', '📚 **Study Guide Created**\n\n**Key Topics to Review:**\n1. Quantum mechanics principles\n2. Wave-particle duality\n3. Uncertainty principle\n\n**Practice Questions:**\n• What is the significance of...\n• How does quantum entanglement...\n• Explain the relationship between...');
        showToast('✅ Study guide ready!', 'success');
      }, 2000);
    }

    function generateQuiz() {
      showToast('🧠 Generating quiz...', 'info');
      setTimeout(() => {
        addChatMessage('assistant', '🧠 **Quiz Generated**\n\n**Question 1:** What is the fundamental principle of quantum mechanics?\na) Classical physics\nb) Wave-particle duality\nc) Newtonian mechanics\n\n**Question 2:** Who proposed the uncertainty principle?\n\nWould you like to see more questions?');
        showToast('✅ Quiz ready!', 'success');
      }, 1500);
    }

    function findConnections() {
      showToast('🔗 Finding connections...', 'info');
      setTimeout(() => {
        addChatMessage('assistant', '🔗 **Connections Found**\n\nI found several interesting connections between your sources:\n\n**Theme 1:** All sources discuss quantum mechanics\n**Theme 2:** Common focus on experimental validation\n**Theme 3:** Historical development patterns\n\n**Contradictions:** Source A suggests X while Source B argues Y');
        showToast('✅ Connections mapped!', 'success');
      }, 2000);
    }

    // Notes Functions
    function createNewNote() {
      currentNote = {
        id: Date.now(),
        title: '',
        content: '',
        tags: [],
        createdDate: new Date().toISOString(),
        lastModified: new Date().toISOString()
      };

      document.getElementById('noteTitle').value = '';
      document.getElementById('noteContent').value = '';
      updateWordCount();
    }

    function saveCurrentNote() {
      const title = document.getElementById('noteTitle').value.trim();
      const content = document.getElementById('noteContent').value.trim();

      if (!title && !content) {
        showToast('❌ Note is empty', 'error');
        return;
      }

      if (!currentNote) {
        currentNote = {
          id: Date.now(),
          createdDate: new Date().toISOString()
        };
      }

      currentNote.title = title || 'Untitled Note';
      currentNote.content = content;
      currentNote.lastModified = new Date().toISOString();

      // Extract tags from content
      const tagMatches = content.match(/#\w+/g);
      currentNote.tags = tagMatches ? tagMatches.map(tag => tag.substring(1)) : [];

      // Add or update note
      const existingIndex = notebookNotes.findIndex(note => note.id === currentNote.id);
      if (existingIndex >= 0) {
        notebookNotes[existingIndex] = currentNote;
      } else {
        notebookNotes.unshift(currentNote);
      }

      updateNotesList();
      saveNotebookData();
      showToast('✅ Note saved!', 'success');
    }

    function updateNotesList() {
      const notesList = document.getElementById('notesList');

      if (notebookNotes.length === 0) {
        notesList.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            <i class="fas fa-sticky-note text-2xl mb-2"></i>
            <p class="text-sm">No notes yet</p>
          </div>
        `;
        return;
      }

      notesList.innerHTML = notebookNotes.map(note => `
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600/50 transition-all" onclick="loadNote(${note.id})">
          <h5 class="font-semibold text-sm truncate mb-1">${note.title}</h5>
          <p class="text-xs text-gray-500 truncate">${note.content.substring(0, 50)}...</p>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-400">${formatDate(note.lastModified)}</span>
            <div class="flex space-x-1">
              ${note.tags.slice(0, 2).map(tag => `<span class="text-xs px-1 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded">#${tag}</span>`).join('')}
            </div>
          </div>
        </div>
      `).join('');
    }

    function loadNote(id) {
      const note = notebookNotes.find(n => n.id === id);
      if (!note) return;

      currentNote = note;
      document.getElementById('noteTitle').value = note.title;
      document.getElementById('noteContent').value = note.content;
      updateWordCount();
    }

    function updateWordCount() {
      const content = document.getElementById('noteContent').value;
      const words = content.trim() ? content.trim().split(/\s+/).length : 0;
      const chars = content.length;

      document.getElementById('wordCount').textContent = `${words} words`;
      document.getElementById('charCount').textContent = `${chars} characters`;
    }

    function insertTemplate(type) {
      const templates = {
        outline: `# Outline

## I. Introduction
- 

## II. Main Points
- 
- 
- 

## III. Conclusion
- `,
        summary: `# Summary

## Key Points
- 

## Important Details
- 

## Takeaways
- `,
        analysis: `# Analysis

## Overview
- 

## Strengths
- 

## Weaknesses
- 

## Implications
- `
      };

      const template = templates[type];
      if (template) {
        document.getElementById('noteContent').value += template;
        updateWordCount();
      }
    }

    // Audio/Podcast Functions
    async function generatePodcast() {
      if (notebookSources.length === 0) {
        showToast('❌ Please add sources first', 'error');
        return;
      }

      const style = document.getElementById('podcastStyle').value;
      const duration = parseInt(document.getElementById('podcastDuration').value);
      const focus = document.getElementById('podcastFocus').value;

      const generateBtn = document.getElementById('generatePodcastBtn');
      const progress = document.getElementById('podcastProgress');
      const progressBar = document.getElementById('podcastProgressBar');
      const progressText = document.getElementById('podcastProgressText');

      generateBtn.disabled = true;
      progress.classList.remove('hidden');

      try {
        // Step 1: Generate script
        progressBar.style.width = '25%';
        progressText.textContent = 'Generating podcast script...';
        
        const script = await generatePodcastScript(style, duration, focus);
        
        // Step 2: Convert to speech
        progressBar.style.width = '50%';
        progressText.textContent = 'Converting to speech...';
        
        const audioBlob = await generateSpeech(script);
        
        // Step 3: Create podcast object
        progressBar.style.width = '75%';
        progressText.textContent = 'Finalizing podcast...';
        
        const audioUrl = URL.createObjectURL(audioBlob);
        
        const podcast = {
          id: Date.now(),
          title: `AI Podcast - ${style.charAt(0).toUpperCase() + style.slice(1)}`,
          description: `${duration}-minute AI-generated discussion based on your sources`,
          duration: `${duration}:00`,
          style: style,
          focus: focus,
          script: script,
          createdDate: new Date().toISOString(),
          audioUrl: audioUrl,
          audioBlob: audioBlob
        };

        // Step 4: Complete
        progressBar.style.width = '100%';
        progressText.textContent = 'Podcast ready!';
        
        podcastLibrary.unshift(podcast);
        updatePodcastLibrary();
        loadPodcast(podcast);
        saveNotebookData();

        setTimeout(() => {
          progress.classList.add('hidden');
          generateBtn.disabled = false;
          showToast('🎙️ Podcast generated successfully!', 'success');
        }, 500);

      } catch (error) {
        console.error('Error generating podcast:', error);
        progress.classList.add('hidden');
        generateBtn.disabled = false;
        showToast('❌ Error generating podcast: ' + error.message, 'error');
      }
    }

    async function generatePodcastScript(style, duration, focus) {
      // Prepare source content
      const sourceContent = notebookSources
        .filter(source => source.status === 'ready' && source.content)
        .map(source => `${source.name}: ${source.content.substring(0, 1000)}`)
        .join('\n\n');

      let prompt = '';
      
      switch (style) {
        case 'overview':
          prompt = `Create a ${duration}-minute podcast script that provides an overview of the following sources. Make it conversational and engaging, as if two hosts are discussing the material.`;
          break;
        case 'deep-dive':
          prompt = `Create a ${duration}-minute detailed analysis podcast script diving deep into the following sources. Include specific examples and detailed explanations.`;
          break;
        case 'debate':
          prompt = `Create a ${duration}-minute debate-style podcast script where two perspectives discuss and analyze the following sources, presenting different viewpoints.`;
          break;
        case 'interview':
          prompt = `Create a ${duration}-minute interview-style podcast script where a host interviews an expert about the following sources.`;
          break;
        case 'study-guide':
          prompt = `Create a ${duration}-minute educational podcast script that serves as a study guide for the following sources, highlighting key concepts and important points.`;
          break;
      }

      if (focus) {
        prompt += ` Focus particularly on: ${focus}.`;
      }

      prompt += `\n\nSources:\n${sourceContent}\n\nFormat the script with clear speaker labels (Host 1, Host 2, etc.) and natural conversation flow.`;

      if (hasOpenAI) {
        // Use OpenAI to generate script
        const response = await fetch(OPENAI_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${window.OPENAI_API_KEY || OPENAI_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              { role: 'system', content: 'You are a professional podcast script writer. Create engaging, natural-sounding dialogue.' },
              { role: 'user', content: prompt }
            ],
            max_tokens: 1500,
            temperature: 0.8
          })
        });

        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
      } else {
        // Generate mock script
        return generateMockScript(style, duration, focus);
      }
    }

    function generateMockScript(style, duration, focus) {
      const sources = notebookSources.filter(s => s.status === 'ready');
      const sourceNames = sources.map(s => s.name).join(', ');
      
      return `Host 1: Welcome to today's ${style} discussion! I'm excited to dive into the materials we've gathered: ${sourceNames}.

Host 2: Absolutely! These sources provide fascinating insights. Let me start by highlighting the key themes we've identified.

Host 1: That's a great point. From what I've read, there are several interconnected concepts that really stand out.

Host 2: Exactly. And if we focus on ${focus || 'the main topics'}, we can see how these ideas build upon each other.

Host 1: The research methodology used in these sources is particularly interesting. It shows a systematic approach to understanding the subject matter.

Host 2: I agree. What I find most compelling is how the different perspectives complement each other, even when they seem to contradict at first glance.

Host 1: That's the beauty of having multiple sources. It gives us a more complete picture and helps us think critically about the information.

Host 2: Before we wrap up, let's summarize the key takeaways for our listeners who want to explore these topics further.

Host 1: Great idea. The main points to remember are the interconnected nature of the concepts and the importance of considering multiple perspectives.

Host 2: Thanks for joining us today. We hope this discussion has been helpful in understanding these complex topics!

*Note: This is a demo script. For AI-generated content, please add your OpenAI API key.*`;
    }

    async function generateSpeech(text) {
      if (!hasSpeechSynthesis) {
        throw new Error('Speech synthesis not supported in this browser');
      }

      return new Promise((resolve, reject) => {
        // Clean up the script for speech
        const speechText = text
          .replace(/Host \d+:/g, '') // Remove speaker labels
          .replace(/\*.*?\*/g, '') // Remove notes in asterisks
          .replace(/\n+/g, ' ') // Replace line breaks with spaces
          .trim();

        const utterance = new SpeechSynthesisUtterance(speechText);
        
        // Configure speech settings
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // Try to use a good voice
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => 
          voice.lang.startsWith('en') && 
          (voice.name.includes('Google') || voice.name.includes('Microsoft'))
        ) || voices.find(voice => voice.lang.startsWith('en'));
        
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }

        // Record the speech
        const mediaRecorder = new MediaRecorder(new MediaStream());
        const audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          resolve(audioBlob);
        };

        utterance.onend = () => {
          setTimeout(() => {
            mediaRecorder.stop();
          }, 1000);
        };

        utterance.onerror = (event) => {
          reject(new Error('Speech synthesis failed: ' + event.error));
        };

        // Start recording and speaking
        mediaRecorder.start();
        speechSynthesis.speak(utterance);

        // Fallback: create a simple audio blob if recording fails
        setTimeout(() => {
          if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
          
          // Create a simple beep as fallback
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 1);
          
          // Create a simple audio blob
          const buffer = audioContext.createBuffer(1, audioContext.sampleRate, audioContext.sampleRate);
          const audioBlob = new Blob([buffer], { type: 'audio/wav' });
          resolve(audioBlob);
        }, 10000); // 10 second timeout
      });
    }

    function loadPodcast(podcast) {
      const currentPodcast = document.getElementById('currentPodcast');
      const audioPlayer = document.getElementById('audioPlayer');

      currentPodcast.classList.add('hidden');
      audioPlayer.classList.remove('hidden');

      document.getElementById('podcastTitle').textContent = podcast.title;
      document.getElementById('podcastDescription').textContent = podcast.description;
      document.getElementById('audioSource').src = podcast.audioUrl;
      document.getElementById('audioElement').load();
    }

    function updatePodcastLibrary() {
      const library = document.getElementById('podcastLibrary');

      if (podcastLibrary.length === 0) {
        library.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            <i class="fas fa-headphones text-2xl mb-2"></i>
            <p class="text-sm">Your generated podcasts will appear here</p>
          </div>
        `;
        return;
      }

      library.innerHTML = podcastLibrary.map(podcast => `
        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600/50 transition-all" onclick="loadPodcast(${JSON.stringify(podcast).replace(/"/g, '&quot;')})">
          <div class="flex items-center justify-between mb-2">
            <h5 class="font-semibold text-sm truncate">${podcast.title}</h5>
            <span class="text-xs text-gray-500">${podcast.duration}</span>
          </div>
          <p class="text-xs text-gray-500 truncate">${podcast.description}</p>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-400">${formatDate(podcast.createdDate)}</span>
            <span class="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded capitalize">${podcast.style}</span>
          </div>
        </div>
      `).join('');
    }

    function changePlaybackSpeed(speed) {
      const audio = document.getElementById('audioElement');
      audio.playbackRate = speed;
    }

    // API Configuration
    function showApiConfig() {
      showCustomModal('🔧 API Configuration', `
        <div class="space-y-6">
          <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl border border-blue-200 dark:border-blue-700">
            <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">🚀 Enable Full AI Functionality</h4>
            <p class="text-sm text-blue-700 dark:text-blue-300">
              To unlock real AI chat, document analysis, and advanced features, you'll need an OpenAI API key.
            </p>
          </div>
          
          <div>
            <label class="block text-sm font-bold mb-2">OpenAI API Key</label>
            <input type="password" id="openaiApiKey" placeholder="sk-..." 
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-base">
            <p class="text-xs text-gray-500 mt-1">
              Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a>
            </p>
          </div>
          
          <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl border border-green-200 dark:border-green-700">
            <h4 class="font-bold text-green-800 dark:text-green-200 mb-2">✅ What Works Without API Key</h4>
            <ul class="text-sm text-green-700 dark:text-green-300 space-y-1">
              <li>• File upload and processing</li>
              <li>• Note taking and organization</li>
              <li>• Basic text-to-speech podcasts</li>
              <li>• Enhanced mock AI responses</li>
            </ul>
          </div>
          
          <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-xl border border-purple-200 dark:border-purple-700">
            <h4 class="font-bold text-purple-800 dark:text-purple-200 mb-2">🎯 What Requires API Key</h4>
            <ul class="text-sm text-purple-700 dark:text-purple-300 space-y-1">
              <li>• Real AI chat with your documents</li>
              <li>• Intelligent document analysis</li>
              <li>• AI-generated podcast scripts</li>
              <li>• Smart summaries and insights</li>
            </ul>
          </div>
          
          <div class="flex space-x-3">
            <button onclick="saveApiConfig()" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 shadow-lg">
              <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
            <button onclick="closeCustomModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 shadow-lg">
              <i class="fas fa-times mr-2"></i>Cancel
            </button>
          </div>
        </div>
      `);
    }

    function saveApiConfig() {
      const apiKey = document.getElementById('openaiApiKey').value.trim();
      
      if (apiKey) {
        localStorage.setItem('openaiApiKey', apiKey);
        // Update global variable
        window.OPENAI_API_KEY = apiKey;
        window.hasOpenAI = true;
        
        showToast('✅ API key saved! Full AI functionality enabled.', 'success');
        updateApiStatus();
      } else {
        localStorage.removeItem('openaiApiKey');
        window.OPENAI_API_KEY = '';
        window.hasOpenAI = false;
        
        showToast('ℹ️ API key removed. Using demo mode.', 'info');
        updateApiStatus();
      }
      
      closeCustomModal();
    }

    function updateApiStatus() {
      const statusElement = document.getElementById('apiStatus');
      if (!statusElement) return;
      
      const savedKey = localStorage.getItem('openaiApiKey');
      const currentKey = window.OPENAI_API_KEY || OPENAI_API_KEY;
      
      if ((savedKey && savedKey.startsWith('sk-')) || (currentKey && currentKey.startsWith('sk-'))) {
        statusElement.innerHTML = `
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">
            <i class="fas fa-check-circle mr-1"></i>
            🤖 AI Enabled - GPT-3.5-turbo Active
          </span>
          <button onclick="showApiConfig()" class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
            Manage API
          </button>
        `;
        
        // Update global variables
        window.OPENAI_API_KEY = savedKey || currentKey;
        window.hasOpenAI = true;
      } else {
        statusElement.innerHTML = `
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Demo Mode - Add OpenAI API key for full functionality
          </span>
          <button onclick="showApiConfig()" class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
            Configure API
          </button>
        `;
        
        window.OPENAI_API_KEY = '';
        window.hasOpenAI = false;
      }
    }

    // Save/Load Data
    function saveNotebookData() {
      localStorage.setItem('notebookSources', JSON.stringify(notebookSources));
      localStorage.setItem('notebookNotes', JSON.stringify(notebookNotes));
      localStorage.setItem('notebookChat', JSON.stringify(chatHistory));
      localStorage.setItem('podcastLibrary', JSON.stringify(podcastLibrary));
    }

    // Calendar reminder settings
    let remindersEnabled = false;
    let googleCalendarSynced = false;
    let activeReminders = [];

    // ====================================
    // CALENDAR FUNCTIONS WITH SMART REMINDERS
    // ====================================

    function generateCalendar() {
      const calendarDays = document.getElementById('calendarDays');
      const monthYear = document.getElementById('currentMonth');

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      monthYear.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      let html = '';

      // Empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="p-4 text-gray-300 bg-gray-50 dark:bg-gray-800"></div>';
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const currentDay = new Date(year, month, day);
        const isToday = new Date().toDateString() === currentDay.toDateString();

        // Check for events
        const dayEvents = calendarEvents.filter(event => {
          const eventDate = new Date(event.date);
          return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
        });

        // Check for assignment due dates
        const assignmentsDue = assignments.filter(assignment => {
          const dueDate = new Date(assignment.dueDate);
          return dueDate.getDate() === day && dueDate.getMonth() === month && dueDate.getFullYear() === year;
        });

        const hasEvents = dayEvents.length > 0 || assignmentsDue.length > 0;
        const bgClass = isToday ? 'bg-gradient-to-r from-primary to-secondary text-white' : 'bg-white dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/20';

        let eventIndicators = '';
        if (hasEvents) {
          if (dayEvents.length > 0) {
            eventIndicators += `<div class="w-2 h-2 ${isToday ? 'bg-white' : 'bg-primary'} rounded-full mt-1"></div>`;
          }
          if (assignmentsDue.length > 0) {
            eventIndicators += `<div class="w-2 h-2 ${isToday ? 'bg-yellow-200' : 'bg-red-500'} rounded-full mt-1"></div>`;
          }
        }

        html += `
          <div class="p-4 border-b border-r border-gray-200/50 dark:border-gray-700/50 min-h-[80px] cursor-pointer transition-all ${bgClass}" onclick="selectDate(${year}, ${month}, ${day})">
            <div class="font-bold ${isToday ? 'text-white' : ''}">${day}</div>
            <div class="flex space-x-1">${eventIndicators}</div>
            ${hasEvents ? `<div class="text-xs mt-1 ${isToday ? 'text-white/80' : 'text-gray-500'}">${dayEvents.length + assignmentsDue.length} items</div>` : ''}
          </div>
        `;
      }

      calendarDays.innerHTML = html;
      updateTodaySchedule();
      updateUpcomingEvents();
      checkAndCreateReminders();
    }

    function updateTodaySchedule() {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];

      const todayEvents = calendarEvents.filter(event => event.date === todayString);
      const todayAssignments = assignments.filter(assignment => assignment.dueDate === todayString);

      const scheduleContainer = document.getElementById('todaySchedule');

      if (todayEvents.length === 0 && todayAssignments.length === 0) {
        scheduleContainer.innerHTML = '<div class="text-gray-500 text-sm">No events today</div>';
        return;
      }

      let scheduleHTML = '';

      // Add events
      todayEvents.forEach(event => {
        const eventIcon = getEventIcon(event.type);
        scheduleHTML += `
          <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border border-blue-200/50 dark:border-blue-700/50">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <i class="${eventIcon} text-white text-sm"></i>
            </div>
            <div class="flex-1">
              <p class="font-bold text-sm">${event.title}</p>
              <p class="text-xs text-gray-500">${event.time ? formatTime(event.time) : 'All day'}</p>
            </div>
          </div>
        `;
      });

      // Add assignments
      todayAssignments.forEach(assignment => {
        const priorityColor = assignment.priority === 'high' ? 'red' : assignment.priority === 'medium' ? 'yellow' : 'green';
        scheduleHTML += `
          <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-${priorityColor}-50 to-orange-50 dark:from-${priorityColor}-900/20 dark:to-orange-900/20 rounded-xl border border-${priorityColor}-200/50 dark:border-${priorityColor}-700/50">
            <div class="w-8 h-8 bg-gradient-to-r from-${priorityColor}-500 to-orange-600 rounded-full flex items-center justify-center">
              <i class="fas fa-tasks text-white text-sm"></i>
            </div>
            <div class="flex-1">
              <p class="font-bold text-sm">${assignment.title} - DUE</p>
              <p class="text-xs text-gray-500">${assignment.subject}</p>
            </div>
          </div>
        `;
      });

      scheduleContainer.innerHTML = scheduleHTML;
    }

    function updateUpcomingEvents() {
      const now = new Date();
      const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

      // Get upcoming events
      const upcomingEvents = calendarEvents.filter(event => {
        const eventDate = new Date(event.date);
        return eventDate >= now && eventDate <= nextWeek;
      });

      // Get upcoming assignments
      const upcomingAssignments = assignments.filter(assignment => {
        const dueDate = new Date(assignment.dueDate);
        return dueDate >= now && dueDate <= nextWeek && assignment.status !== 'completed';
      });

      const eventsContainer = document.getElementById('upcomingEvents');

      if (upcomingEvents.length === 0 && upcomingAssignments.length === 0) {
        eventsContainer.innerHTML = '<div class="text-gray-500 text-sm">No upcoming events</div>';
        return;
      }

      // Combine and sort all upcoming items
      const allUpcoming = [
        ...upcomingEvents.map(event => ({ ...event, type: 'event' })),
        ...upcomingAssignments.map(assignment => ({ ...assignment, type: 'assignment', date: assignment.dueDate }))
      ].sort((a, b) => new Date(a.date) - new Date(b.date));

      let upcomingHTML = '';
      allUpcoming.slice(0, 5).forEach(item => {
        const itemDate = new Date(item.date);
        const daysUntil = Math.ceil((itemDate - now) / (1000 * 60 * 60 * 24));
        const urgencyClass = daysUntil <= 1 ? 'from-red-50 to-pink-50 border-red-200' : daysUntil <= 3 ? 'from-yellow-50 to-orange-50 border-yellow-200' : 'from-blue-50 to-purple-50 border-blue-200';

        if (item.type === 'event') {
          const eventIcon = getEventIcon(item.eventType || 'other');
          upcomingHTML += `
            <div class="flex items-center space-x-3 p-3 bg-gradient-to-r ${urgencyClass} dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border dark:border-blue-700/50 mb-2">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <i class="${eventIcon} text-white text-sm"></i>
              </div>
              <div class="flex-1">
                <p class="font-bold text-sm">${item.title}</p>
                <p class="text-xs text-gray-500">${formatDateRelative(item.date)} • ${item.time || 'All day'}</p>
              </div>
            </div>
          `;
        } else {
          const priorityColor = item.priority === 'high' ? 'red' : item.priority === 'medium' ? 'yellow' : 'green';
          upcomingHTML += `
            <div class="flex items-center space-x-3 p-3 bg-gradient-to-r ${urgencyClass} dark:from-${priorityColor}-900/20 dark:to-orange-900/20 rounded-xl border dark:border-${priorityColor}-700/50 mb-2">
              <div class="w-8 h-8 bg-gradient-to-r from-${priorityColor}-500 to-orange-600 rounded-full flex items-center justify-center">
                <i class="fas fa-tasks text-white text-sm"></i>
              </div>
              <div class="flex-1">
                <p class="font-bold text-sm">${item.title} - DUE</p>
                <p class="text-xs text-gray-500">${formatDateRelative(item.date)} • ${item.subject}</p>
              </div>
            </div>
          `;
        }
      });

      eventsContainer.innerHTML = upcomingHTML;
    }

    function checkAndCreateReminders() {
      if (!remindersEnabled) return;

      const now = new Date();
      const newReminders = [];

      // Check assignments for reminders
      assignments.forEach(assignment => {
        if (assignment.status === 'completed') return;

        const dueDate = new Date(assignment.dueDate);
        const timeDiff = dueDate - now;
        const hoursUntilDue = timeDiff / (1000 * 60 * 60);

        // Create reminders at 24h, 6h, 1h before due
        const reminderTimes = [24, 6, 1];
        reminderTimes.forEach(hours => {
          if (Math.abs(hoursUntilDue - hours) < 0.5) { // Within 30 minutes of reminder time
            const reminderId = `assignment_${assignment.id}_${hours}h`;
            if (!activeReminders.some(r => r.id === reminderId)) {
              newReminders.push({
                id: reminderId,
                type: 'assignment',
                title: `Assignment Due in ${hours} hour${hours > 1 ? 's' : ''}`,
                message: `"${assignment.title}" is due in ${hours} hour${hours > 1 ? 's' : ''}`,
                urgency: hours <= 1 ? 'high' : hours <= 6 ? 'medium' : 'low',
                timestamp: now.toISOString()
              });
            }
          }
        });
      });

      // Check calendar events for reminders
      calendarEvents.forEach(event => {
        const eventDateTime = new Date(`${event.date}T${event.time || '00:00'}`);
        const timeDiff = eventDateTime - now;
        const minutesUntilEvent = timeDiff / (1000 * 60);

        // Create reminder 30 minutes before event
        if (Math.abs(minutesUntilEvent - 30) < 5) { // Within 5 minutes of 30-minute mark
          const reminderId = `event_${event.id}_30m`;
          if (!activeReminders.some(r => r.id === reminderId)) {
            newReminders.push({
              id: reminderId,
              type: 'event',
              title: 'Event Starting Soon',
              message: `"${event.title}" starts in 30 minutes`,
              urgency: 'medium',
              timestamp: now.toISOString()
            });
          }
        }
      });

      // Add new reminders and show notifications
      newReminders.forEach(reminder => {
        activeReminders.push(reminder);
        showReminderNotification(reminder);
        addActivityFeed(`🔔 Reminder: ${reminder.message}`);
      });

      // Clean up old reminders (older than 24 hours)
      const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
      activeReminders = activeReminders.filter(reminder =>
        new Date(reminder.timestamp) > oneDayAgo
      );

      updateActiveReminders();
    }

    function updateActiveReminders() {
      const remindersContainer = document.getElementById('activeReminders');

      if (activeReminders.length === 0) {
        remindersContainer.innerHTML = '<div class="text-gray-500 text-sm">No active reminders</div>';
        return;
      }

      // Sort by urgency and timestamp
      const sortedReminders = activeReminders.sort((a, b) => {
        const urgencyOrder = { high: 3, medium: 2, low: 1 };
        return urgencyOrder[b.urgency] - urgencyOrder[a.urgency] ||
          new Date(b.timestamp) - new Date(a.timestamp);
      });

      let remindersHTML = '';
      sortedReminders.slice(0, 5).forEach(reminder => {
        const urgencyColor = reminder.urgency === 'high' ? 'red' : reminder.urgency === 'medium' ? 'yellow' : 'green';
        const typeIcon = reminder.type === 'assignment' ? 'fas fa-tasks' : 'fas fa-calendar';

        remindersHTML += `
          <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-${urgencyColor}-50 to-orange-50 dark:from-${urgencyColor}-900/20 dark:to-orange-900/20 rounded-xl border border-${urgencyColor}-200/50 dark:border-${urgencyColor}-700/50 mb-2">
            <div class="w-8 h-8 bg-gradient-to-r from-${urgencyColor}-500 to-orange-600 rounded-full flex items-center justify-center">
              <i class="${typeIcon} text-white text-sm"></i>
            </div>
            <div class="flex-1">
              <p class="font-bold text-sm">${reminder.title}</p>
              <p class="text-xs text-gray-500">${reminder.message}</p>
            </div>
            <button onclick="dismissReminder('${reminder.id}')" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
        `;
      });

      remindersContainer.innerHTML = remindersHTML;
    }

    function showReminderNotification(reminder) {
      // Create a more prominent notification for reminders
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 max-w-sm bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-2xl shadow-2xl transform translate-x-full transition-all duration-500 z-50 border border-white/20`;

      notification.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-bell text-lg"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-bold text-sm mb-1">${reminder.title}</h4>
            <p class="text-sm opacity-90 leading-tight">${reminder.message}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white transition-colors">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      `;

      document.body.appendChild(notification);

      // Slide in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);

      // Auto-dismiss after 8 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.add('translate-x-full');
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 500);
        }
      }, 8000);

      // Play notification sound (if browser supports it)
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        // Ignore audio errors
      }
    }

    function dismissReminder(reminderId) {
      activeReminders = activeReminders.filter(reminder => reminder.id !== reminderId);
      updateActiveReminders();
      showToast('Reminder dismissed', 'info');
    }

    function syncGoogleCalendar() {
      if (!googleCalendarSynced) {
        // Simulate Google Calendar sync
        showToast('🔄 Connecting to Google Calendar...', 'info');

        setTimeout(() => {
          // Add some sample synced events
          const sampleEvents = [
            {
              id: Date.now() + 1,
              title: 'Chemistry Lab Session',
              date: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              time: '14:00',
              type: 'lab',
              description: 'Organic Chemistry Lab - Synthesis experiment',
              source: 'google'
            },
            {
              id: Date.now() + 2,
              title: 'Physics Study Group',
              date: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              time: '16:00',
              type: 'study',
              description: 'Quantum mechanics problem solving session',
              source: 'google'
            }
          ];

          calendarEvents.push(...sampleEvents);
          googleCalendarSynced = true;

          document.getElementById('syncStatus').textContent = 'Synced successfully • Last sync: ' + new Date().toLocaleTimeString();
          generateCalendar();
          addActivityFeed('📅 Synced with Google Calendar');
          showToast('✅ Google Calendar synced successfully!', 'success');
        }, 2000);
      } else {
        showToast('📅 Google Calendar already synced', 'info');
      }
    }

    function toggleReminders() {
      remindersEnabled = !remindersEnabled;
      const toggleText = document.getElementById('reminderToggleText');

      if (remindersEnabled) {
        toggleText.textContent = 'Disable Reminders';
        showToast('🔔 Smart reminders enabled!', 'success');
        addActivityFeed('🔔 Enabled smart reminders');

        // Start reminder checking interval (every 5 minutes)
        reminderCheckInterval = setInterval(checkAndCreateReminders, 5 * 60 * 1000);

        // Check immediately
        checkAndCreateReminders();
      } else {
        toggleText.textContent = 'Enable Reminders';
        showToast('🔕 Reminders disabled', 'info');
        addActivityFeed('🔕 Disabled reminders');

        // Clear interval
        if (reminderCheckInterval) {
          clearInterval(reminderCheckInterval);
        }

        // Clear active reminders
        activeReminders = [];
        updateActiveReminders();
      }
    }

    // Set up reminder checking interval
    let reminderCheckInterval = null;

    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      generateCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      generateCalendar();
    }

    function selectDate(year, month, day) {
      const selectedDate = new Date(year, month, day);
      addActivityFeed(`📅 Selected date: ${selectedDate.toLocaleDateString()}`);
      showToast(`Selected: ${selectedDate.toLocaleDateString()}`, 'info');
    }

    function addEvent() {
      showCustomModal('📅 Add Calendar Event', `
        <form onsubmit="saveEvent(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-bold mb-2">Event Title</label>
            <input type="text" id="eventTitle" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold mb-2">Date</label>
              <input type="date" id="eventDate" required class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-bold mb-2">Time</label>
              <input type="time" id="eventTime" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Event Type</label>
            <select id="eventType" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="assignment">📝 Assignment Due</option>
              <option value="exam">📚 Exam</option>
              <option value="class">🏫 Class</option>
              <option value="study">📖 Study Session</option>
              <option value="lab">🧪 Lab Session</option>
              <option value="other">📌 Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Description</label>
            <textarea id="eventDescription" rows="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Event details..."></textarea>
          </div>
          <div class="flex space-x-3">
            <button type="submit" class="flex-1 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-plus mr-2"></i>Add Event
            </button>
            <button type="button" onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              Cancel
            </button>
          </div>
        </form>
      `);
    }

    function saveEvent(event) {
      event.preventDefault();

      const newEvent = {
        id: Date.now(),
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        type: document.getElementById('eventType').value,
        description: document.getElementById('eventDescription').value
      };

      calendarEvents.push(newEvent);
      closeCustomModal();
      generateCalendar();
      addActivityFeed(`📅 Added event: ${newEvent.title}`);
      showToast('Event added to calendar!', 'success');
    }

    // ====================================
    // CALCULATOR FUNCTIONS
    // ====================================

    function addToCalculator(value) {
      const display = document.getElementById('calculatorDisplay');
      calculatorInput += value;
      display.value = calculatorInput;
    }

    function clearCalculator() {
      calculatorInput = '';
      document.getElementById('calculatorDisplay').value = '';
    }

    function deleteLast() {
      calculatorInput = calculatorInput.slice(0, -1);
      document.getElementById('calculatorDisplay').value = calculatorInput;
    }

    function calculate() {
      const display = document.getElementById('calculatorDisplay');
      const expression = calculatorInput;

      if (!expression) return;

      try {
        const result = eval(expression);
        display.value = result;
        lastResult = result;

        addCalculationHistory(`${expression} = ${result}`);
        calculatorInput = result.toString();

        // Award points for calculations
        userProgress.totalScore += 5;
        updateAllStats();

      } catch (error) {
        display.value = 'Error';
        addCalculationHistory(`Error: ${expression}`);
        calculatorInput = '';
      }
    }

    function addCalculationHistory(entry) {
      const history = document.getElementById('calculatorResults');
      const timestamp = new Date().toLocaleTimeString();

      const div = document.createElement('div');
      div.className = 'flex items-center space-x-3 p-3 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl border border-blue-200/50 dark:border-blue-700/50 mb-2';
      div.innerHTML = `
        <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
          <i class="fas fa-calculator text-white text-xs"></i>
        </div>
        <div class="flex-1">
          <p class="font-mono text-sm font-medium">${entry}</p>
          <p class="text-xs text-gray-500">${timestamp}</p>
        </div>
      `;

      // Remove placeholder if it exists
      const placeholder = history.querySelector('.text-gray-500');
      if (placeholder && placeholder.textContent.includes('Enter calculations')) {
        placeholder.remove();
      }

      history.appendChild(div);
      history.scrollTop = history.scrollHeight;
    }

    function plotFunction() {
      const functionInput = document.getElementById('functionInput');
      const expression = functionInput.value;

      if (!expression) {
        showToast('Enter a function to plot (e.g., x*x or Math.sin(x))', 'warning');
        return;
      }

      const canvas = document.getElementById('functionCanvas');
      const ctx = canvas.getContext('2d');

      // Clear canvas with gradient background
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#f8fafc');
      gradient.addColorStop(1, '#e2e8f0');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw grid
      ctx.strokeStyle = '#e2e8f0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * canvas.width;
        const y = (i / 10) * canvas.height;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // Draw axes
      ctx.strokeStyle = '#64748b';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();

      // Plot function
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 3;
      ctx.beginPath();

      const xMin = -10, xMax = 10;
      const yMin = -10, yMax = 10;
      let firstPoint = true;

      for (let i = 0; i < canvas.width; i++) {
        const x = xMin + (i / canvas.width) * (xMax - xMin);

        try {
          const y = eval(expression.replace(/x/g, x.toString()));

          if (typeof y === 'number' && isFinite(y)) {
            const canvasX = i;
            const canvasY = canvas.height - ((y - yMin) / (yMax - yMin)) * canvas.height;

            if (firstPoint) {
              ctx.moveTo(canvasX, canvasY);
              firstPoint = false;
            } else {
              ctx.lineTo(canvasX, canvasY);
            }
          }
        } catch (e) {
          // Skip invalid points
        }
      }

      ctx.stroke();
      addCalculationHistory(`📊 Plotted: f(x) = ${expression}`);
      addActivityFeed(`📈 Plotted mathematical function`);

      // Award points for plotting
      userProgress.totalScore += 10;
      updateAllStats();
    }

    function solveEquation() {
      const expression = document.getElementById('calculatorDisplay').value;

      if (!expression.includes('=')) {
        showToast('Enter an equation with = to solve (e.g., x^2-4=0)', 'warning');
        return;
      }

      addCalculationHistory(`🔍 Solving equation: ${expression}`);
      addCalculationHistory('💡 Tip: Use numerical methods or graphing for complex equations');
      showToast('Advanced equation solving requires specialized algorithms', 'info');
    }

    // ====================================
    // DATA ANALYSIS FUNCTIONS
    // ====================================

    function generateSampleData() {
      const datasets = [
        'Student test scores',
        'Temperature readings',
        'Chemical reaction rates',
        'Stock prices',
        'Population data'
      ];

      const sampleData = [];
      const dataType = datasets[Math.floor(Math.random() * datasets.length)];

      for (let i = 0; i < 50; i++) {
        if (dataType.includes('test scores')) {
          sampleData.push((Math.random() * 40 + 60).toFixed(1)); // 60-100
        } else if (dataType.includes('temperature')) {
          sampleData.push((Math.random() * 30 + 10).toFixed(1)); // 10-40°C
        } else {
          sampleData.push((Math.random() * 100).toFixed(2));
        }
      }

      document.getElementById('datasetName').value = dataType;
      document.getElementById('dataPoints').value = sampleData.join(', ');

      showToast(`🎲 Generated sample data: ${dataType}`, 'success');
    }

    function analyzeData() {
      const dataString = document.getElementById('dataPoints').value;
      const datasetName = document.getElementById('datasetName').value || 'Unnamed Dataset';

      if (!dataString.trim()) {
        showToast('Please enter data points', 'warning');
        return;
      }

      try {
        const dataPoints = dataString.split(',').map(point => {
          const trimmed = point.trim();
          return parseFloat(trimmed);
        }).filter(point => !isNaN(point));

        if (dataPoints.length === 0) {
          throw new Error('No valid data points found');
        }

        currentDataset = {
          name: datasetName,
          data: dataPoints
        };

        const stats = calculateAdvancedStatistics(dataPoints);
        displayAdvancedStatistics(stats);
        createAdvancedDataVisualizations();

        addActivityFeed(`📊 Analyzed dataset: ${datasetName}`);
        showToast('📈 Data analysis completed!', 'success');

        // Award points for data analysis
        userProgress.totalScore += 25;
        updateAllStats();

      } catch (error) {
        showToast(`Data analysis error: ${error.message}`, 'error');
      }
    }

    function calculateAdvancedStatistics(data) {
      const sorted = [...data].sort((a, b) => a - b);
      const n = data.length;

      const mean = data.reduce((sum, val) => sum + val, 0) / n;
      const variance = data.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (n - 1);
      const stdDev = Math.sqrt(variance);

      const median = n % 2 === 0 ?
        (sorted[n / 2 - 1] + sorted[n / 2]) / 2 :
        sorted[Math.floor(n / 2)];

      // Quartiles
      const q1 = sorted[Math.floor(n * 0.25)];
      const q3 = sorted[Math.floor(n * 0.75)];
      const iqr = q3 - q1;

      const min = sorted[0];
      const max = sorted[n - 1];
      const range = max - min;

      // Skewness (simplified)
      const skewness = data.reduce((sum, val) => sum + Math.pow((val - mean) / stdDev, 3), 0) / n;

      return {
        count: n,
        mean: mean.toFixed(3),
        median: median.toFixed(3),
        stdDev: stdDev.toFixed(3),
        variance: variance.toFixed(3),
        min: min.toFixed(3),
        max: max.toFixed(3),
        range: range.toFixed(3),
        q1: q1.toFixed(3),
        q3: q3.toFixed(3),
        iqr: iqr.toFixed(3),
        skewness: skewness.toFixed(3)
      };
    }

    function displayAdvancedStatistics(stats) {
      const container = document.getElementById('statisticalResults');
      container.innerHTML = `
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div class="space-y-3">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-3 rounded-lg">
              <h5 class="font-bold text-blue-700 dark:text-blue-300 mb-2">Central Tendency</h5>
              <div class="space-y-1">
                <div class="flex justify-between">
                  <span class="font-medium">Mean:</span>
                  <span class="font-bold">${stats.mean}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Median:</span>
                  <span class="font-bold">${stats.median}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-3 rounded-lg">
              <h5 class="font-bold text-green-700 dark:text-green-300 mb-2">Variability</h5>
              <div class="space-y-1">
                <div class="flex justify-between">
                  <span class="font-medium">Std Dev:</span>
                  <span class="font-bold">${stats.stdDev}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Variance:</span>
                  <span class="font-bold">${stats.variance}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Range:</span>
                  <span class="font-bold">${stats.range}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-3 rounded-lg">
              <h5 class="font-bold text-purple-700 dark:text-purple-300 mb-2">Quartiles</h5>
              <div class="space-y-1">
                <div class="flex justify-between">
                  <span class="font-medium">Q1:</span>
                  <span class="font-bold">${stats.q1}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Q3:</span>
                  <span class="font-bold">${stats.q3}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">IQR:</span>
                  <span class="font-bold">${stats.iqr}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 p-3 rounded-lg">
              <h5 class="font-bold text-orange-700 dark:text-orange-300 mb-2">Shape</h5>
              <div class="space-y-1">
                <div class="flex justify-between">
                  <span class="font-medium">Skewness:</span>
                  <span class="font-bold">${stats.skewness}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Count:</span>
                  <span class="font-bold">${stats.count}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedDataVisualizations() {
      if (!currentDataset) return;

      const data = currentDataset.data;

      // Enhanced line chart
      const ctx1 = document.getElementById('dataChart').getContext('2d');
      if (dataChart) dataChart.destroy();

      dataChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Array.from({ length: data.length }, (_, i) => i + 1),
          datasets: [{
            label: currentDataset.name,
            data: data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            pointBackgroundColor: '#1d4ed8',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 4,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Data Trend Analysis'
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });

      // Enhanced histogram
      const ctx2 = document.getElementById('distributionChart').getContext('2d');
      if (distributionChart) distributionChart.destroy();

      const histogram = createAdvancedHistogram(data);

      distributionChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: histogram.bins,
          datasets: [{
            label: 'Frequency',
            data: histogram.frequencies,
            backgroundColor: 'rgba(34, 197, 94, 0.7)',
            borderColor: '#22c55e',
            borderWidth: 2,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Distribution Analysis'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Frequency'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Value Range'
              }
            }
          }
        }
      });
    }

    function createAdvancedHistogram(data) {
      const min = Math.min(...data);
      const max = Math.max(...data);
      const binCount = Math.ceil(Math.sqrt(data.length));
      const binWidth = (max - min) / binCount;

      const bins = [];
      const frequencies = [];

      for (let i = 0; i < binCount; i++) {
        const binStart = min + i * binWidth;
        const binEnd = binStart + binWidth;
        bins.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);

        const count = data.filter(val => val >= binStart && (i === binCount - 1 ? val <= binEnd : val < binEnd)).length;
        frequencies.push(count);
      }

      return { bins, frequencies };
    }

    function initializeDataCharts() {
      const ctx1 = document.getElementById('dataChart');
      const ctx2 = document.getElementById('distributionChart');

      if (ctx1 && !dataChart) {
        dataChart = new Chart(ctx1, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      if (ctx2 && !distributionChart) {
        distributionChart = new Chart(ctx2, {
          type: 'bar',
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
    }

    // ====================================
    // RESOURCE FUNCTIONS
    // ====================================

    function openResource(id) {
      const resource = resources.find(r => r.id === id);
      if (!resource) return;

      if (resource.type === 'video') {
        showCustomModal(`🎥 ${resource.title}`, `
          <div class="space-y-4">
            <div class="aspect-video rounded-xl overflow-hidden">
              <iframe 
                width="100%" 
                height="100%" 
                src="${resource.url}?autoplay=0" 
                frameborder="0" 
                allowfullscreen
                class="rounded-xl shadow-lg">
              </iframe>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
              <p class="text-gray-600 dark:text-gray-400 leading-relaxed">${resource.description}</p>
              <div class="mt-4 flex items-center space-x-4 text-sm">
                ${resource.duration ? `<span class="flex items-center"><i class="fas fa-clock text-primary mr-1"></i>${resource.duration}</span>` : ''}
                ${resource.difficulty ? `<span class="px-2 py-1 rounded-full ${getDifficultyColor(resource.difficulty)} font-bold">${resource.difficulty}</span>` : ''}
              </div>
            </div>
            <div class="flex space-x-3">
              <button onclick="markResourceCompleted(${resource.id})" class="flex-1 bg-gradient-to-r from-success to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                <i class="fas fa-check mr-2"></i>Mark as Completed
              </button>
              <button onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                Close
              </button>
            </div>
          </div>
        `);
      } else {
        window.open(resource.url, '_blank');
        markResourceCompleted(id);
      }
    }

    function markResourceCompleted(id) {
      const resource = resources.find(r => r.id === id);
      if (resource) {
        closeCustomModal();
        addActivityFeed(`📚 Completed resource: ${resource.title}`);
        showToast('📚 Resource marked as completed!', 'success');

        userProgress.studyHours++;
        userProgress.totalScore += 15;
        updateAllStats();
        checkAchievements();
      }
    }

    function filterResources(category) {
      // Update button states
      document.querySelectorAll('.resource-filter').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-white/30', 'scale-105');
      });
      document.querySelector(`.resource-filter[data-category="${category}"]`)?.classList.add('ring-4', 'ring-white/30', 'scale-105');

      // Apply combined filters
      applyResourceFilters();
    }

    function filterResourcesByType(type) {
      // Apply combined filters
      applyResourceFilters();

      // Show toast to confirm filtering worked
      const visibleCount = document.querySelectorAll('.resource-item[style*="block"], .resource-item:not([style*="none"])').length;

      if (type === 'all') {
        showToast('📚 Showing all resource types', 'info');
      } else {
        showToast(`🎯 Filtered to ${visibleCount} ${type}${visibleCount !== 1 ? 's' : ''}`, 'success');
      }

      // Log for debugging
      console.log(`Filtered resources by type: ${type}, showing ${visibleCount} items`);
    }

    // Combined filter function for both category and type
    function applyResourceFilters() {
      const selectedCategory = document.querySelector('.resource-filter.ring-4')?.dataset.category || 'all';
      const selectedType = document.getElementById('resourceType').value;

      const resourceCards = document.querySelectorAll('.resource-item');
      let visibleCount = 0;

      resourceCards.forEach(card => {
        const matchesCategory = selectedCategory === 'all' || card.dataset.category === selectedCategory;
        const matchesType = selectedType === 'all' || card.dataset.type === selectedType;
        const shouldShow = matchesCategory && matchesType;

        card.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });

      console.log(`Applied filters - Category: ${selectedCategory}, Type: ${selectedType}, Visible: ${visibleCount}`);
    }

    function filterLabs(category) {
      const labCards = document.querySelectorAll('.lab-card');
      labCards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });

      document.querySelectorAll('.lab-filter').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-white/30', 'scale-105');
      });
      document.querySelector(`[data-category="${category}"]`)?.classList.add('ring-4', 'ring-white/30', 'scale-105');
    }

    // ====================================
    // GRADEBOOK FUNCTIONS
    // ====================================

    function exportGrades() {
      const csvContent = "Subject,Grade,Credits,Instructor,Progress\n" +
        grades.map(g => `${g.subject},${g.grade},${g.credits},${g.instructor},${g.progress}%`).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'grades_export.csv';
      a.click();
      window.URL.revokeObjectURL(url);

      addActivityFeed('📊 Exported grades to CSV');
      showToast('📊 Grades exported successfully!', 'success');
    }

    // ====================================
    // PROGRESS TRACKING
    // ====================================

    function initializeProgressChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Experiments', 'Assignments', 'Study Hours', 'AI Interactions'],
          datasets: [{
            data: [
              userProgress.experimentsCompleted || 1,
              userProgress.tasksCompleted || 1,
              userProgress.studyHours || 1,
              userProgress.aiInteractions || 1
            ],
            backgroundColor: [
              '#3b82f6',  // Blue
              '#10b981',  // Green
              '#f59e0b',  // Yellow
              '#8b5cf6'   // Purple
            ],
            borderWidth: 0,
            cutout: '60%'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }

    // ====================================
    // UTILITY FUNCTIONS
    // ====================================

    function getCategoryColor(category) {
      const colors = {
        'science': 'blue',
        'technology': 'purple',
        'engineering': 'gray',
        'arts': 'pink',
        'mathematics': 'green',
        'lecture': 'blue',
        'research': 'purple',
        'lab': 'green',
        'project': 'orange'
      };
      return colors[category] || 'blue';
    }

    function getDifficultyColor(difficulty) {
      const colors = {
        'Beginner': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400',
        'Intermediate': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400',
        'Advanced': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400',
        'Expert': 'bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400'
      };
      return colors[difficulty] || 'bg-gray-100 text-gray-800';
    }

    function getStatusColor(status) {
      const colors = {
        'pending': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
        'in-progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400',
        'completed': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400',
        'overdue': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'
      };
      return colors[status] || 'bg-gray-100 text-gray-800';
    }

    function getPriorityColor(priority) {
      const colors = {
        'high': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400',
        'medium': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400',
        'low': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
      };
      return colors[priority] || 'bg-gray-100 text-gray-800';
    }

    function getResourceIcon(type) {
      const icons = {
        'video': 'fas fa-play-circle',
        'article': 'fas fa-file-alt',
        'book': 'fas fa-book',
        'website': 'fas fa-globe'
      };
      return icons[type] || 'fas fa-file';
    }

    function getSubjectColor(subject) {
      const colors = {
        'Advanced Chemistry': 'blue',
        'Quantum Physics': 'purple',
        'Calculus III': 'green',
        'Computer Science': 'indigo',
        'Engineering Design': 'gray'
      };
      return colors[subject] || 'blue';
    }

    function getSubjectIcon(subject) {
      const icons = {
        'Advanced Chemistry': 'fas fa-vial',
        'Quantum Physics': 'fas fa-atom',
        'Calculus III': 'fas fa-calculator',
        'Computer Science': 'fas fa-laptop-code',
        'Engineering Design': 'fas fa-cogs'
      };
      return icons[subject] || 'fas fa-book';
    }

    function getGradeColor(grade) {
      if (grade.startsWith('A')) {
        return 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400';
      } else if (grade.startsWith('B')) {
        return 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400';
      } else if (grade.startsWith('C')) {
        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400';
      } else {
        return 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400';
      }
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.classList.contains('dark');

      if (isDark) {
        // Switch to light mode
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        addActivityFeed('☀️ Switched to light mode');
        showNotification('☀️ Light mode activated!', 'success');
      } else {
        // Switch to dark mode
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        addActivityFeed('🌙 Switched to dark mode');
        showNotification('🌙 Dark mode activated!', 'success');
      }

      // Update button icons
      updateThemeButton();
    }

    // Initialize theme on page load
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      updateThemeButton();
    }

    // Update theme button icons
    function updateThemeButton() {
      const isDark = document.documentElement.classList.contains('dark');
      const moonIcon = document.querySelector('.fas.fa-moon');
      const sunIcon = document.querySelector('.fas.fa-sun');

      if (moonIcon && sunIcon) {
        if (isDark) {
          moonIcon.classList.add('hidden');
          sunIcon.classList.remove('hidden');
        } else {
          moonIcon.classList.remove('hidden');
          sunIcon.classList.add('hidden');
        }
      }
    }

    function showCustomModal(title, content) {
      document.getElementById('customModalTitle').textContent = title;
      document.getElementById('customModalContent').innerHTML = content;
      document.getElementById('customModal').classList.remove('hidden');
    }

    function closeCustomModal() {
      document.getElementById('customModal').classList.add('hidden');
    }

    function showConfirmDialog(message, onConfirm) {
      showCustomModal('⚠️ Confirm Action', `
        <div class="space-y-4">
          <div class="bg-gradient-to-r from-yellow-50 to-red-50 dark:from-yellow-900/20 dark:to-red-900/20 p-6 rounded-2xl border border-yellow-200/50 dark:border-yellow-700/50">
            <p class="text-gray-700 dark:text-gray-300 text-lg">${message}</p>
          </div>
          <div class="flex space-x-3">
            <button onclick="closeCustomModal(); (${onConfirm})()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-check mr-2"></i>Confirm
            </button>
            <button onclick="closeCustomModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
              <i class="fas fa-times mr-2"></i>Cancel
            </button>
          </div>
        </div>
      `);
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const colors = {
        success: 'bg-gradient-to-r from-green-500 to-emerald-600 text-white',
        error: 'bg-gradient-to-r from-red-500 to-red-600 text-white',
        warning: 'bg-gradient-to-r from-yellow-500 to-orange-600 text-white',
        info: 'bg-gradient-to-r from-blue-500 to-purple-600 text-white'
      };

      const icons = {
        success: 'check',
        error: 'times',
        warning: 'exclamation',
        info: 'info'
      };

      toast.className = `${colors[type]} p-4 rounded-2xl shadow-2xl transform translate-x-full transition-all duration-300 max-w-sm z-50 backdrop-blur-sm`;
      toast.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-${icons[type]}-circle"></i>
          </div>
          <span class="text-sm font-bold">${message}</span>
        </div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);

      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 4000);
    }

    // Additional utility functions for calendar features
    function getEventIcon(eventType) {
      const icons = {
        'assignment': 'fas fa-tasks',
        'exam': 'fas fa-graduation-cap',
        'class': 'fas fa-chalkboard-teacher',
        'study': 'fas fa-book',
        'lab': 'fas fa-flask',
        'other': 'fas fa-calendar'
      };
      return icons[eventType] || 'fas fa-calendar';
    }

    function formatTime(timeString) {
      if (!timeString) return '';
      const [hours, minutes] = timeString.split(':');
      const hour24 = parseInt(hours);
      const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
      const ampm = hour24 >= 12 ? 'PM' : 'AM';
      return `${hour12}:${minutes} ${ampm}`;
    }

    function formatDateRelative(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = date - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays === -1) return 'Yesterday';
      if (diffDays > 1) return `In ${diffDays} days`;
      if (diffDays < -1) return `${Math.abs(diffDays)} days ago`;

      return formatDate(dateString);
    }

    // Advanced lab creation functions for complex simulations
    function createAdvancedEngineeringLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-gray-200/50 dark:border-gray-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-gray-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-bridge-water text-white text-sm"></i>
                </span>
                🏗️ Structural Engineering Simulator
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Structure Type:</label>
                  <select id="structureType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="updateStructure()">
                    <option value="bridge">Bridge</option>
                    <option value="building">Building</option>
                    <option value="tower">Tower</option>
                    <option value="truss">Truss</option>
                  </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-bold mb-2">Material:</label>
                    <select id="materialType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                      <option value="steel">Steel</option>
                      <option value="concrete">Concrete</option>
                      <option value="wood">Wood</option>
                      <option value="aluminum">Aluminum</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-bold mb-2">Safety Factor:</label>
                    <input type="range" id="safetyFactor" min="1.5" max="4" step="0.1" value="2.0" class="w-full" onchange="updateSafetyFactor()">
                    <span id="safetyDisplay" class="text-sm">2.0</span>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Applied Load (kN):</label>
                  <input type="range" id="appliedLoad" min="100" max="2000" step="50" value="500" class="w-full" onchange="updateLoad()">
                  <span id="loadDisplay" class="text-sm">500 kN</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="runStressAnalysis()" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-calculator mr-2"></i>Stress Analysis
                  </button>
                  <button onclick="testToFailure()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Test to Failure
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-chart-bar text-white text-sm"></i>
                </span>
                📊 Analysis Results
              </h4>
              <div id="engineeringResults" class="space-y-3 max-h-48 overflow-y-auto">
                <p class="text-gray-600 dark:text-gray-400 text-sm">Run stress analysis to see detailed results and safety margins.</p>
              </div>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 p-6 rounded-2xl border border-yellow-200/50 dark:border-yellow-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-shield-alt text-white text-sm"></i>
                </span>
                🛡️ Safety Assessment
              </h4>
              <div id="safetyResults" class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Configure your structure and loads to get comprehensive safety analysis.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedStatsLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-chart-bar text-white text-sm"></i>
                </span>
                📊 Advanced Statistics Lab
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Analysis Type:</label>
                  <select id="analysisType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                    <option value="descriptive">Descriptive Statistics</option>
                    <option value="hypothesis">Hypothesis Testing</option>
                    <option value="regression">Regression Analysis</option>
                    <option value="anova">ANOVA</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Confidence Level:</label>
                  <select id="confidenceLevel" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm">
                    <option value="0.90">90%</option>
                    <option value="0.95" selected>95%</option>
                    <option value="0.99">99%</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Sample Data:</label>
                  <textarea id="statsData" rows="4" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="Enter data points separated by commas"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="generateStatsData()" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-dice mr-2"></i>Generate Data
                  </button>
                  <button onclick="runStatsAnalysis()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-calculator mr-2"></i>Run Analysis
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div id="statsResults" class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-6 rounded-2xl border border-purple-200/50 dark:border-purple-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-chart-line text-white text-sm"></i>
                </span>
                📈 Statistical Results
              </h4>
              <div class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Enter your data and select analysis type to see comprehensive statistical results.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedArtLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 p-6 rounded-2xl border border-pink-200/50 dark:border-pink-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-pink-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-palette text-white text-sm"></i>
                </span>
                🎨 Digital Art Studio
              </h4>
              
              <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                  <button onclick="selectTool('brush')" class="art-tool bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg" data-tool="brush">
                    <i class="fas fa-paint-brush"></i><br><span class="text-xs">Brush</span>
                  </button>
                  <button onclick="selectTool('pencil')" class="art-tool bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg" data-tool="pencil">
                    <i class="fas fa-pencil-alt"></i><br><span class="text-xs">Pencil</span>
                  </button>
                  <button onclick="selectTool('eraser')" class="art-tool bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg" data-tool="eraser">
                    <i class="fas fa-eraser"></i><br><span class="text-xs">Eraser</span>
                  </button>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Brush Size:</label>
                  <input type="range" id="brushSize" min="1" max="50" value="5" class="w-full">
                  <span id="brushSizeDisplay" class="text-sm">5px</span>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Color Palette:</label>
                  <div class="grid grid-cols-6 gap-2">
                    <div class="w-8 h-8 bg-red-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#ef4444')"></div>
                    <div class="w-8 h-8 bg-blue-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#3b82f6')"></div>
                    <div class="w-8 h-8 bg-green-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#10b981')"></div>
                    <div class="w-8 h-8 bg-yellow-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#f59e0b')"></div>
                    <div class="w-8 h-8 bg-purple-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#8b5cf6')"></div>
                    <div class="w-8 h-8 bg-pink-500 rounded-lg cursor-pointer hover:scale-110 transform transition-all" onclick="selectColor('#ec4899')"></div>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="clearCanvas()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-trash mr-2"></i>Clear
                  </button>
                  <button onclick="saveArtwork()" class="bg-gradient-to-r from-success to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg">
              <h4 class="font-bold text-lg mb-4">🖼️ Digital Canvas</h4>
              <canvas id="artCanvas" width="400" height="300" class="border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white cursor-crosshair"></canvas>
            </div>
          </div>
        </div>
      `;
    }

    function createAdvancedMicroscopyLab(lab) {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 p-6 rounded-2xl border border-blue-200/50 dark:border-blue-700/50">
              <h4 class="font-bold text-xl mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-blue-500 to-green-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-microscope text-white text-sm"></i>
                </span>
                🔬 Virtual Microscopy Lab
              </h4>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold mb-2">Specimen:</label>
                  <select id="specimenType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" onchange="loadSpecimen()">
                    <option value="bacteria">Bacteria</option>
                    <option value="plant_cell">Plant Cell</option>
                    <option value="animal_cell">Animal Cell</option>
                    <option value="blood">Blood Cells</option>
                    <option value="tissue">Tissue Sample</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Magnification:</label>
                  <input type="range" id="magnification" min="100" max="1000" step="100" value="400" class="w-full" onchange="updateMagnification()">
                  <span id="magnificationDisplay" class="text-sm">400x</span>
                </div>
                
                <div>
                  <label class="block text-sm font-bold mb-2">Staining:</label>
                  <select id="stainingType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm" onchange="applyStaining()">
                    <option value="none">No Staining</option>
                    <option value="methylene_blue">Methylene Blue</option>
                    <option value="iodine">Iodine</option>
                    <option value="congo_red">Congo Red</option>
                  </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="focusMicroscope()" class="bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-search mr-2"></i>Focus
                  </button>
                  <button onclick="measureSpecimen()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold transition-all hover:scale-105 transform shadow-lg">
                    <i class="fas fa-ruler mr-2"></i>Measure
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div id="microscopyResults" class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-2xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="font-bold text-lg mb-4 flex items-center">
                <span class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                  <i class="fas fa-eye text-white text-sm"></i>
                </span>
                👁️ Observations
              </h4>
              <div class="text-sm space-y-2">
                <p class="text-gray-600 dark:text-gray-400">Select a specimen and adjust magnification to begin your microscopic exploration!</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function createGenericAdvancedLab(lab) {
      return `
        <div class="text-center py-12">
          <div class="text-6xl mb-4">${lab.icon.includes('fa-') ? '' : '🔬'}</div>
          <h3 class="text-2xl font-bold mb-4">${lab.title}</h3>
          <p class="text-gray-600 dark:text-gray-400 text-lg mb-8 max-w-2xl mx-auto">${lab.description}</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-8 rounded-3xl border border-blue-200/50 dark:border-blue-700/50">
              <h4 class="text-xl font-bold mb-4">🎯 Learning Objectives</h4>
              <ul class="space-y-2 text-left">
                ${lab.features.map(feature => `<li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>${feature}</li>`).join('')}
              </ul>
            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-8 rounded-3xl border border-green-200/50 dark:border-green-700/50">
              <h4 class="text-xl font-bold mb-4">📚 Lab Information</h4>
              <div class="space-y-3 text-left">
                <div class="flex justify-between">
                  <span class="font-medium">Subject:</span>
                  <span>${lab.subject}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Duration:</span>
                  <span>${lab.duration}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-medium">Difficulty:</span>
                  <span class="px-2 py-1 rounded-full text-xs ${getDifficultyColor(lab.difficulty)}">${lab.difficulty}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8">
            <button onclick="startInteractiveTutorial()" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all hover:scale-105 transform shadow-xl">
              <i class="fas fa-play mr-3"></i>Start Interactive Tutorial
            </button>
          </div>
        </div>
      `;
    }

    function startInteractiveTutorial() {
      showToast('🚀 Interactive tutorial started! Follow the guided steps.', 'info');
      addActivityFeed('🎓 Started interactive lab tutorial');

      setTimeout(() => {
        completeLab('Interactive Tutorial');
      }, 3000);
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>

  <script>
    function refreshDashboard() {
      // Assignments
      const assignments = JSON.parse(localStorage.getItem("steam_assignments") || "[]");
      const aSec = document.getElementById("assignmentsSection");
      if (aSec) {
        aSec.innerHTML = "";
        assignments.forEach(a => {
          const div = document.createElement("div");
          div.className = "border p-2 mb-2 bg-white";
          div.innerHTML = `<strong>${a.title}</strong><br>
        ${a.description || ""}<br>
        ${a.file ? `<a href='${a.file}' target='_blank'>Download</a>` : ""}`;
          aSec.appendChild(div);
        });
      }

      // Grades
      const grades = JSON.parse(localStorage.getItem("steam_grades") || "[]");
      const gSec = document.getElementById("gradesSection");
      if (gSec) {
        gSec.innerHTML = "<table class='table-auto border'><tr><th>Student</th><th>Subject</th><th>Grade</th></tr></table>";
        const tbl = gSec.querySelector("table");
        grades.forEach(g => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${g.student}</td><td>${g.subject}</td><td>${g.grade}</td>`;
          tbl.appendChild(tr);
        });
      }

      // Resources
      const resources = JSON.parse(localStorage.getItem("steam_resources") || "[]");
      const rSec = document.getElementById("resourcesSection");
      if (rSec) {
        rSec.innerHTML = "";
        resources.forEach(r => {
          const div = document.createElement("div");
          div.className = "border p-2 mb-2 bg-white";
          div.innerHTML = `<strong>${r.title}</strong> - <a href='${r.link}' target='_blank'>${r.link}</a><br>${r.description}`;
          rSec.appendChild(div);
        });
      }

      // Stats
      const stats = JSON.parse(localStorage.getItem("steam_stats") || "{}");
      const sSec = document.getElementById("statsSection");
      if (sSec) {
        sSec.innerHTML = `GPA: ${stats.overallGPA || "-"}<br>Credits: ${stats.totalCredits || "-"}`;
      }
    }

    // Listener for teacher pushes
    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === "teacherUpdate") {
        const { assignments, grades, resources, stats } = event.data.payload;
        if (assignments) localStorage.setItem("steam_assignments", JSON.stringify(assignments));
        if (grades) localStorage.setItem("steam_grades", JSON.stringify(grades));
        if (resources) localStorage.setItem("steam_resources", JSON.stringify(resources));
        if (stats) localStorage.setItem("steam_stats", JSON.stringify(stats));
        refreshDashboard();
      }
    });

    window.onload = refreshDashboard;
  </script>

  <!-- Enhanced JavaScript Functionality -->
  <script>
    // Mobile menu functionality
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuPanel = document.getElementById('mobileMenuPanel');

      if (mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.remove('hidden');
        setTimeout(() => {
          mobileMenuPanel.classList.remove('translate-x-full');
        }, 10);
      } else {
        mobileMenuPanel.classList.add('translate-x-full');
        setTimeout(() => {
          mobileMenu.classList.add('hidden');
        }, 300);
      }
    }

    // Fast Loading screen
    window.addEventListener('load', function () {
      fastLoadingSequence();
    });

    function fastLoadingSequence() {
      const progressBar = document.getElementById('loadingProgress');
      const percentage = document.getElementById('loadingPercentage');
      const loadingStep = document.getElementById('loadingStep');

      if (!progressBar || !percentage || !loadingStep) return;

      // Quick progress animation
      let progress = 0;
      const interval = setInterval(() => {
        progress += 25;
        progressBar.style.width = progress + '%';
        percentage.textContent = progress + '%';

        if (progress >= 100) {
          clearInterval(interval);
          loadingStep.textContent = 'Ready!';

          // Quick fade out
          setTimeout(() => {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
              loadingScreen.style.opacity = '0';
              loadingScreen.style.transition = 'opacity 0.3s ease-out';
              setTimeout(() => {
                loadingScreen.style.display = 'none';
              }, 300);
            }
          }, 200);
        }
      }, 100); // Much faster intervals
    }

    // Enhanced section switching with animations
    function showSection(sectionId) {
      // Hide all sections with fade out
      document.querySelectorAll('.section-content').forEach(section => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(10px)';
        setTimeout(() => {
          section.classList.add('hidden');
        }, 200);
      });

      // Update navigation buttons
      document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('text-gray-600', 'dark:text-gray-400');
        if (btn.classList.contains('mobile-nav-btn')) {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-white/50', 'dark:bg-gray-700/50', 'text-gray-700', 'dark:text-gray-300');
        }
      });

      // Activate current section button
      document.querySelectorAll(`[data-section="${sectionId}"]`).forEach(btn => {
        btn.classList.add('bg-primary', 'text-white');
        btn.classList.remove('text-gray-600', 'dark:text-gray-400');
        if (btn.classList.contains('mobile-nav-btn')) {
          btn.classList.remove('bg-white/50', 'dark:bg-gray-700/50', 'text-gray-700', 'dark:text-gray-300');
        }
      });

      // Show target section with fade in
      setTimeout(() => {
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.remove('hidden');
          setTimeout(() => {
            targetSection.style.opacity = '1';
            targetSection.style.transform = 'translateY(0)';
            targetSection.style.transition = 'all 0.3s ease-out';
          }, 10);

          // Section-specific initialization
          switch (sectionId) {
            case 'calendar':
              if (typeof generateCalendar === 'function') generateCalendar();
              break;
            case 'assignments':
              if (typeof updateAssignmentCounts === 'function') updateAssignmentCounts();
              break;
            case 'gradebook':
              if (typeof populateGradesTable === 'function') populateGradesTable();
              break;
            case 'data':
              if (typeof initializeDataCharts === 'function') initializeDataCharts();
              break;
            case 'labs':
              if (typeof populateLabs === 'function') populateLabs();
              break;
            case 'notes':
              if (typeof initializeNotebookLM === 'function') initializeNotebookLM();
              break;
            case 'resources':
              if (typeof populateResources === 'function') populateResources();
              break;
          }

          // Add activity
          if (typeof addActivityFeed === 'function') {
            addActivityFeed(`📖 Viewed ${sectionId} section`);
          }
        }
      }, 200);
    }

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg backdrop-blur-sm transform translate-x-full transition-all duration-300 ${type === 'success' ? 'bg-green-500/90 text-white' :
        type === 'error' ? 'bg-red-500/90 text-white' :
          type === 'warning' ? 'bg-yellow-500/90 text-white' :
            'bg-blue-500/90 text-white'
        }`;

      notification.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fas ${type === 'success' ? 'fa-check-circle' :
          type === 'error' ? 'fa-exclamation-circle' :
            type === 'warning' ? 'fa-exclamation-triangle' :
              'fa-info-circle'
        }"></i>
          <span>${message}</span>
        </div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);

      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Enhanced save progress with feedback
    function saveProgress() {
      const saveBtn = document.querySelector('[onclick="saveProgress()"]');
      const originalText = saveBtn.innerHTML;

      saveBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Saving...';
      saveBtn.disabled = true;

      // Simulate save operation
      setTimeout(() => {
        saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Saved!';
        showNotification('Progress saved successfully!', 'success');

        setTimeout(() => {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        }, 1500);
      }, 1000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case '1':
            e.preventDefault();
            showSection('dashboard');
            break;
          case '2':
            e.preventDefault();
            showSection('labs');
            break;
          case '3':
            e.preventDefault();
            showSection('assignments');
            break;
          case 's':
            e.preventDefault();
            saveProgress();
            break;
          case 't':
          case 'T':
            e.preventDefault();
            toggleTheme();
            break;
        }
      }

      if (e.key === 'Escape') {
        const mobileMenu = document.getElementById('mobileMenu');
        if (!mobileMenu.classList.contains('hidden')) {
          toggleMobileMenu();
        }
      }
    });

    // Initialize tooltips for keyboard shortcuts
    function initializeTooltips() {
      const shortcuts = [
        { selector: '[data-section="dashboard"]', text: 'Ctrl+1' },
        { selector: '[data-section="labs"]', text: 'Ctrl+2' },
        { selector: '[data-section="assignments"]', text: 'Ctrl+3' },
        { selector: '[onclick="saveProgress()"]', text: 'Ctrl+S' },
        { selector: '#themeToggle', text: 'Ctrl+T' }
      ];

      shortcuts.forEach(shortcut => {
        const elements = document.querySelectorAll(shortcut.selector);
        elements.forEach(el => {
          el.title = `${el.textContent.trim()} (${shortcut.text})`;
        });
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize theme first (before other UI elements)
      initializeTheme();

      initializeTooltips();

      // Load activity feed from storage
      loadActivityFeed();

      // Initialize NotebookLM
      if (typeof initializeNotebookLM === 'function') {
        initializeNotebookLM();
      }

      // Add event listeners for NotebookLM
      const noteContent = document.getElementById('noteContent');
      if (noteContent) {
        noteContent.addEventListener('input', updateWordCount);
      }

      // Initialize with dashboard section
      setTimeout(() => {
        showSection('dashboard');
      }, 100);

      // Welcome notification and activity
      setTimeout(() => {
        showNotification('Welcome to STEAM Lab Pro! 🚀', 'success');
        addActivityFeed('🚀 Logged into STEAM Lab Pro');
      }, 2000);

      // Add some sample activities if none exist
      setTimeout(() => {
        const activities = JSON.parse(localStorage.getItem('steam_activities') || '[]');
        if (activities.length === 0) {
          addSampleActivities();
        }
      }, 3000);
    });

    // Add sample activities for new users
    function addSampleActivities() {
      const sampleActivities = [
        '🎓 Welcome to STEAM Lab Pro!',
        '📚 Explore the Resources section for learning materials',
        '🧪 Try the PhET simulations in Experiments',
        '🧮 Use the Calculator for math problems',
        '📝 Create notes to track your learning'
      ];

      sampleActivities.forEach((activity, index) => {
        setTimeout(() => {
          addActivityFeed(activity);
        }, index * 500);
      });
    }

    // Performance monitoring
    function logPerformance() {
      if ('performance' in window) {
        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
        console.log(`Page loaded in ${loadTime}ms`);
      }
    }

    window.addEventListener('load', logPerformance);
  </script>

</body>

</html>
